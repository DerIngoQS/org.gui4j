<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Gui4jLabelForm.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">gui4j</a> &gt; <a href="index.source.html" class="el_package">org.gui4j.component</a> &gt; <span class="el_source">Gui4jLabelForm.java</span></div><h1>Gui4jLabelForm.java</h1><pre class="source lang-java linenums">package org.gui4j.component;

import java.util.ArrayList;
import java.util.Collections;
import java.util.Iterator;
import java.util.List;
import java.util.StringTokenizer;
import javax.swing.JComponent;
import javax.swing.JLabel;
import javax.swing.JPanel;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.gui4j.Gui4jCallBase;
import org.gui4j.core.Gui4jCall;
import org.gui4j.core.Gui4jComponentContainer;
import org.gui4j.core.Gui4jComponentInstance;
import org.gui4j.core.Gui4jQualifiedComponent;
import org.gui4j.core.Gui4jSwingContainer;
import org.gui4j.core.swing.TableLayout;
import org.gui4j.core.swing.TableLayoutConstants;
import org.gui4j.core.swing.TableLayoutConstraints;

public class Gui4jLabelForm extends Gui4jJComponent {
<span class="nc" id="L24">  protected static final Log log = LogFactory.getLog(Gui4jLabelForm.class);</span>

  private static final int PREFERRED = (int) TableLayoutConstants.PREFERRED;
  private static final int FILL = (int) TableLayoutConstants.FILL;

  protected final List columns; // defined labelColumns

  private Gui4jCall hspCall;
  private Gui4jCall vspCall;

  protected int numColumns; // number of auto columns requested
  private int colSpacing;

  private int[] componentWidths;

  public Gui4jLabelForm(Gui4jComponentContainer gui4jComponentContainer, String id) {
<span class="nc" id="L40">    super(gui4jComponentContainer, JPanel.class, id);</span>

<span class="nc" id="L42">    columns = new ArrayList();</span>
<span class="nc" id="L43">  }</span>

  public void addColumn(Column column) {
<span class="nc" id="L46">    columns.add(column);</span>
<span class="nc" id="L47">  }</span>

  public void setHspCall(Gui4jCall hspCall) {
<span class="nc" id="L50">    this.hspCall = hspCall;</span>
<span class="nc" id="L51">  }</span>

  public void setVspCall(Gui4jCall vspCall) {
<span class="nc" id="L54">    this.vspCall = vspCall;</span>
<span class="nc" id="L55">  }</span>

  public void setNumColumns(int columns) {
<span class="nc" id="L58">    this.numColumns = columns;</span>
<span class="nc" id="L59">  }</span>

  public void setColSpacing(int colSpacing) {
<span class="nc" id="L62">    this.colSpacing = colSpacing;</span>
<span class="nc" id="L63">  }</span>

  public void setComponentWidths(String widths) {
<span class="nc bnc" id="L66" title="All 2 branches missed.">    if (widths == null) {</span>
<span class="nc" id="L67">      componentWidths = null;</span>
<span class="nc" id="L68">      return;</span>
    }
<span class="nc" id="L70">    StringTokenizer tokenizer = new StringTokenizer(widths, &quot;,&quot;);</span>
<span class="nc" id="L71">    componentWidths = new int[tokenizer.countTokens()];</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">    for (int col = 0; col &lt; componentWidths.length; col++) {</span>
<span class="nc" id="L73">      componentWidths[col] = parseComponentWidth(tokenizer.nextToken());</span>
    }
<span class="nc" id="L75">  }</span>

  static int parseComponentWidth(String width) {
<span class="nc" id="L78">    width = width.trim();</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">    if (width.toUpperCase().equals(&quot;P&quot;)) {</span>
<span class="nc" id="L80">      return PREFERRED;</span>
    }
<span class="nc bnc" id="L82" title="All 2 branches missed.">    if (width.toUpperCase().equals(&quot;F&quot;)) {</span>
<span class="nc" id="L83">      return FILL;</span>
    }

    try {
<span class="nc" id="L87">      int parsed = Integer.parseInt(width);</span>
<span class="nc" id="L88">      return parsed;</span>
<span class="nc" id="L89">    } catch (NumberFormatException e) {</span>
<span class="nc" id="L90">      log.warn(&quot;Invalid column width parameter: &quot; + width);</span>
<span class="nc" id="L91">      return FILL;</span>
    }
  }

  protected Gui4jComponentInstance createComponentInstance(
      Gui4jSwingContainer gui4jSwingContainer,
      Gui4jCallBase gui4jCallBase,
      Gui4jQualifiedComponent gui4jComponentInPath) {

<span class="nc" id="L100">    log.debug(&quot;Preparing labelForm: &quot; + gui4jComponentInPath.getQualifiedId());</span>

    // retrieve hspacing and vspacing values
<span class="nc" id="L103">    int hSpacing = getHSpacing(gui4jCallBase);</span>
<span class="nc" id="L104">    int vSpacing = getVSpacing(gui4jCallBase);</span>

    // calculate allocation of labels and components to logical layout cells
<span class="nc" id="L107">    CellAllocation allocation = new CellAllocation();</span>

    // define TableLayout column sizes
<span class="nc" id="L110">    int tableColsPerColumn = 5; // colgap, marker, label, hspacing, component</span>
<span class="nc" id="L111">    int tableCols =</span>
<span class="nc" id="L112">        allocation.getCols() * tableColsPerColumn - 1; // first column doesn't have colgap</span>
<span class="nc" id="L113">    double colSizes[] = new double[tableCols];</span>
<span class="nc" id="L114">    int layoutCol = 0;</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">    for (int col = 0; col &lt; allocation.getCols(); col++) {</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">      if (col &gt;= 1) {</span>
        // only 2nd and higher label/component numColumns have colgap
<span class="nc" id="L118">        colSizes[layoutCol++] = colSpacing;</span>
      }
<span class="nc" id="L120">      colSizes[layoutCol++] = TableLayoutConstants.PREFERRED; // marker column</span>
<span class="nc" id="L121">      colSizes[layoutCol++] = TableLayoutConstants.PREFERRED; // label column</span>
<span class="nc" id="L122">      colSizes[layoutCol++] = hSpacing;</span>
<span class="nc" id="L123">      colSizes[layoutCol++] = getComponentWidth(col); // component column</span>
    }

    // define TableLayout row sizes
<span class="nc" id="L127">    int tableRowsPerRow = 2; // content row and vspacing row</span>
<span class="nc" id="L128">    int tableRows = allocation.getRows() * tableRowsPerRow - 1; // first row doesnt't have leading</span>
    // vspacing
<span class="nc" id="L130">    double rowSizes[] = new double[tableRows];</span>
<span class="nc" id="L131">    int layoutRow = 0;</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">    for (int i = 0; i &lt; allocation.getRows(); i++) {</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">      if (i &gt;= 1) {</span>
        // 2nd and higher rows have leading vspacing row
<span class="nc" id="L135">        rowSizes[layoutRow++] = vSpacing;</span>
      }
<span class="nc" id="L137">      rowSizes[layoutRow++] = TableLayoutConstants.PREFERRED;</span>
    }

    // create TableLayout
<span class="nc" id="L141">    double[][] layoutSizes = {colSizes, rowSizes};</span>
<span class="nc" id="L142">    TableLayout tableLayout = new TableLayout(layoutSizes);</span>
<span class="nc" id="L143">    JPanel panel = new JPanel(tableLayout);</span>
<span class="nc" id="L144">    log.debug(</span>
        &quot;Defined tableLayout with &quot; + colSizes.length + &quot; cols and &quot; + rowSizes.length + &quot; rows.&quot;);

    // prepare constraints
<span class="nc" id="L148">    TableLayoutConstraints markerConstraints = new TableLayoutConstraints();</span>
<span class="nc" id="L149">    markerConstraints.hAlign = TableLayoutConstants.FULL;</span>
<span class="nc" id="L150">    markerConstraints.vAlign = TableLayoutConstants.TOP;</span>
<span class="nc" id="L151">    TableLayoutConstraints labelConstraints = new TableLayoutConstraints();</span>
<span class="nc" id="L152">    labelConstraints.hAlign = TableLayoutConstants.FULL;</span>
<span class="nc" id="L153">    labelConstraints.vAlign = TableLayoutConstants.FULL;</span>
<span class="nc" id="L154">    TableLayoutConstraints componentConstraints = new TableLayoutConstraints();</span>
<span class="nc" id="L155">    componentConstraints.hAlign = TableLayoutConstants.FULL;</span>
<span class="nc" id="L156">    componentConstraints.vAlign = TableLayoutConstants.TOP;</span>

    // loop through all logical cells and define layout cells
<span class="nc bnc" id="L159" title="All 2 branches missed.">    for (int col = 0; col &lt; allocation.getCols(); col++) {</span>
<span class="nc" id="L160">      layoutRow = 0;</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">      for (int row = 0; row &lt; allocation.getRows(); row++) {</span>
        // reset table column
<span class="nc" id="L163">        layoutCol = col * tableColsPerColumn;</span>

<span class="nc" id="L165">        Cell cell = allocation.getCell(col, row);</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">        if (cell != null) {</span>

          // insert marker into table layout
<span class="nc" id="L169">          Gui4jQualifiedComponent markerPath = cell.getMarker();</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">          if (markerPath != null) {</span>
<span class="nc" id="L171">            Gui4jComponentInstance markerInstance =</span>
<span class="nc" id="L172">                gui4jSwingContainer.getGui4jComponentInstance(</span>
<span class="nc" id="L173">                    gui4jComponentInPath.getGui4jComponentPath(), markerPath);</span>
<span class="nc" id="L174">            JComponent marker = markerInstance.getSwingComponent();</span>
<span class="nc" id="L175">            setConstraintCell(markerConstraints, layoutCol, layoutRow);</span>
<span class="nc" id="L176">            panel.add(marker, markerConstraints);</span>
<span class="nc" id="L177">            log.debug(&quot;Filling layout [&quot; + layoutCol + &quot;][&quot; + layoutRow + &quot;] with marker.&quot;);</span>
          }
<span class="nc" id="L179">          layoutCol++;</span>

          // insert label into table layout
<span class="nc" id="L182">          Gui4jQualifiedComponent labelPath = cell.getLabel();</span>
<span class="nc" id="L183">          JComponent label = null;</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">          if (labelPath != null) {</span>
<span class="nc" id="L185">            Gui4jComponentInstance labelInstance =</span>
<span class="nc" id="L186">                gui4jSwingContainer.getGui4jComponentInstance(</span>
<span class="nc" id="L187">                    gui4jComponentInPath.getGui4jComponentPath(), labelPath);</span>
<span class="nc" id="L188">            label = labelInstance.getSwingComponent();</span>
<span class="nc" id="L189">            setConstraintCell(labelConstraints, layoutCol, layoutRow);</span>
<span class="nc" id="L190">            panel.add(label, labelConstraints);</span>
<span class="nc" id="L191">            log.debug(&quot;Filling layout [&quot; + layoutCol + &quot;][&quot; + layoutRow + &quot;] with label.&quot;);</span>
          }
<span class="nc" id="L193">          layoutCol += 2; // skip hSpacing column</span>

          // insert component into table layout
<span class="nc" id="L196">          Gui4jQualifiedComponent componentPath = cell.getComponent();</span>
<span class="nc" id="L197">          JComponent component = null;</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">          if (componentPath != null) {</span>
<span class="nc" id="L199">            Gui4jComponentInstance componentInstance =</span>
<span class="nc" id="L200">                gui4jSwingContainer.getGui4jComponentInstance(</span>
<span class="nc" id="L201">                    gui4jComponentInPath.getGui4jComponentPath(), componentPath);</span>
<span class="nc" id="L202">            component = componentInstance.getSwingComponent();</span>
<span class="nc" id="L203">            int spanCol = (cell.getSpanTo() * tableColsPerColumn) + 3;</span>
<span class="nc" id="L204">            setConstraintCell(componentConstraints, layoutCol, layoutRow, spanCol);</span>
<span class="nc" id="L205">            panel.add(component, componentConstraints);</span>
<span class="nc" id="L206">            log.debug(&quot;Filling layout [&quot; + layoutCol + &quot;][&quot; + layoutRow + &quot;] with component.&quot;);</span>
          }
<span class="nc" id="L208">          layoutCol++;</span>

          // associate label and component
<span class="nc bnc" id="L211" title="All 6 branches missed.">          if (label != null &amp;&amp; component != null &amp;&amp; label instanceof JLabel) {</span>
<span class="nc" id="L212">            ((JLabel) label).setLabelFor(component);</span>
          }

<span class="nc" id="L215">          layoutRow += 2; // skip vspacing row</span>
        }
      }
    }

<span class="nc" id="L220">    Gui4jComponentInstance gui4jComponentInstance =</span>
        new Gui4jComponentInstance(gui4jSwingContainer, panel, gui4jComponentInPath);

<span class="nc" id="L223">    return gui4jComponentInstance;</span>
  }

  private int getVSpacing(Gui4jCallBase gui4jCallBase) {
<span class="nc" id="L227">    int vSpacing = 0;</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">    if (vspCall != null) {</span>
<span class="nc" id="L229">      Integer vspCallResult =</span>
<span class="nc" id="L230">          (Integer) vspCall.getValue(gui4jCallBase, Collections.EMPTY_MAP, Integer.valueOf(0));</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">      if (vspCallResult != null) {</span>
<span class="nc" id="L232">        vSpacing = vspCallResult.intValue();</span>
      }
    }
<span class="nc" id="L235">    return vSpacing;</span>
  }

  private int getHSpacing(Gui4jCallBase gui4jCallBase) {
<span class="nc" id="L239">    int hSpacing = 0;</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">    if (hspCall != null) {</span>
<span class="nc" id="L241">      Integer hspCallResult =</span>
<span class="nc" id="L242">          (Integer) hspCall.getValue(gui4jCallBase, Collections.EMPTY_MAP, Integer.valueOf(0));</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">      if (hspCallResult != null) {</span>
<span class="nc" id="L244">        hSpacing = hspCallResult.intValue();</span>
      }
    }
<span class="nc" id="L247">    return hSpacing;</span>
  }

  private double getColSize(int i) {
<span class="nc bnc" id="L251" title="All 2 branches missed.">    if (i == PREFERRED) {</span>
<span class="nc" id="L252">      return TableLayoutConstants.PREFERRED;</span>
    }
<span class="nc bnc" id="L254" title="All 2 branches missed.">    if (i == FILL) {</span>
<span class="nc" id="L255">      return TableLayoutConstants.FILL;</span>
    }
<span class="nc" id="L257">    return i;</span>
  }

  private double getComponentWidth(int col) {
<span class="nc bnc" id="L261" title="All 2 branches missed.">    if (col &lt; columns.size()) {</span>
<span class="nc" id="L262">      Column column = (Column) columns.get(col);</span>
<span class="nc bnc" id="L263" title="All 4 branches missed.">      if (column != null &amp;&amp; column.getComponentWidth() != null) {</span>
<span class="nc" id="L264">        return getColSize(parseComponentWidth(column.getComponentWidth()));</span>
      }
    }
<span class="nc bnc" id="L267" title="All 4 branches missed.">    if (componentWidths != null &amp;&amp; componentWidths.length &gt; col) {</span>
<span class="nc" id="L268">      return getColSize(componentWidths[col]);</span>
    } else {
<span class="nc" id="L270">      return TableLayoutConstants.FILL;</span>
    }
  }

  private void setConstraintCell(TableLayoutConstraints constraints, int col, int row) {
    // log.debug(&quot;Setting constraints to col: &quot; + col + &quot;, row: &quot; + row);
<span class="nc" id="L276">    constraints.col1 = col;</span>
<span class="nc" id="L277">    constraints.col2 = col;</span>
<span class="nc" id="L278">    constraints.row1 = row;</span>
<span class="nc" id="L279">    constraints.row2 = row;</span>
<span class="nc" id="L280">  }</span>

  private void setConstraintCell(TableLayoutConstraints constraints, int col, int row, int spanTo) {
    // log.debug(&quot;Setting constraints to col: &quot; + col + &quot;, row: &quot; + row);
<span class="nc" id="L284">    constraints.col1 = col;</span>
<span class="nc" id="L285">    constraints.col2 = spanTo;</span>
<span class="nc" id="L286">    constraints.row1 = row;</span>
<span class="nc" id="L287">    constraints.row2 = row;</span>
<span class="nc" id="L288">  }</span>

  // *************************************************************************

  public static class Column {
    public static final int SPAN_ALL = 0;

    private final List labels;
    private final List components;
    private final List markers;

    private String componentWidth;
    private int[] colSpans;

    public Column() {
<span class="nc" id="L303">      super();</span>
<span class="nc" id="L304">      labels = new ArrayList();</span>
<span class="nc" id="L305">      components = new ArrayList();</span>
<span class="nc" id="L306">      markers = new ArrayList();</span>
<span class="nc" id="L307">    }</span>

    public int size() {
<span class="nc" id="L310">      return Math.max(labels.size(), components.size());</span>
    }

    public String getComponentWidth() {
<span class="nc" id="L314">      return componentWidth;</span>
    }

    public void setComponentWidth(String componentWidth) {
<span class="nc" id="L318">      this.componentWidth = componentWidth;</span>
<span class="nc" id="L319">    }</span>

    public Gui4jQualifiedComponent getMarker(int index) {
<span class="nc" id="L322">      return getElement(markers, index);</span>
    }

    public Gui4jQualifiedComponent getLabel(int index) {
<span class="nc" id="L326">      return getElement(labels, index);</span>
    }

    public Gui4jQualifiedComponent getComponent(int index) {
<span class="nc" id="L330">      return getElement(components, index);</span>
    }

    private static Gui4jQualifiedComponent getElement(List list, int index) {
<span class="nc bnc" id="L334" title="All 2 branches missed.">      if (index &lt; list.size()) {</span>
<span class="nc" id="L335">        return (Gui4jQualifiedComponent) list.get(index);</span>
      } else {
<span class="nc" id="L337">        return null;</span>
      }
    }

    public void addLabel(Gui4jQualifiedComponent label) {
<span class="nc" id="L342">      labels.add(label);</span>
<span class="nc" id="L343">    }</span>

    public void addComponent(Gui4jQualifiedComponent component) {
<span class="nc" id="L346">      components.add(component);</span>
<span class="nc" id="L347">    }</span>

    public void addMarker(Gui4jQualifiedComponent marker) {
<span class="nc" id="L350">      markers.add(marker);</span>
<span class="nc" id="L351">    }</span>

    public List getComponents() {
<span class="nc" id="L354">      return components;</span>
    }

    public List getLabels() {
<span class="nc" id="L358">      return labels;</span>
    }

    public List getMarkers() {
<span class="nc" id="L362">      return markers;</span>
    }

    public void setColSpans(String spans) {
<span class="nc bnc" id="L366" title="All 2 branches missed.">      if (spans == null) {</span>
<span class="nc" id="L367">        this.colSpans = null;</span>
<span class="nc" id="L368">        return;</span>
      }
<span class="nc" id="L370">      StringTokenizer tokenizer = new StringTokenizer(spans, &quot;,&quot;);</span>
<span class="nc" id="L371">      this.colSpans = new int[tokenizer.countTokens()];</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">      for (int index = 0; index &lt; this.colSpans.length; index++) {</span>
<span class="nc" id="L373">        this.colSpans[index] = parseColSpan(tokenizer.nextToken());</span>
      }
<span class="nc" id="L375">    }</span>

    private static int parseColSpan(String span) {
<span class="nc bnc" id="L378" title="All 2 branches missed.">      if (&quot;all&quot;.equals(span.toLowerCase())) {</span>
<span class="nc" id="L379">        return SPAN_ALL;</span>
      }

      try {
<span class="nc" id="L383">        return Integer.parseInt(span);</span>
<span class="nc" id="L384">      } catch (NumberFormatException e) {</span>
<span class="nc" id="L385">        log.warn(&quot;Invalid colSpan parameter: &quot; + span);</span>
<span class="nc" id="L386">        return 1;</span>
      }
    }

    /**
     * Returns the requested colSpan for the element in this column with the given index. Default is
     * 1, if no colSpan has been explicitly set.
     *
     * @param index
     * @return int
     */
    public int getColSpan(int index) {
<span class="nc bnc" id="L398" title="All 4 branches missed.">      if (colSpans == null || index &gt;= colSpans.length) {</span>
<span class="nc" id="L399">        return 1;</span>
      }
<span class="nc" id="L401">      return colSpans[index];</span>
    }
  }

  private static class Cell {
<span class="nc" id="L406">    public static final Cell SPANNED = new Cell(null, null, null);</span>

    private final Gui4jQualifiedComponent marker;
    private final Gui4jQualifiedComponent label;
    private final Gui4jQualifiedComponent component;

    private int spanTo; // column this cell spans to

    public Cell(
        final Gui4jQualifiedComponent marker,
        final Gui4jQualifiedComponent label,
        final Gui4jQualifiedComponent component) {
<span class="nc" id="L418">      super();</span>
<span class="nc" id="L419">      this.marker = marker;</span>
<span class="nc" id="L420">      this.label = label;</span>
<span class="nc" id="L421">      this.component = component;</span>
<span class="nc" id="L422">    }</span>

    public int getSpanTo() {
<span class="nc" id="L425">      return spanTo;</span>
    }

    public void setSpanTo(int spanTo) {
<span class="nc" id="L429">      this.spanTo = spanTo;</span>
<span class="nc" id="L430">    }</span>

    public Gui4jQualifiedComponent getComponent() {
<span class="nc" id="L433">      return component;</span>
    }

    public Gui4jQualifiedComponent getLabel() {
<span class="nc" id="L437">      return label;</span>
    }

    public Gui4jQualifiedComponent getMarker() {
<span class="nc" id="L441">      return marker;</span>
    }
  }

<span class="nc" id="L445">  private class CellAllocation {</span>
    private Cell[][] allocation;
    private int rows;
    private int cols;

<span class="nc" id="L450">    public CellAllocation() {</span>
<span class="nc" id="L451">      allocateCells();</span>
<span class="nc" id="L452">      log.debug(&quot;Allocated &quot; + cols + &quot; columns and &quot; + rows + &quot; rows.&quot;);</span>
<span class="nc" id="L453">    }</span>

    private void allocateCells() {
<span class="nc" id="L456">      cols = columns.size();</span>

      // handle auto columns feature (automatic creation of several coumns)
<span class="nc bnc" id="L459" title="All 4 branches missed.">      boolean autoColumns = (cols == 1 &amp;&amp; numColumns &gt; 1);</span>
<span class="nc" id="L460">      int autoRows = 0;</span>
<span class="nc bnc" id="L461" title="All 2 branches missed.">      if (autoColumns) {</span>
<span class="nc" id="L462">        int maxIndex = ((Column) columns.get(0)).size();</span>
<span class="nc" id="L463">        autoRows = maxIndex / numColumns;</span>
<span class="nc bnc" id="L464" title="All 2 branches missed.">        if (maxIndex % numColumns &gt; 0) {</span>
<span class="nc" id="L465">          autoRows++;</span>
        }
<span class="nc" id="L467">        cols = numColumns;</span>
      }

      // create allocation array (maximum possible size)
<span class="nc bnc" id="L471" title="All 2 branches missed.">      if (autoColumns) {</span>
<span class="nc" id="L472">        allocation = new Cell[cols][autoRows];</span>
      } else {
<span class="nc" id="L474">        int maxRows = 0;</span>
<span class="nc bnc" id="L475" title="All 2 branches missed.">        for (Iterator iter = columns.iterator(); iter.hasNext(); ) {</span>
<span class="nc" id="L476">          Column column = (Column) iter.next();</span>
<span class="nc" id="L477">          maxRows += column.size();</span>
<span class="nc" id="L478">        }</span>
<span class="nc" id="L479">        allocation = new Cell[cols][maxRows];</span>
      }

      // create allocation of cells
<span class="nc" id="L483">      int col = 0;</span>
<span class="nc" id="L484">      rows = 0; // number of allocated rows</span>
<span class="nc bnc" id="L485" title="All 2 branches missed.">      for (Iterator iter = columns.iterator(); iter.hasNext(); ) {</span>
<span class="nc" id="L486">        Column column = (Column) iter.next();</span>

<span class="nc" id="L488">        int row = 0;</span>
<span class="nc bnc" id="L489" title="All 2 branches missed.">        for (int index = 0; index &lt; column.size(); index++) {</span>
          // (note: simultaneous use of autocolumns and colSpans is not supported)

          // skip cells occupied by other cells that span several columns
<span class="nc bnc" id="L493" title="All 2 branches missed.">          while (allocation[col][row] == Cell.SPANNED) {</span>
<span class="nc" id="L494">            row++;</span>
          }

          // allocate cell
<span class="nc" id="L498">          log.debug(&quot;Allocating [&quot; + col + &quot;][&quot; + row + &quot;]&quot;);</span>
<span class="nc" id="L499">          allocation[col][row] =</span>
<span class="nc" id="L500">              new Cell(column.getMarker(index), column.getLabel(index), column.getComponent(index));</span>

          // mark spanned columns
<span class="nc" id="L503">          int colSpan = column.getColSpan(index);</span>
          int spanTo;
<span class="nc bnc" id="L505" title="All 2 branches missed.">          if (colSpan == 1) {</span>
<span class="nc" id="L506">            spanTo = col;</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">          } else if (colSpan == Column.SPAN_ALL) {</span>
<span class="nc" id="L508">            spanTo = cols - 1;</span>
          } else {
<span class="nc" id="L510">            spanTo = Math.min(cols - 1, col + colSpan - 1);</span>
          }
<span class="nc bnc" id="L512" title="All 2 branches missed.">          for (int spanned = col + 1; spanned &lt;= spanTo; spanned++) {</span>
<span class="nc" id="L513">            allocation[spanned][row] = Cell.SPANNED;</span>
          }
<span class="nc" id="L515">          allocation[col][row].setSpanTo(spanTo);</span>

          // define maximum row number
<span class="nc" id="L518">          rows = Math.max(row, rows);</span>

          // advance to next row
<span class="nc" id="L521">          row++;</span>
<span class="nc bnc" id="L522" title="All 4 branches missed.">          if (autoColumns &amp;&amp; row &gt;= autoRows) {</span>
<span class="nc" id="L523">            row = 0;</span>
<span class="nc" id="L524">            col++;</span>
          }
        }
<span class="nc" id="L527">        col++;</span>
<span class="nc" id="L528">      }</span>
<span class="nc" id="L529">      rows++;</span>

<span class="nc" id="L531">      return;</span>
    }

    public int getCols() {
<span class="nc" id="L535">      return cols;</span>
    }

    public int getRows() {
<span class="nc" id="L539">      return rows;</span>
    }

    public Cell getCell(int col, int row) {
<span class="nc bnc" id="L543" title="All 2 branches missed.">      assert col &lt; cols;</span>
<span class="nc bnc" id="L544" title="All 2 branches missed.">      assert row &lt; rows;</span>
<span class="nc" id="L545">      return allocation[col][row];</span>
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>