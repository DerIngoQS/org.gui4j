<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Gui4jMatrix.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">gui4j</a> &gt; <a href="index.source.html" class="el_package">org.gui4j.component</a> &gt; <span class="el_source">Gui4jMatrix.java</span></div><h1>Gui4jMatrix.java</h1><pre class="source lang-java linenums">package org.gui4j.component;

import java.awt.Color;
import java.awt.Component;
import java.awt.Dimension;
import java.awt.Font;
import java.awt.Point;
import java.awt.Rectangle;
import java.awt.event.MouseEvent;
import java.io.Serializable;
import java.util.ArrayList;
import java.util.Collection;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import javax.swing.JComponent;
import javax.swing.JLabel;
import javax.swing.JTable;
import javax.swing.ListSelectionModel;
import javax.swing.table.DefaultTableCellRenderer;
import javax.swing.table.JTableHeader;
import javax.swing.table.TableCellEditor;
import javax.swing.table.TableCellRenderer;
import javax.swing.table.TableColumn;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.gui4j.Gui4jCallBase;
import org.gui4j.Gui4jGetValue;
import org.gui4j.component.util.StringUtil;
import org.gui4j.core.Gui4jCall;
import org.gui4j.core.Gui4jComponentContainer;
import org.gui4j.core.Gui4jComponentInstance;
import org.gui4j.core.Gui4jQualifiedComponent;
import org.gui4j.core.Gui4jSwingContainer;
import org.gui4j.core.Gui4jTextAttribute;
import org.gui4j.core.Gui4jThreadManager;
import org.gui4j.core.Gui4jTypeManager;
import org.gui4j.core.listener.Gui4jMouseListenerMatrix;
import org.gui4j.core.swing.BooleanTableCellRenderer;
import org.gui4j.core.swing.ComboBoxCellEdit;
import org.gui4j.core.swing.Gui4jCellEditor;
import org.gui4j.core.swing.Gui4jJTable;
import org.gui4j.core.swing.Gui4jJTableHeader;
import org.gui4j.core.swing.Gui4jRefreshTable;
import org.gui4j.core.swing.Gui4jTableListener;
import org.gui4j.core.swing.MultiLineLabelUI;
import org.gui4j.core.swing.RowHeaderAbstractTableModel;
import org.gui4j.core.swing.RowHeaderTable;
import org.gui4j.core.util.ComboBoxNullItem;
import org.gui4j.core.util.SparseMatrix;
import org.gui4j.event.Gui4jEventListener;
import org.gui4j.util.Pair;

/** Table supporting dynamic count of columns and rows */
public class Gui4jMatrix extends Gui4jJComponent {
<span class="nc" id="L57">  protected static final Log mLogger = LogFactory.getLog(Gui4jMatrix.class);</span>

  public static final String PARAM_COL = &quot;col&quot;;
  public static final String PARAM_ROW = &quot;row&quot;;
  public static final String PARAM_VALUE = &quot;value&quot;;
  public static final String PARAM_COLVALUE = &quot;colValue&quot;;
  public static final String PARAM_ROWVALUE = &quot;rowValue&quot;;
  public static final String PARAM_LIST = &quot;list&quot;;
  public static final String PARAM_LIST_ITEM = &quot;listItem&quot;;

  private static final String SELECTION_LISTENER_ID = &quot;selectionListener&quot;;

  protected final Gui4jTypeManager mColManager;
  protected final Gui4jTypeManager mRowManager;
  protected final SparseMatrix mCellManager;
  protected final boolean mUseCacheDflt;

  protected final int mVisibleRows;
  protected final int mHeaderLines;
  protected final boolean mUseRowHeaders;
  protected final boolean mUseColumnHeaders;
  protected final boolean mAutomaticRefresh;
  protected final Gui4jThreadManager mGui4jThreadManager;

<span class="nc" id="L81">  protected int mRowSelectionMode = ListSelectionModel.SINGLE_SELECTION;</span>
<span class="nc" id="L82">  protected int mColSelectionMode = ListSelectionModel.SINGLE_SELECTION;</span>
<span class="nc" id="L83">  protected boolean mReorderingAllowed = true;</span>
<span class="nc" id="L84">  protected boolean mRowSelectionAllowed = true;</span>

  protected Gui4jCall[] mRefresh;
  protected Gui4jCall mOnSetValue;
  private Gui4jCall mHeaderBackground;

  protected final int mResizeMode;

  /**
   * Constructor Gui4jMatrix.
   *
   * @param gui4jComponentContainer
   * @param id
   * @param visibleRows
   * @param headerLines
   * @param useCache
   * @param useRowHeaders
   * @param useColumnHeaders
   * @param automaticRefresh
   * @param resizeMode
   */
  public Gui4jMatrix(
      Gui4jComponentContainer gui4jComponentContainer,
      String id,
      int visibleRows,
      int headerLines,
      boolean useCache,
      boolean useRowHeaders,
      boolean useColumnHeaders,
      boolean automaticRefresh,
      int resizeMode) {
<span class="nc bnc" id="L115" title="All 2 branches missed.">    super(gui4jComponentContainer, useRowHeaders ? RowHeaderTable.class : Gui4jJTable.class, id);</span>
<span class="nc" id="L116">    mUseCacheDflt = useCache;</span>
<span class="nc" id="L117">    mUseRowHeaders = useRowHeaders;</span>
<span class="nc" id="L118">    mUseColumnHeaders = useColumnHeaders;</span>
<span class="nc" id="L119">    mAutomaticRefresh = automaticRefresh;</span>
<span class="nc" id="L120">    mGui4jThreadManager = getGui4j().getGui4jThreadManager();</span>
<span class="nc" id="L121">    mVisibleRows = visibleRows;</span>
<span class="nc" id="L122">    mHeaderLines = headerLines;</span>
<span class="nc" id="L123">    mResizeMode = resizeMode;</span>

<span class="nc" id="L125">    mColManager = new Gui4jTypeManager();</span>
<span class="nc" id="L126">    mRowManager = new Gui4jTypeManager();</span>
<span class="nc" id="L127">    mCellManager = new SparseMatrix();</span>
<span class="nc" id="L128">  }</span>

  public void addGui4jCol(Class type, Gui4jCol gui4jCol) {
<span class="nc" id="L131">    mColManager.add(type, gui4jCol);</span>
<span class="nc" id="L132">  }</span>

  public void addGui4jRow(Class type, Gui4jRow gui4jRow) {
<span class="nc" id="L135">    mRowManager.add(type, gui4jRow);</span>
<span class="nc" id="L136">  }</span>

  public void addGui4jCell(Gui4jCell gui4jCell) {
    // mLogger.debug(&quot;setting row=&quot;+gui4jCell.getGui4jRow().mClassType+&quot;,
    // col=&quot;+gui4jCell.getGui4jCol().mClassType+&quot;, cell=&quot;+gui4jCell.mValue);
<span class="nc" id="L141">    mCellManager.set(gui4jCell.getGui4jRow(), gui4jCell.getGui4jCol(), gui4jCell);</span>
<span class="nc" id="L142">  }</span>

  public void setColumns(Gui4jComponentInstance gui4jComponentInstance, final Collection columns) {
<span class="nc" id="L145">    Gui4jJTable jTable = (Gui4jJTable) gui4jComponentInstance.getSwingComponent();</span>
<span class="nc" id="L146">    jTable.endCellEditing();</span>
<span class="nc" id="L147">    final Gui4jTableModel tm = (Gui4jTableModel) jTable.getModel();</span>

<span class="nc" id="L149">    Gui4jThreadManager.executeInSwingThreadAndContinue(</span>
<span class="nc" id="L150">        new Runnable() {</span>
          public void run() {
<span class="nc" id="L152">            tm.setColumns(columns);</span>
<span class="nc" id="L153">          }</span>
        });
<span class="nc" id="L155">  }</span>

  public void setRows(Gui4jComponentInstance gui4jComponentInstance, final Collection rows) {
<span class="nc" id="L158">    Gui4jJTable jTable = (Gui4jJTable) gui4jComponentInstance.getSwingComponent();</span>
<span class="nc" id="L159">    jTable.endCellEditing();</span>
<span class="nc" id="L160">    final Gui4jTableModel model = (Gui4jTableModel) jTable.getModel();</span>
<span class="nc" id="L161">    Gui4jThreadManager.executeInSwingThreadAndContinue(</span>
<span class="nc" id="L162">        new Runnable() {</span>
          public void run() {
<span class="nc" id="L164">            model.setRows(rows);</span>
<span class="nc" id="L165">          }</span>
        });
<span class="nc" id="L167">  }</span>

  public void setContent(Gui4jComponentInstance gui4jComponentInstance, Pair content) {
<span class="nc" id="L170">    Gui4jJTable jTable = (Gui4jJTable) gui4jComponentInstance.getSwingComponent();</span>
<span class="nc" id="L171">    jTable.endCellEditing();</span>
<span class="nc" id="L172">    final Gui4jTableModel model = (Gui4jTableModel) jTable.getModel();</span>
<span class="nc" id="L173">    final Object first = content.getFirst();</span>
<span class="nc" id="L174">    final Object second = content.getSecond();</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">    if (!(first instanceof Collection)) {</span>
<span class="nc" id="L176">      mLogger.error(&quot;First part of pair must be instanceof Collection: &quot; + first, new Throwable());</span>
<span class="nc" id="L177">      return;</span>
    }
<span class="nc bnc" id="L179" title="All 2 branches missed.">    if (!(second instanceof Collection)) {</span>
<span class="nc" id="L180">      mLogger.error(</span>
          &quot;Second part of pair must be instanceof Collection: &quot; + second, new Throwable());
<span class="nc" id="L182">      return;</span>
    }

<span class="nc" id="L185">    Gui4jThreadManager.executeInSwingThreadAndContinue(</span>
<span class="nc" id="L186">        new Runnable() {</span>
          public void run() {
<span class="nc" id="L188">            model.setContent((Collection) first, (Collection) second);</span>
<span class="nc" id="L189">          }</span>
        });
<span class="nc" id="L191">  }</span>

  public void setRefresh(Gui4jCall[] refresh) {
<span class="nc" id="L194">    mRefresh = refresh;</span>
<span class="nc" id="L195">  }</span>

  public boolean setCellSelectionPair(Gui4jComponentInstance componentInstance, Pair pair) {
<span class="nc" id="L198">    JTable table = (JTable) componentInstance.getSwingComponent();</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">    if (pair != null) {</span>
<span class="nc" id="L200">      Gui4jTableModel model = (Gui4jTableModel) table.getModel();</span>
<span class="nc" id="L201">      Gui4jMouseListenerMatrix selectionListener =</span>
<span class="nc" id="L202">          (Gui4jMouseListenerMatrix) componentInstance.getStorage(SELECTION_LISTENER_ID);</span>

<span class="nc" id="L204">      int row = model.getRowIndex(pair.getFirst());</span>
<span class="nc" id="L205">      int col = model.getColumnIndex(pair.getSecond());</span>

<span class="nc bnc" id="L207" title="All 8 branches missed.">      if (row &gt;= 0 &amp;&amp; row &lt; table.getRowCount() &amp;&amp; col &gt;= 0 &amp;&amp; col &lt; table.getColumnCount()) {</span>
<span class="nc bnc" id="L208" title="All 4 branches missed.">        if (table.getCellEditor() != null &amp;&amp; table.isEditing()) {</span>
<span class="nc" id="L209">          table.getCellEditor().stopCellEditing();</span>
        }
<span class="nc bnc" id="L211" title="All 2 branches missed.">        if (selectionListener != null) {</span>
<span class="nc" id="L212">          selectionListener.setValueChangeActive(false);</span>
        }
<span class="nc" id="L214">        table.setRowSelectionInterval(row, row);</span>
<span class="nc" id="L215">        table.setColumnSelectionInterval(col, col);</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">        if (selectionListener != null) {</span>
<span class="nc" id="L217">          selectionListener.setValueChangeActive(true);</span>
<span class="nc" id="L218">          selectionListener.valueChanged(null); // fire only one</span>
          // event for the
          // combined row and
          // column change
        }
<span class="nc" id="L223">        Rectangle rect = table.getCellRect(row, col, true);</span>
<span class="nc" id="L224">        table.scrollRectToVisible(rect);</span>
<span class="nc" id="L225">        return true;</span>
      }
    }
<span class="nc" id="L228">    return false;</span>
  }

  /**
   * Sets the onSetValue.
   *
   * @param onSetValue The onSetValue to set
   */
  public void setOnSetValue(Gui4jCall onSetValue) {
<span class="nc" id="L237">    mOnSetValue = onSetValue;</span>
<span class="nc" id="L238">  }</span>

  /**
   * Sets the headerBackground.
   *
   * @param headerBackground
   */
  public void setHeaderBackground(Gui4jCall headerBackground) {
<span class="nc" id="L246">    mHeaderBackground = headerBackground;</span>
<span class="nc" id="L247">  }</span>

  /**
   * @see org.gui4j.core.Gui4jAbstractComponent#setProperties(Gui4jComponentInstance)
   */
  protected void setProperties(Gui4jComponentInstance gui4jComponentInstance) {
<span class="nc" id="L253">    super.setProperties(gui4jComponentInstance);</span>
<span class="nc" id="L254">    Gui4jJTable table = (Gui4jJTable) gui4jComponentInstance.getSwingComponent();</span>
<span class="nc" id="L255">    table.setAutoResizeMode(mResizeMode);</span>
<span class="nc" id="L256">    Font font = table.getFont();</span>
<span class="nc" id="L257">    table.setDefaultEditor(Object.class, Gui4jCellEditor.createTextEditor(font, true));</span>

<span class="nc" id="L259">    Color headerBackground = null;</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">    if (mHeaderBackground != null) {</span>
<span class="nc" id="L261">      headerBackground =</span>
          (Color)
<span class="nc" id="L263">              mHeaderBackground.getValueNoParams(gui4jComponentInstance.getGui4jCallBase(), null);</span>
    }

<span class="nc bnc" id="L266" title="All 2 branches missed.">    if (mUseColumnHeaders) {</span>
<span class="nc" id="L267">      JTableHeader tableHeader = new Gui4jJTableHeader(table.getColumnModel(), font, mHeaderLines);</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">      if (headerBackground != null) {</span>
<span class="nc" id="L269">        tableHeader.setBackground(headerBackground);</span>
      }
<span class="nc" id="L271">      table.setTableHeader(tableHeader);</span>
    }

<span class="nc" id="L274">    JTableHeader tableHeader = table.getTableHeader();</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">    if (tableHeader != null) {</span>
<span class="nc" id="L276">      tableHeader.setReorderingAllowed(mReorderingAllowed);</span>
<span class="nc" id="L277">      tableHeader.setFont(font);</span>
<span class="nc" id="L278">      TableCellRenderer renderer = tableHeader.getDefaultRenderer();</span>
<span class="nc" id="L279">      Component c = renderer.getTableCellRendererComponent(table, &quot;&quot;, false, false, 0, 0);</span>
<span class="nc bnc" id="L280" title="All 4 branches missed.">      if (mHeaderLines == 1 &amp;&amp; c instanceof JLabel) {</span>
<span class="nc" id="L281">        ((JLabel) c).setUI(MultiLineLabelUI.getInstance());</span>
      }
    }

    {
<span class="nc" id="L286">      JLabel l = new JLabel(&quot;X&quot;);</span>
<span class="nc" id="L287">      l.setFont(font);</span>
<span class="nc" id="L288">      table.setRowHeight(l.getPreferredSize().height + 4);</span>
    }

<span class="nc bnc" id="L291" title="All 2 branches missed.">    if (mVisibleRows != -1) {</span>
<span class="nc" id="L292">      Dimension d = new Dimension(table.getPreferredSize());</span>
<span class="nc" id="L293">      d.setSize(d.getWidth(), table.getRowHeight() * mVisibleRows + 3);</span>
<span class="nc" id="L294">      table.setPreferredScrollableViewportSize(d);</span>
    }

<span class="nc" id="L297">    final Gui4jTableModel tableModel = (Gui4jTableModel) table.getModel();</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">    if (mUseRowHeaders) {</span>
<span class="nc" id="L299">      JLabel label = new JLabel();</span>
<span class="nc" id="L300">      label.setFont(font);</span>
<span class="nc" id="L301">      RowHeaderTable ctable = (RowHeaderTable) table;</span>
<span class="nc" id="L302">      ctable.setRowHeaderFont(font);</span>
<span class="nc" id="L303">      ctable.setRowHeaderHeight(table.getRowHeight());</span>
<span class="nc" id="L304">      tableModel.refreshRows();</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">      if (headerBackground != null) {</span>
<span class="nc" id="L306">        ((RowHeaderTable.RowHeaderRenderer) ctable.getRowHeader().getCellRenderer())</span>
<span class="nc" id="L307">            .setBackground(headerBackground);</span>
      }
    }
<span class="nc" id="L310">    tableModel.setInitialized();</span>
<span class="nc" id="L311">    tableModel.refreshColumns(tableModel);</span>

<span class="nc" id="L313">    final Flag hasOnCellSelect = new Flag();</span>
<span class="nc" id="L314">    final Flag hasOnCellClick = new Flag();</span>
<span class="nc" id="L315">    final Flag hasOnCellDblClick = new Flag();</span>
<span class="nc" id="L316">    mCellManager.traverse(</span>
<span class="nc" id="L317">        new SparseMatrix.Traverser() {</span>
          public void work(Object row, Object col, Object value) {
<span class="nc" id="L319">            Gui4jCell gui4jCell = (Gui4jCell) value;</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">            hasOnCellSelect.val |= gui4jCell.mOnCellSelect != null;</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">            hasOnCellClick.val |= gui4jCell.mOnCellClick != null;</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">            hasOnCellDblClick.val |= gui4jCell.mOnCellDblClick != null;</span>
<span class="nc" id="L323">          }</span>
        });

<span class="nc bnc" id="L326" title="All 2 branches missed.">    if (hasOnCellSelect.val) {</span>
<span class="nc" id="L327">      Gui4jMouseListenerMatrix.CellListener cellListener =</span>
<span class="nc" id="L328">          new Gui4jMouseListenerMatrix.CellListener() {</span>
            public void handle(
                int[] rows,
                int[] cols,
                Gui4jCallBase gui4jController,
                Gui4jThreadManager gui4jThreadManager) {
<span class="nc bnc" id="L334" title="All 4 branches missed.">              if (rows.length == 1 &amp;&amp; cols.length == 1) {</span>
<span class="nc" id="L335">                tableModel.handleOnCellSelect(</span>
                    rows[0], cols[0], gui4jController, gui4jThreadManager);
              }
<span class="nc" id="L338">            }</span>
          };
<span class="nc" id="L340">      Gui4jMouseListenerMatrix selectionListener =</span>
          new Gui4jMouseListenerMatrix(gui4jComponentInstance, 1, cellListener);
<span class="nc" id="L342">      table.getSelectionModel().addListSelectionListener(selectionListener);</span>
<span class="nc" id="L343">      table.getColumnModel().getSelectionModel().addListSelectionListener(selectionListener);</span>
<span class="nc" id="L344">      gui4jComponentInstance.setStorage(SELECTION_LISTENER_ID, selectionListener);</span>
    }

<span class="nc bnc" id="L347" title="All 2 branches missed.">    if (hasOnCellClick.val) {</span>
<span class="nc" id="L348">      Gui4jMouseListenerMatrix.CellListener cellListener =</span>
<span class="nc" id="L349">          new Gui4jMouseListenerMatrix.CellListener() {</span>
            public void handle(
                int[] rows,
                int[] cols,
                Gui4jCallBase gui4jController,
                Gui4jThreadManager gui4jThreadManager) {
<span class="nc bnc" id="L355" title="All 4 branches missed.">              if (rows.length == 1 &amp;&amp; cols.length == 1) {</span>
<span class="nc" id="L356">                tableModel.handleOnCellClick(rows[0], cols[0], gui4jController, gui4jThreadManager);</span>
              }
<span class="nc" id="L358">            }</span>
          };
<span class="nc" id="L360">      Gui4jMouseListenerMatrix mouseListener =</span>
          new Gui4jMouseListenerMatrix(gui4jComponentInstance, 1, cellListener);
<span class="nc" id="L362">      table.addMouseListener(mouseListener);</span>
    }

<span class="nc bnc" id="L365" title="All 2 branches missed.">    if (hasOnCellDblClick.val) {</span>
<span class="nc" id="L366">      Gui4jMouseListenerMatrix.CellListener cellListener =</span>
<span class="nc" id="L367">          new Gui4jMouseListenerMatrix.CellListener() {</span>
            public void handle(
                int[] rows,
                int[] cols,
                Gui4jCallBase gui4jController,
                Gui4jThreadManager gui4jThreadManager) {
<span class="nc bnc" id="L373" title="All 4 branches missed.">              if (rows.length == 1 &amp;&amp; cols.length == 1) {</span>
<span class="nc" id="L374">                tableModel.handleOnCellDblClick(</span>
                    rows[0], cols[0], gui4jController, gui4jThreadManager);
              }
<span class="nc" id="L377">            }</span>
          };
<span class="nc" id="L379">      Gui4jMouseListenerMatrix mouseListener =</span>
          new Gui4jMouseListenerMatrix(gui4jComponentInstance, 2, cellListener);
<span class="nc" id="L381">      table.addMouseListener(mouseListener);</span>
    }
<span class="nc" id="L383">  }</span>

  /*
   * (non-Javadoc)
   *
   * @see org.gui4j.core.Gui4jAbstractComponent#createComponentInstance(org.gui4j.core.Gui4jSwingContainer,
   *      org.gui4j.Gui4jCallBase, org.gui4j.core.Gui4jQualifiedComponent)
   */
  protected Gui4jComponentInstance createComponentInstance(
      Gui4jSwingContainer gui4jSwingContainer,
      Gui4jCallBase gui4jCallBase,
      Gui4jQualifiedComponent gui4jComponentInPath) {
<span class="nc" id="L395">    Gui4jTableModel tm = new Gui4jTableModel(gui4jSwingContainer, gui4jCallBase);</span>

<span class="nc" id="L397">    registerEvents(gui4jSwingContainer, gui4jCallBase, mRefresh, tm);</span>

    Gui4jJTable table;
<span class="nc bnc" id="L400" title="All 2 branches missed.">    if (mUseRowHeaders) {</span>
<span class="nc" id="L401">      table = new RowHeaderTable(tm, tm);</span>
    } else {
<span class="nc" id="L403">      table = new Gui4jJTable(tm, tm);</span>
    }
<span class="nc bnc" id="L405" title="All 2 branches missed.">    if (!mUseColumnHeaders) {</span>
<span class="nc" id="L406">      table.setTableHeader(null);</span>
    }
<span class="nc" id="L408">    table.getSelectionModel().setSelectionMode(mRowSelectionMode);</span>
<span class="nc" id="L409">    table.getColumnModel().getSelectionModel().setSelectionMode(mColSelectionMode);</span>
<span class="nc" id="L410">    table.setRowSelectionAllowed(mRowSelectionAllowed);</span>
<span class="nc" id="L411">    Gui4jComponentInstance gui4jComponentInstance =</span>
        new Gui4jComponentInstance(gui4jSwingContainer, table, gui4jComponentInPath);
<span class="nc" id="L413">    tm.setGui4jComponentInstance(gui4jComponentInstance);</span>

<span class="nc" id="L415">    return gui4jComponentInstance;</span>
  }

  /**
   * Sets the reorderingAllowed.
   *
   * @param reorderingAllowed The reorderingAllowed to set
   */
  public void setReorderingAllowed(boolean reorderingAllowed) {
<span class="nc" id="L424">    mReorderingAllowed = reorderingAllowed;</span>
<span class="nc" id="L425">  }</span>

  /**
   * Sets the colSelectionMode.
   *
   * @param colSelectionMode The colSelectionMode to set
   */
  public void setColSelectionMode(int colSelectionMode) {
<span class="nc" id="L433">    mColSelectionMode = colSelectionMode;</span>
<span class="nc" id="L434">  }</span>

  /**
   * Sets the rowSelectionMode.
   *
   * @param rowSelectionMode The rowSelectionMode to set
   */
  public void setRowSelectionMode(int rowSelectionMode) {
<span class="nc" id="L442">    mRowSelectionMode = rowSelectionMode;</span>
<span class="nc" id="L443">  }</span>

  /**
   * Sets the rowSelectionAllowed.
   *
   * @param rowSelectionAllowed The rowSelectionAllowed to set
   */
  public void setRowSelectionAllowed(boolean rowSelectionAllowed) {
<span class="nc" id="L451">    mRowSelectionAllowed = rowSelectionAllowed;</span>
<span class="nc" id="L452">  }</span>

  protected Point getPopupLocation(
      Gui4jComponentInstance gui4jComponentInstance, MouseEvent mouseEvent, Object context) {
<span class="nc bnc" id="L456" title="All 2 branches missed.">    if (mouseEvent != null) {</span>
<span class="nc" id="L457">      return mouseEvent.getPoint();</span>
    }

<span class="nc" id="L460">    JTable table = (JTable) gui4jComponentInstance.getComponent();</span>
<span class="nc" id="L461">    Rectangle selection =</span>
<span class="nc" id="L462">        table.getCellRect(table.getSelectedRow(), table.getSelectedColumn(), true);</span>
<span class="nc" id="L463">    return new Point(selection.x + selection.width / 2, selection.y + selection.height / 2);</span>
  }

  protected Object getPopupContext(
      Gui4jComponentInstance gui4jComponentInstance, MouseEvent mouseEvent) {
<span class="nc" id="L468">    JTable table = (JTable) gui4jComponentInstance.getComponent();</span>
<span class="nc" id="L469">    Gui4jTableModel model = (Gui4jTableModel) table.getModel();</span>
<span class="nc" id="L470">    int row = table.getSelectedRow();</span>
<span class="nc" id="L471">    int col = table.getSelectedColumn();</span>
<span class="nc" id="L472">    mLogger.debug(&quot;Computing popup context for row &quot; + row + &quot;, col &quot; + col);</span>
<span class="nc" id="L473">    Gui4jCell cell = model.getGui4jCell(row, col);</span>
<span class="nc bnc" id="L474" title="All 4 branches missed.">    if (cell != null &amp;&amp; cell.mPopupContext != null) {</span>
<span class="nc" id="L475">      Map paramMap =</span>
<span class="nc" id="L476">          cell.getParamMap(gui4jComponentInstance.getGui4jCallBase(), row, col, true, model);</span>
<span class="nc" id="L477">      return cell.mPopupContext.getValue(gui4jComponentInstance.getGui4jCallBase(), paramMap, null);</span>
    }
<span class="nc" id="L479">    return null;</span>
  }

  /**
   * @see org.gui4j.core.Gui4jComponent#dispose(Gui4jComponentInstance)
   */
  public void dispose(Gui4jComponentInstance gui4jComponentInstance) {
<span class="nc" id="L486">    super.dispose(gui4jComponentInstance);</span>
<span class="nc" id="L487">    Gui4jJTable jTable = (Gui4jJTable) gui4jComponentInstance.getSwingComponent();</span>
<span class="nc" id="L488">    Gui4jTableModel model = (Gui4jTableModel) jTable.getModel();</span>
<span class="nc" id="L489">    model.dispose();</span>
<span class="nc" id="L490">  }</span>

  // *************************************************************************************
  // ROW
  // *************************************************************************************
  public final class Gui4jRow implements Serializable {
    private final Gui4jCall mRowName;
    private final Gui4jTextAttribute mGui4jTextAttribute;
    protected final Class mClassType;

<span class="nc" id="L500">    public Gui4jRow(Class classType, Gui4jCall rowName, Gui4jTextAttribute gui4jTextAttribute) {</span>
<span class="nc" id="L501">      mRowName = rowName;</span>
<span class="nc" id="L502">      mGui4jTextAttribute = gui4jTextAttribute;</span>
<span class="nc" id="L503">      mClassType = classType;</span>
<span class="nc" id="L504">    }</span>

    public Gui4jRow copy(Class newClassType) {
<span class="nc" id="L507">      return new Gui4jRow(newClassType, mRowName, mGui4jTextAttribute);</span>
    }

    public Gui4jTextAttribute getGui4jTextAttribute() {
<span class="nc" id="L511">      return mGui4jTextAttribute;</span>
    }

    protected String getName(Gui4jCallBase gui4jController, int row, Gui4jTableModel model) {
<span class="nc bnc" id="L515" title="All 2 branches missed.">      if (mRowName != null) {</span>
<span class="nc" id="L516">        Map paramMap = new HashMap();</span>
<span class="nc" id="L517">        paramMap.put(PARAM_ROW, new Integer(row));</span>
<span class="nc" id="L518">        paramMap.put(PARAM_ROWVALUE, model.mRows.get(row));</span>
<span class="nc" id="L519">        return (String) mRowName.getValue(gui4jController, paramMap, null);</span>
      } else {
<span class="nc" id="L521">        return null;</span>
      }
    }
  }

  // *************************************************************************************
  // COL
  // *************************************************************************************

<span class="nc" id="L530">  public final class Gui4jCol implements Serializable {</span>
    protected final Class mClassType;
    private final Gui4jCall mColName;
    private final Gui4jCall mCharacters;
    private final Gui4jCall mMaxCharacters;
    private final Gui4jTextAttribute mGui4jTextAttribute;
<span class="nc" id="L536">    private double mWeight = 1.0;</span>

    public Gui4jCol(
        Class classType,
        Gui4jCall colName,
        Gui4jTextAttribute gui4jTextAttribute,
        Gui4jCall characters,
<span class="nc" id="L543">        Gui4jCall maxCharacters) {</span>
<span class="nc" id="L544">      mColName = colName;</span>
<span class="nc" id="L545">      mGui4jTextAttribute = gui4jTextAttribute;</span>
<span class="nc" id="L546">      mCharacters = characters;</span>
<span class="nc" id="L547">      mMaxCharacters = maxCharacters;</span>
<span class="nc" id="L548">      mClassType = classType;</span>
<span class="nc" id="L549">    }</span>

    public Gui4jCol copy(Class newClassType) {
<span class="nc" id="L552">      Gui4jCol c =</span>
          new Gui4jCol(newClassType, mColName, mGui4jTextAttribute, mCharacters, mMaxCharacters);
<span class="nc" id="L554">      c.setWeight(mWeight);</span>
<span class="nc" id="L555">      return c;</span>
    }

    public void setWeight(double weight) {
<span class="nc" id="L559">      mWeight = weight;</span>
<span class="nc" id="L560">    }</span>

    public double getWeight() {
<span class="nc" id="L563">      return mWeight;</span>
    }

    public Gui4jTextAttribute getGui4jTextAttribute() {
<span class="nc" id="L567">      return mGui4jTextAttribute;</span>
    }

    public String getName(Gui4jCallBase gui4jController, int col, Gui4jTableModel model) {
<span class="nc bnc" id="L571" title="All 2 branches missed.">      if (mColName != null) {</span>
<span class="nc" id="L572">        Map paramMap = new HashMap();</span>
<span class="nc" id="L573">        paramMap.put(PARAM_COL, new Integer(col));</span>
<span class="nc" id="L574">        paramMap.put(PARAM_COLVALUE, model.mColumns.get(col));</span>
<span class="nc" id="L575">        return (String) mColName.getValue(gui4jController, paramMap, null);</span>
      } else {
<span class="nc" id="L577">        return null;</span>
      }
    }

    public boolean charactersDefined() {
<span class="nc bnc" id="L582" title="All 2 branches missed.">      return mCharacters != null;</span>
    }

    public boolean maxCharactersDefined() {
<span class="nc bnc" id="L586" title="All 2 branches missed.">      return mMaxCharacters != null;</span>
    }

    public int getCharacters(Gui4jCallBase gui4jController) {
<span class="nc bnc" id="L590" title="All 2 branches missed.">      assert mCharacters != null;</span>
<span class="nc" id="L591">      Integer i = (Integer) mCharacters.getValueNoParams(gui4jController, null);</span>
<span class="nc" id="L592">      return i.intValue();</span>
    }

    public int getMaxCharacters(Gui4jCallBase gui4jController) {
<span class="nc bnc" id="L596" title="All 2 branches missed.">      assert mMaxCharacters != null;</span>
<span class="nc" id="L597">      Integer i = (Integer) mMaxCharacters.getValueNoParams(gui4jController, null);</span>
<span class="nc" id="L598">      return i.intValue();</span>
    }
  }

  // *************************************************************************************
  // CELL
  // *************************************************************************************
<span class="nc" id="L605">  public final class Gui4jCell implements Serializable {</span>
    private final Gui4jRow mGui4jRow;
    private final Gui4jCol mGui4jCol;
    private final Gui4jTextAttribute mGui4jTextAttribute;

    protected Gui4jCall mValue;
    private final Gui4jCall mSetValue;
    private final Gui4jCall mEnabled;
    private final Gui4jCall mList;
    private final Gui4jCall mListItem;
    private final Gui4jCall mListNullItem;
    private final Gui4jCall mListEditable;
    private final Gui4jCall mStringConvert;
    protected final Gui4jCall mOnCellSelect;
    protected final Gui4jCall mOnCellClick;
    protected final Gui4jCall mOnCellDblClick;
    protected final Gui4jCall mTooltip;
    protected final Gui4jCall mNotifyTempValue;
    protected final Gui4jCall mPopupContext;

    public Gui4jCell(
        Class rowType,
        Class columnType,
        Gui4jTextAttribute gui4jTextAttribute,
        Gui4jCall value,
        Gui4jCall setValue,
        Gui4jCall enabled,
        Gui4jCall list,
        Gui4jCall listItem,
        Gui4jCall listNullItem,
        Gui4jCall listEditable,
        Gui4jCall stringConvert,
        Gui4jCall onCellSelect,
        Gui4jCall onCellClick,
        Gui4jCall onCellDblClick,
        Gui4jCall tooltip,
        Gui4jCall notifyTempValue,
<span class="nc" id="L642">        Gui4jCall popupContext) {</span>
<span class="nc bnc" id="L643" title="All 2 branches missed.">      assert rowType != null;</span>
<span class="nc bnc" id="L644" title="All 2 branches missed.">      assert columnType != null;</span>
      {
<span class="nc" id="L646">        Gui4jRow row = (Gui4jRow) mRowManager.get(rowType);</span>
        /*
         * if (row != null) { mLogger.debug(&quot;RowType =
         * &quot;+rowType.getName()+&quot; gui4jRow=&quot;+row.mClassType.getName()); }
         */
<span class="nc bnc" id="L651" title="All 2 branches missed.">        if (row == null) {</span>
<span class="nc" id="L652">          mLogger.info(getId() + &quot;: row for type &quot; + rowType.getName() + &quot; not defined&quot;);</span>
<span class="nc" id="L653">          mGui4jRow = new Gui4jRow(rowType, null, null);</span>
<span class="nc" id="L654">          mRowManager.add(rowType, mGui4jRow);</span>
        } else {
          //
<span class="nc bnc" id="L657" title="All 2 branches missed.">          if (row.mClassType != rowType) {</span>
<span class="nc" id="L658">            mLogger.debug(</span>
                &quot;Creating new Gui4jRow instance for type &quot;
<span class="nc" id="L660">                    + rowType.getName()</span>
                    + &quot; as copy from &quot;
<span class="nc" id="L662">                    + row.mClassType.getName());</span>
<span class="nc" id="L663">            row = row.copy(rowType);</span>
<span class="nc" id="L664">            mRowManager.add(rowType, row);</span>
          }
          // */
<span class="nc" id="L667">          mGui4jRow = row;</span>
        }
      }
      {
<span class="nc" id="L671">        Gui4jCol col = (Gui4jCol) mColManager.get(columnType);</span>
<span class="nc bnc" id="L672" title="All 2 branches missed.">        if (col == null) {</span>
<span class="nc" id="L673">          mLogger.info(getId() + &quot;: column for type &quot; + columnType.getName() + &quot; not defined&quot;);</span>
<span class="nc" id="L674">          mGui4jCol = new Gui4jCol(columnType, null, null, null, null);</span>
<span class="nc" id="L675">          mColManager.add(columnType, mGui4jCol);</span>
        } else {
          //
<span class="nc bnc" id="L678" title="All 2 branches missed.">          if (col.mClassType != columnType) {</span>
<span class="nc" id="L679">            mLogger.debug(</span>
                &quot;Creating new Gui4jCol instance for type &quot;
<span class="nc" id="L681">                    + columnType.getName()</span>
                    + &quot; as copy from &quot;
<span class="nc" id="L683">                    + col.mClassType.getName());</span>
<span class="nc" id="L684">            col = col.copy(columnType);</span>
<span class="nc" id="L685">            mColManager.add(columnType, col);</span>
          }
          // */
<span class="nc" id="L688">          mGui4jCol = col;</span>
        }
      }
<span class="nc" id="L691">      mGui4jTextAttribute = gui4jTextAttribute;</span>
<span class="nc" id="L692">      mValue = value;</span>
<span class="nc" id="L693">      mSetValue = setValue;</span>
<span class="nc" id="L694">      mEnabled = enabled;</span>
<span class="nc" id="L695">      mList = list;</span>
<span class="nc" id="L696">      mListItem = listItem;</span>
<span class="nc" id="L697">      mListNullItem = listNullItem;</span>
<span class="nc" id="L698">      mListEditable = listEditable;</span>
<span class="nc" id="L699">      mStringConvert = stringConvert;</span>
<span class="nc" id="L700">      mOnCellSelect = onCellSelect;</span>
<span class="nc" id="L701">      mOnCellClick = onCellClick;</span>
<span class="nc" id="L702">      mOnCellDblClick = onCellDblClick;</span>
<span class="nc" id="L703">      mTooltip = tooltip;</span>
<span class="nc" id="L704">      mNotifyTempValue = notifyTempValue;</span>
<span class="nc" id="L705">      mPopupContext = popupContext;</span>
<span class="nc" id="L706">    }</span>

    public String getTooltip(
        Gui4jCallBase gui4jController, int row, int col, Gui4jTableModel model) {
<span class="nc bnc" id="L710" title="All 2 branches missed.">      if (mTooltip != null) {</span>
<span class="nc" id="L711">        Map m = getParamMap(gui4jController, row, col, true, model);</span>
<span class="nc" id="L712">        String value = (String) mTooltip.getValue(gui4jController, m, null);</span>
<span class="nc" id="L713">        return value;</span>
      } else {
<span class="nc" id="L715">        return null;</span>
      }
    }

    public Object getValue(Gui4jCallBase gui4jController, int row, int col, Gui4jTableModel model) {
<span class="nc bnc" id="L720" title="All 2 branches missed.">      if (mValue != null) {</span>
<span class="nc" id="L721">        Map m = getParamMap(gui4jController, row, col, true, model);</span>
<span class="nc" id="L722">        Object value = mValue.getValue(gui4jController, m, null);</span>
        // mLogger.debug(getId()+&quot;: getValue(&quot;+row+&quot;, &quot;+col+&quot;) =
        // &quot;+value);
<span class="nc" id="L725">        return value;</span>
      } else {
<span class="nc" id="L727">        return null;</span>
      }
    }

    public void invalidateCall() {
<span class="nc" id="L732">      mValue = null;</span>
<span class="nc" id="L733">    }</span>

    public void setValue(
        Gui4jCallBase gui4jController, int row, int col, Object value, Gui4jTableModel model) {
<span class="nc bnc" id="L737" title="All 2 branches missed.">      if (mSetValue != null) {</span>
<span class="nc" id="L738">        Map paramMap = getParamMap(gui4jController, row, col, false, model);</span>

<span class="nc bnc" id="L740" title="All 2 branches missed.">        if (value instanceof ComboBoxNullItem) {</span>
<span class="nc" id="L741">          value = null;</span>
        }

<span class="nc" id="L744">        paramMap.put(PARAM_VALUE, value);</span>

        Gui4jGetValue[] work;
<span class="nc bnc" id="L747" title="All 2 branches missed.">        if (mOnSetValue != null) {</span>
<span class="nc" id="L748">          work =</span>
              new Gui4jGetValue[] {
                mSetValue,
                new Gui4jRefreshTable(model, row, col),
<span class="nc" id="L752">                model.getAutomaticRefresh(),</span>
                mOnSetValue
              };
        } else {
<span class="nc" id="L756">          work =</span>
              new Gui4jGetValue[] {
<span class="nc" id="L758">                mSetValue, new Gui4jRefreshTable(model, row, col), model.getAutomaticRefresh()</span>
              };
        }

        // XXX mGui4jThreadManager.performWork(gui4jController, work,
        // paramMap, mNotifyTempValue != null);
<span class="nc" id="L764">        mGui4jThreadManager.performWork(gui4jController, work, paramMap, false);</span>
      }
<span class="nc" id="L766">    }</span>

    public void handleOnCellSelect(
        int row,
        int col,
        Gui4jCallBase gui4jController,
        Gui4jThreadManager gui4jThreadManager,
        Gui4jTableModel model) {
<span class="nc bnc" id="L774" title="All 2 branches missed.">      if (mOnCellSelect != null) {</span>
<span class="nc" id="L775">        gui4jThreadManager.performWork(</span>
<span class="nc" id="L776">            gui4jController, mOnCellSelect, getParamMap(gui4jController, row, col, false, model));</span>
      }
<span class="nc" id="L778">    }</span>

    public void handleOnCellClick(
        int row,
        int col,
        Gui4jCallBase gui4jController,
        Gui4jThreadManager gui4jThreadManager,
        Gui4jTableModel model) {
<span class="nc bnc" id="L786" title="All 2 branches missed.">      if (mOnCellClick != null) {</span>
<span class="nc" id="L787">        gui4jThreadManager.performWork(</span>
<span class="nc" id="L788">            gui4jController, mOnCellClick, getParamMap(gui4jController, row, col, false, model));</span>
      }
<span class="nc" id="L790">    }</span>

    public void handleOnCellDblClick(
        int row,
        int col,
        Gui4jCallBase gui4jController,
        Gui4jThreadManager gui4jThreadManager,
        Gui4jTableModel model) {
<span class="nc bnc" id="L798" title="All 2 branches missed.">      if (mOnCellDblClick != null) {</span>
<span class="nc" id="L799">        gui4jThreadManager.performWork(</span>
<span class="nc" id="L800">            gui4jController, mOnCellDblClick, getParamMap(gui4jController, row, col, false, model));</span>
      }
<span class="nc" id="L802">    }</span>

    public boolean isEnabled(
        Gui4jCallBase gui4jController, int row, int col, Gui4jTableModel model) {
<span class="nc bnc" id="L806" title="All 2 branches missed.">      if (mEnabled != null) {</span>
<span class="nc" id="L807">        Map m = getParamMap(gui4jController, row, col, true, model);</span>

<span class="nc" id="L809">        Boolean enabled = (Boolean) mEnabled.getValue(gui4jController, m, Boolean.TRUE);</span>
<span class="nc bnc" id="L810" title="All 2 branches missed.">        if (enabled != null) {</span>
<span class="nc" id="L811">          return enabled.booleanValue();</span>
        } else {
<span class="nc" id="L813">          return false;</span>
        }
      } else {
<span class="nc" id="L816">        return true;</span>
      }
    }

    public boolean isEditable(
        Gui4jCallBase gui4jController, int row, int col, Gui4jTableModel model) {
<span class="nc bnc" id="L822" title="All 4 branches missed.">      return mSetValue != null &amp;&amp; isEnabled(gui4jController, row, col, model);</span>
    }

    public void prepareEditor(
        Gui4jCallBase gui4jController,
        TableCellEditor editor,
        int row,
        int column,
        Gui4jTableModel model) {
<span class="nc bnc" id="L831" title="All 2 branches missed.">      if (mList != null) {</span>
<span class="nc" id="L832">        ComboBoxCellEdit edit = (ComboBoxCellEdit) editor;</span>
<span class="nc" id="L833">        Map m = getParamMap(gui4jController, row, column, true, model);</span>
<span class="nc" id="L834">        edit.setParamMap(m);</span>
<span class="nc" id="L835">        Collection content = (Collection) m.get(PARAM_LIST);</span>
<span class="nc" id="L836">        String nullItemText = null;</span>
<span class="nc bnc" id="L837" title="All 2 branches missed.">        if (mListNullItem != null) {</span>
<span class="nc" id="L838">          nullItemText = (String) mListNullItem.getValueNoParams(gui4jController, &quot;(undefined)&quot;);</span>
<span class="nc bnc" id="L839" title="All 4 branches missed.">          if (nullItemText == null || nullItemText.length() == 0) {</span>
<span class="nc" id="L840">            nullItemText = &quot; &quot;;</span>
            // combobox can't deal correctly with null elements and
            // empty strings
          }
        }
<span class="nc" id="L845">        edit.setContent(content, nullItemText);</span>
<span class="nc" id="L846">        Object selectedItem = m.get(PARAM_LIST_ITEM);</span>
<span class="nc" id="L847">        edit.setSelectedItem(selectedItem);</span>
        // System.out.println(
        // &quot;contentContainsSel = &quot; + content.contains(selectedItem) + &quot;,
        // sel=&quot; + selectedItem);
<span class="nc bnc" id="L851" title="All 2 branches missed.">      } else if (editor instanceof Gui4jCellEditor) {</span>
<span class="nc" id="L852">        Gui4jCellEditor edit = (Gui4jCellEditor) editor;</span>
<span class="nc bnc" id="L853" title="All 2 branches missed.">        if (mNotifyTempValue != null) {</span>
<span class="nc" id="L854">          Map m = getParamMap(gui4jController, row, column, false, model);</span>
<span class="nc" id="L855">          edit.setNotificationCallback(gui4jController, mNotifyTempValue, m, PARAM_VALUE);</span>
<span class="nc" id="L856">        } else {</span>
<span class="nc" id="L857">          edit.setNotificationCallback(null, null, null, null);</span>
        }
      }
<span class="nc" id="L860">    }</span>

    protected final Map getParamMap(
        Gui4jCallBase gui4jController,
        int row,
        int col,
        boolean includeListItem,
        Gui4jTableModel model) {
<span class="nc" id="L868">      Map m = new HashMap();</span>
<span class="nc" id="L869">      m.put(PARAM_COL, new Integer(col));</span>
<span class="nc" id="L870">      m.put(PARAM_ROW, new Integer(row));</span>
<span class="nc" id="L871">      m.put(PARAM_COLVALUE, model.mColumns.get(col));</span>
<span class="nc" id="L872">      m.put(PARAM_ROWVALUE, model.mRows.get(row));</span>

<span class="nc bnc" id="L874" title="All 2 branches missed.">      if (mList != null) {</span>
<span class="nc" id="L875">        Collection collection = (Collection) mList.getValue(gui4jController, m, null);</span>
<span class="nc" id="L876">        m.put(PARAM_LIST, collection);</span>
<span class="nc bnc" id="L877" title="All 4 branches missed.">        if (includeListItem &amp;&amp; mListItem != null) {</span>
<span class="nc" id="L878">          Object listItem = mListItem.getValue(gui4jController, m, null);</span>
<span class="nc" id="L879">          m.put(PARAM_LIST_ITEM, listItem);</span>
        }
      }

<span class="nc" id="L883">      return m;</span>
    }

    public TableCellEditor getCellEditor(
        Gui4jCallBase gui4jController,
        Font font,
        TableCellEditor editor,
        int row,
        int column,
        Gui4jTableModel model) {
<span class="nc bnc" id="L893" title="All 2 branches missed.">      if (mList != null) {</span>
<span class="nc bnc" id="L894" title="All 4 branches missed.">        if (mGui4jTextAttribute != null &amp;&amp; mGui4jTextAttribute.getFont() != null) {</span>
<span class="nc" id="L895">          font = (Font) mGui4jTextAttribute.getFont().getValueNoParams(gui4jController, font);</span>
        }
<span class="nc" id="L897">        ComboBoxCellEdit edit =</span>
<span class="nc" id="L898">            ComboBoxCellEdit.getInstance(</span>
                gui4jController, mValue, mStringConvert, PARAM_LIST_ITEM, font);
<span class="nc" id="L900">        edit.setParamMap(getParamMap(gui4jController, row, column, true, model));</span>
<span class="nc bnc" id="L901" title="All 2 branches missed.">        if (mListEditable != null) {</span>
<span class="nc" id="L902">          Boolean editable = (Boolean) mListEditable.getValueNoParams(gui4jController, null);</span>
<span class="nc" id="L903">          edit.setEditable(Boolean.TRUE.equals(editable));</span>
        }

<span class="nc" id="L906">        return edit;</span>
      } else {
<span class="nc" id="L908">        return editor;</span>
      }
    }

    public Gui4jCol getGui4jCol() {
<span class="nc" id="L913">      return mGui4jCol;</span>
    }

    public Gui4jRow getGui4jRow() {
<span class="nc" id="L917">      return mGui4jRow;</span>
    }

    public Gui4jTextAttribute getTextAttribute() {
<span class="nc" id="L921">      return mGui4jTextAttribute;</span>
    }

    public TableCellRenderer getCellRenderer(
        Gui4jComponentInstance gui4jComponentInstance, Font font, TableCellRenderer renderer) {
<span class="nc" id="L926">      renderer = (TableCellRenderer) gui4jComponentInstance.getStorage(this);</span>
<span class="nc bnc" id="L927" title="All 2 branches missed.">      if (renderer == null) {</span>
<span class="nc" id="L928">        Gui4jJTable table = (Gui4jJTable) gui4jComponentInstance.getSwingComponent();</span>
<span class="nc" id="L929">        renderer = new CellRenderer(gui4jComponentInstance, table, this);</span>
<span class="nc" id="L930">        gui4jComponentInstance.setStorage(this, renderer);</span>
      }
<span class="nc" id="L932">      return renderer;</span>
    }
  }

  // *************************************************************************************
  // CellRenderer
  // *************************************************************************************
  public interface Enabled {
    boolean isEnabled(int row, int column);
  }

  public final class CellRenderer extends DefaultTableCellRenderer {
    private final Color mDefaultForeground;
    private final Color mDefaultBackground;
    private final Font mDefaultFont;
    private final int mAlignment;

    private final Color mBackground;
    private final Gui4jCall mBackgroundCall;

    private final Color mForeground;
    private final Gui4jCall mForegroundCall;
    private final Color mEvenBackground;
    private final Font mFont;
    private final TableCellRenderer booleanCellRenderer;

    private final Gui4jCell mGui4jCell;
    private final Gui4jCallBase mGui4jController;
    private final Gui4jTableModel mTableModel;

    public CellRenderer(
<span class="nc" id="L963">        Gui4jComponentInstance gui4jComponentInstance, Gui4jJTable table, Gui4jCell gui4jCell) {</span>
<span class="nc" id="L964">      mGui4jCell = gui4jCell;</span>
<span class="nc" id="L965">      mGui4jController = gui4jComponentInstance.getGui4jCallBase();</span>
<span class="nc" id="L966">      mTableModel = (Gui4jTableModel) table.getModel();</span>

<span class="nc" id="L968">      mDefaultBackground = getBackground();</span>
<span class="nc" id="L969">      mDefaultForeground = getForeground();</span>
<span class="nc" id="L970">      mDefaultFont = getFont();</span>

<span class="nc" id="L972">      booleanCellRenderer = new BooleanTableCellRenderer(noFocusBorder);</span>

      // use local variables to simplify calls
<span class="nc" id="L975">      Gui4jTextAttribute cellAttribute = mGui4jCell.getTextAttribute();</span>
<span class="nc" id="L976">      Gui4jTextAttribute colAttribute = mGui4jCell.getGui4jCol().getGui4jTextAttribute();</span>
<span class="nc" id="L977">      Gui4jTextAttribute rowAttribute = mGui4jCell.getGui4jRow().getGui4jTextAttribute();</span>

      {
        // background may be evaluated dynamically
<span class="nc" id="L981">        Color color = null;</span>
<span class="nc" id="L982">        mBackgroundCall =</span>
<span class="nc" id="L983">            Gui4jTextAttribute.getCall(</span>
                cellAttribute,
                colAttribute,
                rowAttribute,
<span class="nc" id="L987">                new Gui4jTextAttribute.Gui4jCallProvider() {</span>
                  public Gui4jCall retrieveGui4jCall(Gui4jTextAttribute textAttribute) {
<span class="nc" id="L989">                    return textAttribute.getBackground();</span>
                  }
                });
<span class="nc bnc" id="L992" title="All 4 branches missed.">        if (mBackgroundCall != null &amp;&amp; mBackgroundCall.getUsedParams().isEmpty()) {</span>
<span class="nc" id="L993">          color = Gui4jTextAttribute.getColor(mGui4jController, mBackgroundCall);</span>
        }
<span class="nc" id="L995">        mBackground = color;</span>
      }
      {
        // foreground may be evaluated dynamically
<span class="nc" id="L999">        Color color = null;</span>
<span class="nc" id="L1000">        mForegroundCall =</span>
<span class="nc" id="L1001">            Gui4jTextAttribute.getCall(</span>
                cellAttribute,
                colAttribute,
                rowAttribute,
<span class="nc" id="L1005">                new Gui4jTextAttribute.Gui4jCallProvider() {</span>
                  public Gui4jCall retrieveGui4jCall(Gui4jTextAttribute textAttribute) {
<span class="nc" id="L1007">                    return textAttribute.getForeground();</span>
                  }
                });
<span class="nc bnc" id="L1010" title="All 4 branches missed.">        if (mForegroundCall != null &amp;&amp; mForegroundCall.getUsedParams().isEmpty()) {</span>
<span class="nc" id="L1011">          color = Gui4jTextAttribute.getColor(mGui4jController, mForegroundCall);</span>
        }
<span class="nc" id="L1013">        mForeground = color;</span>
      }

      {
        // even background, font and alignment are evaluated statically
<span class="nc" id="L1018">        mEvenBackground =</span>
<span class="nc" id="L1019">            Gui4jTextAttribute.getEvenBackground(</span>
                mGui4jController, cellAttribute, colAttribute, rowAttribute);
<span class="nc" id="L1021">        mFont =</span>
<span class="nc" id="L1022">            Gui4jTextAttribute.getFont(mGui4jController, cellAttribute, colAttribute, rowAttribute);</span>
<span class="nc" id="L1023">        mAlignment = Gui4jTextAttribute.getAlignment(cellAttribute, colAttribute, rowAttribute);</span>
      }
<span class="nc" id="L1025">    }</span>

    /**
     * @see javax.swing.table.TableCellRenderer#getTableCellRendererComponent(JTable, Object,
     *     boolean, boolean, int, int)
     */
    public Component getTableCellRendererComponent(
        JTable table, Object value, boolean isSelected, boolean hasFocus, int row, int column) {
<span class="nc" id="L1033">      setForeground(mDefaultForeground);</span>
<span class="nc" id="L1034">      setBackground(mDefaultBackground);</span>
<span class="nc" id="L1035">      setFont(mDefaultFont);</span>
<span class="nc" id="L1036">      setEnabled(mGui4jCell.isEnabled(mGui4jController, row, column, mTableModel));</span>

      // get the renderer component for this cell
      JComponent c;
<span class="nc bnc" id="L1040" title="All 4 branches missed.">      if (value != null &amp;&amp; value.getClass() == Boolean.class) {</span>
        // special checkbox renderer for booleans
<span class="nc" id="L1042">        BooleanTableCellRenderer renderer =</span>
            (BooleanTableCellRenderer)
<span class="nc" id="L1044">                booleanCellRenderer.getTableCellRendererComponent(</span>
                    table, value, isSelected, hasFocus, row, column);
        // renderer.setUnselectedBackground(background);
<span class="nc" id="L1047">        c = renderer;</span>
<span class="nc" id="L1048">      } else {</span>
<span class="nc" id="L1049">        c =</span>
            (JComponent)
<span class="nc" id="L1051">                super.getTableCellRendererComponent(</span>
                    table, value, isSelected, hasFocus, row, column);
      }

<span class="nc bnc" id="L1055" title="All 2 branches missed.">      if (!isSelected) {</span>
<span class="nc bnc" id="L1056" title="All 2 branches missed.">        if (mForeground != null) {</span>
<span class="nc" id="L1057">          c.setForeground(mForeground);</span>
<span class="nc bnc" id="L1058" title="All 2 branches missed.">        } else if (mForegroundCall != null) {</span>
<span class="nc" id="L1059">          Map paramMap = mGui4jCell.getParamMap(mGui4jController, row, column, false, mTableModel);</span>
<span class="nc" id="L1060">          paramMap.put(PARAM_VALUE, value);</span>
<span class="nc" id="L1061">          c.setForeground((Color) mForegroundCall.getValue(mGui4jController, paramMap, null));</span>
        }
<span class="nc bnc" id="L1063" title="All 2 branches missed.">        if (!mTableModel.ignoreBackground()) {</span>
<span class="nc bnc" id="L1064" title="All 4 branches missed.">          if (row % 2 == 0 &amp;&amp; mEvenBackground != null) {</span>
<span class="nc" id="L1065">            c.setBackground(mEvenBackground);</span>
          } else {
<span class="nc bnc" id="L1067" title="All 2 branches missed.">            if (mBackground != null) {</span>
<span class="nc" id="L1068">              c.setBackground(mBackground);</span>
<span class="nc bnc" id="L1069" title="All 2 branches missed.">            } else if (mBackgroundCall != null) {</span>
<span class="nc" id="L1070">              Map paramMap =</span>
<span class="nc" id="L1071">                  mGui4jCell.getParamMap(mGui4jController, row, column, false, mTableModel);</span>
<span class="nc" id="L1072">              paramMap.put(PARAM_VALUE, value);</span>
<span class="nc" id="L1073">              c.setBackground((Color) mBackgroundCall.getValue(mGui4jController, paramMap, null));</span>
            }
          }
        }
      }
<span class="nc bnc" id="L1078" title="All 2 branches missed.">      if (mFont != null) {</span>
<span class="nc" id="L1079">        c.setFont(mFont);</span>
      }
<span class="nc bnc" id="L1081" title="All 2 branches missed.">      if (c instanceof JLabel) {</span>
<span class="nc" id="L1082">        JLabel l = (JLabel) c;</span>
<span class="nc" id="L1083">        l.setHorizontalAlignment(mAlignment);</span>
<span class="nc" id="L1084">        String tooltip = mGui4jCell.getTooltip(mGui4jController, row, column, mTableModel);</span>
<span class="nc bnc" id="L1085" title="All 2 branches missed.">        if (&quot;&quot;.equals(tooltip)) {</span>
<span class="nc" id="L1086">          tooltip = null;</span>
        }
<span class="nc" id="L1088">        l.setToolTipText(tooltip);</span>
      }
<span class="nc" id="L1090">      return c;</span>
    }
  }

  // *************************************************************************************
  // TABLE MODEL
  // *************************************************************************************

<span class="nc" id="L1098">  public final class Gui4jTableModel extends RowHeaderAbstractTableModel</span>
      implements Gui4jTableListener, Enabled, Gui4jEventListener {
<span class="nc" id="L1100">    protected List mColumns = new ArrayList();</span>
<span class="nc" id="L1101">    protected List mRows = new ArrayList();</span>
    private boolean mUseCache;
    private Object[][] mCache;

    private Gui4jSwingContainer mGui4jSwingContainer;
    private Gui4jCallBase mGui4jController;
    private Gui4jComponentInstance mGui4jComponentInstance;
    private Gui4jJTable mTable;

    private Gui4jRow[] mGui4jRows;
    private Gui4jCol[] mGui4jCols;
    private Gui4jCell[][] mGui4jCells;

<span class="nc" id="L1114">    private boolean arraysAreValid = false;</span>
<span class="nc" id="L1115">    private boolean initialized = false;</span>
<span class="nc" id="L1116">    private int mPageNo = -1; // fr Drucken</span>
<span class="nc" id="L1117">    private boolean ignoreBackground = false; // fr Drucken ohne</span>

    // Hintergrund (=true)

    protected Gui4jTableModel(
<span class="nc" id="L1122">        Gui4jSwingContainer gui4jSwingContainer, Gui4jCallBase gui4jCallBase) {</span>
<span class="nc" id="L1123">      mGui4jSwingContainer = gui4jSwingContainer;</span>
<span class="nc" id="L1124">      mGui4jController = gui4jCallBase;</span>
<span class="nc" id="L1125">      mUseCache = mUseCacheDflt;</span>
<span class="nc" id="L1126">      clearCache();</span>
<span class="nc" id="L1127">    }</span>

    public Gui4jGetValue getAutomaticRefresh() {
<span class="nc bnc" id="L1130" title="All 4 branches missed.">      if (mAutomaticRefresh &amp;&amp; mTable != null) {</span>
<span class="nc" id="L1131">        return mTable.getAutomaticRefreshAction();</span>
      } else {
<span class="nc" id="L1133">        return null;</span>
      }
    }

    public void setIgnoreBackground(boolean flag) {
<span class="nc bnc" id="L1138" title="All 2 branches missed.">      if (flag != ignoreBackground) {</span>
<span class="nc" id="L1139">        ignoreBackground = flag;</span>
<span class="nc bnc" id="L1140" title="All 2 branches missed.">        if (mTable != null) {</span>
<span class="nc" id="L1141">          mTable.repaint();</span>
<span class="nc bnc" id="L1142" title="All 2 branches missed.">          if (mTable instanceof RowHeaderTable) {</span>
<span class="nc" id="L1143">            RowHeaderTable rowHeaderTable = (RowHeaderTable) mTable;</span>
<span class="nc" id="L1144">            rowHeaderTable.repaint();</span>
          }
        }
      }
<span class="nc" id="L1148">    }</span>

    public boolean ignoreBackground() {
<span class="nc" id="L1151">      return ignoreBackground;</span>
    }

    public void setInitialized() {
<span class="nc" id="L1155">      initialized = true;</span>
<span class="nc" id="L1156">    }</span>

    public void setRows(Collection rows) {
<span class="nc bnc" id="L1159" title="All 2 branches missed.">      if (rows != null) {</span>
<span class="nc" id="L1160">        mRows = new ArrayList(rows);</span>
      } else {
<span class="nc" id="L1162">        mRows = new ArrayList();</span>
      }
<span class="nc" id="L1164">      clearCache();</span>
<span class="nc" id="L1165">      refreshRows();</span>
<span class="nc" id="L1166">    }</span>

    public void setContent(Collection rows, Collection colummns) {
<span class="nc" id="L1169">      setColumns(colummns);</span>
<span class="nc" id="L1170">      setRows(rows);</span>
<span class="nc" id="L1171">    }</span>

    public void setColumns(Collection columns) {
<span class="nc" id="L1174">      mColumns = new ArrayList(columns);</span>
<span class="nc" id="L1175">      clearCache();</span>
<span class="nc" id="L1176">      refreshColumns(this);</span>
<span class="nc" id="L1177">    }</span>

    public void clearCache() {
<span class="nc bnc" id="L1180" title="All 2 branches missed.">      if (mUseCache) {</span>
<span class="nc" id="L1181">        mCache = new Object[mRows.size()][mColumns.size()];</span>
      } else {
<span class="nc" id="L1183">        mCache = null;</span>
      }
<span class="nc" id="L1185">    }</span>

    /**
     * @see org.gui4j.core.swing.RowHeaderTableModel#getRowName(int)
     */
    public String getRowName(int row) {
<span class="nc" id="L1191">      Gui4jRow gui4jRow = getGui4jRow(row);</span>
<span class="nc bnc" id="L1192" title="All 2 branches missed.">      return gui4jRow == null ? &quot;&quot; : gui4jRow.getName(mGui4jController, row, this);</span>
    }

    /**
     * @see javax.swing.table.TableModel#getColumnName(int)
     */
    public String getColumnName(int col) {
<span class="nc" id="L1199">      Gui4jCol gui4jCol = getGui4jCol(col);</span>
<span class="nc bnc" id="L1200" title="All 2 branches missed.">      if (gui4jCol != null) {</span>
<span class="nc" id="L1201">        String name = gui4jCol.getName(mGui4jController, col, this);</span>
<span class="nc bnc" id="L1202" title="All 4 branches missed.">        if (name == null || name.equals(&quot;&quot;)) {</span>
<span class="nc" id="L1203">          return name;</span>
        }
<span class="nc bnc" id="L1205" title="All 2 branches missed.">        if (name.startsWith(&quot;\n&quot;)) {</span>
<span class="nc" id="L1206">          return &quot; &quot; + name;</span>
        }
<span class="nc" id="L1208">        return name;</span>
      } else {
<span class="nc" id="L1210">        return &quot; &quot;;</span>
      }
    }

    /**
     * @see org.gui4j.core.swing.RowHeaderAbstractTableModel#setRowName(int, String)
     */
    public void setRowName(int rowNumber, String newName) {
      // nothing todo
<span class="nc" id="L1219">    }</span>

    /**
     * @see org.gui4j.core.swing.RowHeaderTableModel#setRowName(int, Object)
     */
    public void setRowName(int rowNumber, Object newName) {
      // nothing todo
<span class="nc" id="L1226">    }</span>

    /**
     * @see javax.swing.table.TableModel#getColumnCount()
     */
    public int getColumnCount() {
<span class="nc" id="L1232">      return mColumns.size();</span>
    }

    /**
     * @see javax.swing.table.TableModel#getRowCount()
     */
    public int getRowCount() {
<span class="nc" id="L1239">      return mRows.size();</span>
    }

    private Gui4jCell findByInheritance(Gui4jRow row, Gui4jCol col) {
<span class="nc" id="L1243">      final EncapsulateGui4jCell container = new EncapsulateGui4jCell();</span>
<span class="nc" id="L1244">      container.mGui4jCell = null;</span>
<span class="nc" id="L1245">      final Class rowClass = row.mClassType;</span>
<span class="nc" id="L1246">      final Class colClass = col.mClassType;</span>
      /*
       * mLogger.debug( &quot;Searching for rowClass = &quot; + rowClass.getName() + &quot;,
       * colClass = &quot; + colClass.getName());
       */
<span class="nc" id="L1251">      mCellManager.traverse(</span>
<span class="nc" id="L1252">          new SparseMatrix.Traverser() {</span>
            public void work(Object pRow, Object pCol, Object value) {
<span class="nc" id="L1254">              Class currentRowClass = ((Gui4jRow) pRow).mClassType;</span>
<span class="nc" id="L1255">              Class currentColClass = ((Gui4jCol) pCol).mClassType;</span>
<span class="nc" id="L1256">              Gui4jCell currentCell = (Gui4jCell) value;</span>
<span class="nc bnc" id="L1257" title="All 2 branches missed.">              if (currentRowClass.isAssignableFrom(rowClass)</span>
<span class="nc bnc" id="L1258" title="All 2 branches missed.">                  &amp;&amp; currentColClass.isAssignableFrom(colClass)) {</span>
<span class="nc bnc" id="L1259" title="All 2 branches missed.">                if (container.mGui4jCell != null) {</span>
<span class="nc" id="L1260">                  if (container</span>
                          .mGui4jCell
<span class="nc" id="L1262">                          .getGui4jRow()</span>
                          .mClassType
<span class="nc bnc" id="L1264" title="All 2 branches missed.">                          .isAssignableFrom(currentRowClass)</span>
                      &amp;&amp; container
                          .mGui4jCell
<span class="nc" id="L1267">                          .getGui4jCol()</span>
                          .mClassType
<span class="nc bnc" id="L1269" title="All 2 branches missed.">                          .isAssignableFrom(currentColClass)) {</span>
<span class="nc" id="L1270">                    container.mGui4jCell = currentCell;</span>
                    /*
                     * mLogger.debug( &quot;Using rowClass = &quot; +
                     * currentRowClass.getName() + &quot;, colClass = &quot; +
                     * currentColClass.getName());
                     */
                  }
                } else {
<span class="nc" id="L1278">                  container.mGui4jCell = currentCell;</span>
                  /*
                   * mLogger.debug( &quot;Using rowClass = &quot; +
                   * currentRowClass.getName() + &quot;, colClass = &quot; +
                   * currentColClass.getName());
                   */
                }
              }
<span class="nc" id="L1286">            }</span>
          });
<span class="nc" id="L1288">      return container.mGui4jCell;</span>
    }

    private void recompute() {
<span class="nc bnc" id="L1292" title="All 6 branches missed.">      if (!arraysAreValid &amp;&amp; mRows != null &amp;&amp; mColumns != null) {</span>
<span class="nc" id="L1293">        int rows = mRows.size();</span>
<span class="nc" id="L1294">        int cols = mColumns.size();</span>
<span class="nc" id="L1295">        int i = 0;</span>
<span class="nc" id="L1296">        mGui4jRows = new Gui4jRow[rows];</span>
<span class="nc bnc" id="L1297" title="All 2 branches missed.">        for (Iterator it = mRows.iterator(); it.hasNext(); i++) {</span>
<span class="nc" id="L1298">          Object object = it.next();</span>
<span class="nc bnc" id="L1299" title="All 2 branches missed.">          assert object != null;</span>
<span class="nc" id="L1300">          Gui4jRow gui4jRow = (Gui4jRow) mRowManager.get(object.getClass());</span>
<span class="nc bnc" id="L1301" title="All 2 branches missed.">          if (gui4jRow == null) {</span>
<span class="nc" id="L1302">            gui4jRow = new Gui4jRow(object.getClass(), null, null);</span>
<span class="nc" id="L1303">            mRowManager.add(object.getClass(), gui4jRow);</span>
          }
<span class="nc" id="L1305">          mGui4jRows[i] = gui4jRow;</span>
        }

<span class="nc" id="L1308">        i = 0;</span>
<span class="nc" id="L1309">        mGui4jCols = new Gui4jCol[cols];</span>
<span class="nc bnc" id="L1310" title="All 2 branches missed.">        for (Iterator it = mColumns.iterator(); it.hasNext(); i++) {</span>
<span class="nc" id="L1311">          Object object = it.next();</span>
<span class="nc bnc" id="L1312" title="All 2 branches missed.">          assert object != null;</span>
<span class="nc" id="L1313">          Gui4jCol gui4jCol = (Gui4jCol) mColManager.get(object.getClass());</span>
<span class="nc bnc" id="L1314" title="All 2 branches missed.">          if (gui4jCol == null) {</span>
<span class="nc" id="L1315">            gui4jCol = new Gui4jCol(object.getClass(), null, null, null, null);</span>
<span class="nc" id="L1316">            mColManager.add(object.getClass(), gui4jCol);</span>
          }
<span class="nc" id="L1318">          mGui4jCols[i] = gui4jCol;</span>
        }
<span class="nc" id="L1320">        mGui4jCells = new Gui4jCell[rows][cols];</span>
<span class="nc bnc" id="L1321" title="All 2 branches missed.">        for (int r = 0; r &lt; rows; r++) {</span>
<span class="nc bnc" id="L1322" title="All 2 branches missed.">          for (int c = 0; c &lt; cols; c++) {</span>
<span class="nc" id="L1323">            Gui4jRow gui4jRow = mGui4jRows[r];</span>
<span class="nc" id="L1324">            Gui4jCol gui4jCol = mGui4jCols[c];</span>
<span class="nc bnc" id="L1325" title="All 4 branches missed.">            if (gui4jRow != null &amp;&amp; gui4jCol != null) {</span>
<span class="nc" id="L1326">              Gui4jCell gui4jCell = (Gui4jCell) mCellManager.get(gui4jRow, gui4jCol);</span>
<span class="nc bnc" id="L1327" title="All 2 branches missed.">              if (gui4jCell == null) {</span>
<span class="nc" id="L1328">                gui4jCell = findByInheritance(gui4jRow, gui4jCol);</span>
              } else {
              }
<span class="nc bnc" id="L1331" title="All 2 branches missed.">              if (gui4jCell == null) {</span>
<span class="nc" id="L1332">                mLogger.debug(</span>
                    &quot;Creating 'on the fly' instance of Gui4jCell for (&quot;
<span class="nc" id="L1334">                        + mRows.get(r).getClass().getName()</span>
                        + &quot; gui4jRow=&quot;
<span class="nc" id="L1336">                        + gui4jRow.mClassType.getName()</span>
                        + &quot;, &quot;
<span class="nc" id="L1338">                        + mColumns.get(c).getClass().getName()</span>
                        + &quot; gui4jCol=&quot;
<span class="nc" id="L1340">                        + gui4jCol.mClassType.getName()</span>
                        + &quot;)&quot;);
                // mRows.get(r).getClass(),
                // mColumns.get(c).getClass(),
<span class="nc" id="L1344">                gui4jCell =</span>
                    new Gui4jCell(
                        gui4jRow.mClassType,
                        gui4jCol.mClassType,
                        null,
                        null,
                        null,
                        null,
                        null,
                        null,
                        null,
                        null,
                        null,
                        null,
                        null,
                        null,
                        null,
                        null,
                        null);
<span class="nc" id="L1363">                mCellManager.set(gui4jRow, gui4jCol, gui4jCell);</span>
              }
<span class="nc bnc" id="L1365" title="All 2 branches missed.">              if (mGui4jCells != null) {</span>
                // XXX
<span class="nc" id="L1367">                mGui4jCells[r][c] = gui4jCell;</span>
              }
            }
          }
        }
<span class="nc" id="L1372">        arraysAreValid = true;</span>
      }
<span class="nc" id="L1374">    }</span>

    private Gui4jRow getGui4jRow(int row) {
<span class="nc" id="L1377">      recompute();</span>
<span class="nc bnc" id="L1378" title="All 4 branches missed.">      assert row &gt;= 0 &amp;&amp; row &lt; mRows.size();</span>
<span class="nc bnc" id="L1379" title="All 2 branches missed.">      return mGui4jRows == null ? null : mGui4jRows[row];</span>
    }

    private Gui4jCol getGui4jCol(int col) {
<span class="nc" id="L1383">      recompute();</span>
<span class="nc bnc" id="L1384" title="All 4 branches missed.">      assert col &gt;= 0 &amp;&amp; col &lt; mColumns.size();</span>
<span class="nc" id="L1385">      return mGui4jCols[col];</span>
    }

    private Gui4jCell getGui4jCell(int row, int col) {
<span class="nc" id="L1389">      recompute();</span>
<span class="nc bnc" id="L1390" title="All 8 branches missed.">      if (row &gt;= 0 &amp;&amp; row &lt; mRows.size() &amp;&amp; col &gt;= 0 &amp;&amp; col &lt; mColumns.size()) {</span>
<span class="nc" id="L1391">        return mGui4jCells[row][col];</span>
      } else {
<span class="nc" id="L1393">        mLogger.error(</span>
            &quot;Invalid row or column index: row=&quot;
                + row
                + &quot;, col=&quot;
                + col
                + &quot;, rows=&quot;
<span class="nc" id="L1399">                + mRows.size()</span>
                + &quot;, cols=&quot;
<span class="nc" id="L1401">                + mColumns.size());</span>
<span class="nc" id="L1402">        return null;</span>
      }
    }

    public boolean isUsingCache() {
<span class="nc" id="L1407">      return mUseCache;</span>
    }

    public void setUseCache(boolean flag, int pageNo) {
<span class="nc" id="L1411">      mUseCache = flag;</span>
<span class="nc bnc" id="L1412" title="All 4 branches missed.">      if (!mUseCache || pageNo != mPageNo) {</span>
<span class="nc" id="L1413">        mPageNo = pageNo;</span>
<span class="nc" id="L1414">        clearCache();</span>
      }
<span class="nc" id="L1416">    }</span>

    /**
     * @see javax.swing.table.TableModel#getValueAt(int, int)
     */
    public Object getValueAt(int row, int col) {
<span class="nc bnc" id="L1422" title="All 8 branches missed.">      if (mUseCache &amp;&amp; mCache != null &amp;&amp; row &lt; mCache.length &amp;&amp; col &lt; mCache[row].length) {</span>
<span class="nc" id="L1423">        Object object = mCache[row][col];</span>
<span class="nc bnc" id="L1424" title="All 2 branches missed.">        if (object != null) {</span>
<span class="nc" id="L1425">          return object;</span>
        }
      }
<span class="nc" id="L1428">      Gui4jCell gui4jCell = getGui4jCell(row, col);</span>
      try {
        Object object =
<span class="nc bnc" id="L1431" title="All 2 branches missed.">            gui4jCell == null ? null : gui4jCell.getValue(mGui4jController, row, col, this);</span>
<span class="nc bnc" id="L1432" title="All 8 branches missed.">        if (mUseCache &amp;&amp; mCache != null &amp;&amp; row &lt; mCache.length &amp;&amp; col &lt; mCache[row].length) {</span>
<span class="nc" id="L1433">          mCache[row][col] = object;</span>
        }
<span class="nc" id="L1435">        return object;</span>
<span class="nc" id="L1436">      } catch (Throwable t) {</span>
<span class="nc" id="L1437">        getGui4j().handleException(mGui4jController, t, null);</span>
<span class="nc" id="L1438">        gui4jCell.invalidateCall();</span>
<span class="nc" id="L1439">        return null;</span>
      }
    }

    /**
     * @see javax.swing.table.TableModel#setValueAt(Object, int, int)
     */
    public void setValueAt(Object value, int row, int col) {
<span class="nc" id="L1447">      Gui4jCell gui4jCell = getGui4jCell(row, col);</span>
<span class="nc bnc" id="L1448" title="All 2 branches missed.">      if (gui4jCell != null) {</span>
<span class="nc" id="L1449">        gui4jCell.setValue(mGui4jController, row, col, value, this);</span>
      }
<span class="nc" id="L1451">    }</span>

    public int getRowIndex(Object object) {
<span class="nc" id="L1454">      return mRows.indexOf(object);</span>
    }

    public int getColumnIndex(Object object) {
<span class="nc" id="L1458">      return mColumns.indexOf(object);</span>
    }

    /**
     * @see javax.swing.table.TableModel#isCellEditable(int, int)
     */
    public boolean isCellEditable(int row, int col) {
<span class="nc bnc" id="L1465" title="All 4 branches missed.">      if (handleReadOnly() &amp;&amp; mGui4jSwingContainer.inReadOnlyMode()) {</span>
<span class="nc" id="L1466">        return false;</span>
      }
<span class="nc" id="L1468">      Gui4jCell cell = getGui4jCell(row, col);</span>
<span class="nc bnc" id="L1469" title="All 2 branches missed.">      if (cell != null) {</span>
<span class="nc" id="L1470">        return cell.isEditable(mGui4jController, row, col, this);</span>
      } else {
<span class="nc" id="L1472">        return true;</span>
      }
    }

    /**
     * @see org.gui4j.core.swing.Gui4jTableListener#getCellEditor(TableCellEditor, int, int)
     */
    public TableCellEditor getCellEditor(TableCellEditor editor, int row, int column) {
<span class="nc" id="L1480">      Gui4jCell cell = getGui4jCell(row, column);</span>
<span class="nc bnc" id="L1481" title="All 2 branches missed.">      return cell == null</span>
<span class="nc" id="L1482">          ? editor</span>
<span class="nc" id="L1483">          : cell.getCellEditor(</span>
              mGui4jController,
<span class="nc" id="L1485">              mGui4jComponentInstance.getSwingComponent().getFont(),</span>
              editor,
              row,
              column,
              this);
    }

    /**
     * @see org.gui4j.core.swing.Gui4jTableListener#getCellRenderer(TableCellRenderer, int, int)
     */
    public TableCellRenderer getCellRenderer(TableCellRenderer renderer, int row, int column) {
<span class="nc" id="L1496">      Gui4jCell cell = getGui4jCell(row, column);</span>
<span class="nc bnc" id="L1497" title="All 2 branches missed.">      return cell == null</span>
<span class="nc" id="L1498">          ? renderer</span>
<span class="nc" id="L1499">          : cell.getCellRenderer(</span>
              mGui4jComponentInstance,
<span class="nc" id="L1501">              mGui4jComponentInstance.getSwingComponent().getFont(),</span>
              renderer);
    }

    /**
     * @see org.gui4j.core.swing.Gui4jTableListener#prepareEditor(TableCellEditor, int, int)
     */
    public void prepareEditor(TableCellEditor editor, int row, int column) {
<span class="nc" id="L1509">      Gui4jCell cell = getGui4jCell(row, column);</span>
<span class="nc bnc" id="L1510" title="All 2 branches missed.">      if (cell != null) {</span>
<span class="nc" id="L1511">        cell.prepareEditor(mGui4jController, editor, row, column, this);</span>
      }
<span class="nc" id="L1513">    }</span>

    public void handleOnCellSelect(
        int row, int col, Gui4jCallBase gui4jController, Gui4jThreadManager gui4jThreadManager) {
<span class="nc" id="L1517">      Gui4jCell cell = getGui4jCell(row, col);</span>
<span class="nc bnc" id="L1518" title="All 2 branches missed.">      if (cell != null) {</span>
<span class="nc" id="L1519">        cell.handleOnCellSelect(row, col, gui4jController, gui4jThreadManager, this);</span>
      }
<span class="nc" id="L1521">    }</span>

    public void handleOnCellClick(
        int row, int col, Gui4jCallBase gui4jController, Gui4jThreadManager gui4jThreadManager) {
<span class="nc" id="L1525">      Gui4jCell cell = getGui4jCell(row, col);</span>
<span class="nc bnc" id="L1526" title="All 2 branches missed.">      if (cell != null) {</span>
<span class="nc" id="L1527">        cell.handleOnCellClick(row, col, gui4jController, gui4jThreadManager, this);</span>
      }
<span class="nc" id="L1529">    }</span>

    public void handleOnCellDblClick(
        int row, int col, Gui4jCallBase gui4jController, Gui4jThreadManager gui4jThreadManager) {
<span class="nc" id="L1533">      Gui4jCell cell = getGui4jCell(row, col);</span>
<span class="nc bnc" id="L1534" title="All 2 branches missed.">      if (cell != null) {</span>
<span class="nc" id="L1535">        cell.handleOnCellDblClick(row, col, gui4jController, gui4jThreadManager, this);</span>
      }
<span class="nc" id="L1537">    }</span>

    public void setGui4jComponentInstance(Gui4jComponentInstance gui4jComponentInstance) {
<span class="nc" id="L1540">      mGui4jComponentInstance = gui4jComponentInstance;</span>
<span class="nc" id="L1541">      mTable = (Gui4jJTable) mGui4jComponentInstance.getSwingComponent();</span>
<span class="nc" id="L1542">    }</span>

    protected void refreshColumns(Gui4jTableModel model) {
<span class="nc bnc" id="L1545" title="All 2 branches missed.">      if (mTable != null) {</span>
        // Tabelle noch nicht zerstoert
<span class="nc bnc" id="L1547" title="All 2 branches missed.">        if (!initialized) {</span>
<span class="nc" id="L1548">          return;</span>
        }
<span class="nc" id="L1550">        arraysAreValid = false;</span>
        // mLogger.debug(&quot;Refreshing columns of table &quot; + getId() + &quot;
        // count = &quot; + mColumns.size());
        // mTable.setModel(this);
<span class="nc" id="L1554">        mTable.createDefaultColumnsFromModel();</span>
        // fireTableStructureChanged();
<span class="nc" id="L1556">        Font font = mTable.getFont();</span>
<span class="nc" id="L1557">        JTableHeader tableHeader = mTable.getTableHeader();</span>

<span class="nc" id="L1559">        double sumWeight = 0.0;</span>
<span class="nc" id="L1560">        int sumWidth = 0;</span>

<span class="nc bnc" id="L1562" title="All 2 branches missed.">        if (tableHeader != null) {</span>

<span class="nc" id="L1564">          double headerHeight = tableHeader.getPreferredSize().getHeight();</span>
<span class="nc bnc" id="L1565" title="All 2 branches missed.">          for (int c = 0; c &lt; mColumns.size(); c++) {</span>
<span class="nc" id="L1566">            Gui4jCol gui4jCol = getGui4jCol(c);</span>
<span class="nc" id="L1567">            TableColumn tableColumn = mTable.getColumnModel().getColumn(c);</span>
<span class="nc" id="L1568">            sumWidth += tableColumn.getPreferredWidth();</span>
<span class="nc" id="L1569">            sumWeight += gui4jCol.getWeight();</span>
<span class="nc" id="L1570">            String name = gui4jCol.getName(mGui4jController, c, this);</span>
<span class="nc" id="L1571">            TableCellRenderer renderer = tableHeader.getDefaultRenderer();</span>
<span class="nc bnc" id="L1572" title="All 2 branches missed.">            if (renderer != null) {</span>
<span class="nc bnc" id="L1573" title="All 4 branches missed.">              if (name != null &amp;&amp; name.startsWith(&quot;\n&quot;)) {</span>
<span class="nc" id="L1574">                name = &quot;XXX&quot; + name;</span>
              }
<span class="nc" id="L1576">              JLabel label = new JLabel(name);</span>
<span class="nc" id="L1577">              label.setFont(font);</span>
<span class="nc" id="L1578">              label.setUI(MultiLineLabelUI.getInstance());</span>
<span class="nc" id="L1579">              double height = label.getPreferredSize().getHeight() + 4;</span>
<span class="nc bnc" id="L1580" title="All 2 branches missed.">              if (height &gt; headerHeight) {</span>
<span class="nc" id="L1581">                headerHeight = height;</span>
              }
            }
          }
          {
<span class="nc" id="L1586">            Dimension d = new Dimension(tableHeader.getPreferredSize());</span>
<span class="nc" id="L1587">            d.height = (int) headerHeight;</span>

            // workaround for bug in swing
            // resizing does not work if we have horizontal
            // scrollbars
<span class="nc bnc" id="L1592" title="All 2 branches missed.">            if (mResizeMode != JTable.AUTO_RESIZE_OFF) {</span>
<span class="nc" id="L1593">              tableHeader.setPreferredSize(d);</span>
            }
          }
        }
        {
<span class="nc bnc" id="L1598" title="All 2 branches missed.">          for (int c = 0; c &lt; mColumns.size(); c++) {</span>
<span class="nc" id="L1599">            Gui4jCol gui4jCol = getGui4jCol(c);</span>
<span class="nc" id="L1600">            TableColumn tableColumn = mTable.getColumnModel().getColumn(c);</span>
<span class="nc" id="L1601">            double weight = gui4jCol.getWeight();</span>
<span class="nc bnc" id="L1602" title="All 2 branches missed.">            if (gui4jCol.maxCharactersDefined()) {</span>
<span class="nc" id="L1603">              int width =</span>
                  mTable
<span class="nc" id="L1605">                      .getFontMetrics(font)</span>
<span class="nc" id="L1606">                      .stringWidth(</span>
<span class="nc" id="L1607">                          StringUtil.copy('M', gui4jCol.getMaxCharacters(mGui4jController)));</span>
<span class="nc" id="L1608">              tableColumn.setMaxWidth(width);</span>
<span class="nc" id="L1609">              tableColumn.setPreferredWidth(width);</span>
<span class="nc bnc" id="L1610" title="All 2 branches missed.">            } else if (gui4jCol.charactersDefined()) {</span>
<span class="nc" id="L1611">              int width =</span>
                  mTable
<span class="nc" id="L1613">                      .getFontMetrics(font)</span>
<span class="nc" id="L1614">                      .stringWidth(StringUtil.copy('M', gui4jCol.getCharacters(mGui4jController)));</span>
<span class="nc" id="L1615">              tableColumn.setPreferredWidth(width);</span>
<span class="nc" id="L1616">            } else {</span>
<span class="nc" id="L1617">              tableColumn.setPreferredWidth((int) (sumWidth * weight / sumWeight));</span>
            }
          }
        }
      }
<span class="nc" id="L1622">    }</span>

    public void dispose() {
<span class="nc" id="L1625">      mTable = null;</span>
<span class="nc" id="L1626">      mGui4jRows = null;</span>
<span class="nc" id="L1627">      mGui4jCols = null;</span>
<span class="nc" id="L1628">      mGui4jCells = null;</span>
<span class="nc" id="L1629">      mGui4jController = null;</span>
<span class="nc" id="L1630">      mGui4jSwingContainer = null;</span>
<span class="nc" id="L1631">      mColumns.clear();</span>
<span class="nc" id="L1632">      mRows.clear();</span>
<span class="nc" id="L1633">      mGui4jComponentInstance = null;</span>
<span class="nc" id="L1634">      mTable = null;</span>
<span class="nc" id="L1635">    }</span>

    protected void refreshRows() {
<span class="nc" id="L1638">      arraysAreValid = false;</span>
      // mLogger.debug(&quot;Refreshing rows of table &quot; + getId() + &quot; count = &quot;
      // + mRows.size());
<span class="nc" id="L1641">      Font font = mTable.getFont();</span>
<span class="nc bnc" id="L1642" title="All 2 branches missed.">      if (mUseRowHeaders) {</span>
<span class="nc" id="L1643">        JLabel label = new JLabel();</span>
<span class="nc" id="L1644">        label.setFont(font);</span>
<span class="nc" id="L1645">        int preferredWidth = 10;</span>
<span class="nc bnc" id="L1646" title="All 2 branches missed.">        for (int i = 0; i &lt; mRows.size(); i++) {</span>
<span class="nc" id="L1647">          label.setText(getRowName(i));</span>
<span class="nc" id="L1648">          int width = label.getPreferredSize().width + 8;</span>
<span class="nc bnc" id="L1649" title="All 2 branches missed.">          if (width &gt; preferredWidth) {</span>
<span class="nc" id="L1650">            preferredWidth = width;</span>
          }
        }
<span class="nc" id="L1653">        RowHeaderTable ctable = (RowHeaderTable) mTable;</span>
<span class="nc bnc" id="L1654" title="All 2 branches missed.">        if (ctable != null) {</span>
<span class="nc" id="L1655">          ctable.setRowHeaderWidth(preferredWidth);</span>
<span class="nc" id="L1656">          ctable.setRowHeaderFont(font);</span>
<span class="nc" id="L1657">          ctable.setRowHeaderHeight(mTable.getRowHeight());</span>
<span class="nc" id="L1658">          ctable.refreshRowHeaders();</span>
        }
      }

<span class="nc" id="L1662">      fireTableDataChanged();</span>
<span class="nc" id="L1663">    }</span>

    /**
     * @see org.gui4j.component.Gui4jMatrix.Enabled#isEnabled(int, int)
     */
    public boolean isEnabled(int row, int column) {
<span class="nc" id="L1669">      Gui4jCell gui4jCell = getGui4jCell(row, column);</span>
<span class="nc bnc" id="L1670" title="All 2 branches missed.">      if (gui4jCell != null) {</span>
<span class="nc" id="L1671">        return gui4jCell.isEnabled(mGui4jController, row, column, this);</span>
      } else {
<span class="nc" id="L1673">        return true;</span>
      }
    }

    /**
     * @see org.gui4j.event.Gui4jEventListener#eventOccured()
     */
    public void eventOccured() {
<span class="nc" id="L1681">      Runnable run =</span>
<span class="nc" id="L1682">          new Runnable() {</span>
            public void run() {
<span class="nc" id="L1684">              clearCache();</span>
<span class="nc" id="L1685">              fireTableRowsUpdated(0, getRowCount() - 1);</span>
<span class="nc" id="L1686">            }</span>
          };
<span class="nc" id="L1688">      Gui4jThreadManager.executeInSwingThreadAndWait(run);</span>
<span class="nc" id="L1689">    }</span>
  }

  private static class Flag {
    boolean val;
  }

  private static class EncapsulateGui4jCell {
    protected Gui4jCell mGui4jCell;
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>