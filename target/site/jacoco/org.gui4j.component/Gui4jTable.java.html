<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Gui4jTable.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">gui4j</a> &gt; <a href="index.source.html" class="el_package">org.gui4j.component</a> &gt; <span class="el_source">Gui4jTable.java</span></div><h1>Gui4jTable.java</h1><pre class="source lang-java linenums">package org.gui4j.component;

import java.awt.Color;
import java.awt.Component;
import java.awt.Dimension;
import java.awt.Font;
import java.awt.Point;
import java.awt.Rectangle;
import java.awt.event.ActionEvent;
import java.awt.event.KeyEvent;
import java.awt.event.MouseEvent;
import java.io.Serializable;
import java.util.ArrayList;
import java.util.Collection;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import javax.swing.AbstractAction;
import javax.swing.Icon;
import javax.swing.JComponent;
import javax.swing.JLabel;
import javax.swing.JTable;
import javax.swing.KeyStroke;
import javax.swing.ListSelectionModel;
import javax.swing.SwingConstants;
import javax.swing.table.DefaultTableCellRenderer;
import javax.swing.table.JTableHeader;
import javax.swing.table.TableCellEditor;
import javax.swing.table.TableCellRenderer;
import javax.swing.table.TableColumn;
import javax.swing.table.TableColumnModel;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.gui4j.Gui4jCallBase;
import org.gui4j.Gui4jGetValue;
import org.gui4j.component.util.StringUtil;
import org.gui4j.constants.Const;
import org.gui4j.core.Gui4jCall;
import org.gui4j.core.Gui4jComponentContainer;
import org.gui4j.core.Gui4jComponentInstance;
import org.gui4j.core.Gui4jMap1;
import org.gui4j.core.Gui4jMouseListener;
import org.gui4j.core.Gui4jQualifiedComponent;
import org.gui4j.core.Gui4jSwingContainer;
import org.gui4j.core.Gui4jTextAttribute;
import org.gui4j.core.Gui4jThreadManager;
import org.gui4j.core.Gui4jTypeManager;
import org.gui4j.core.listener.Gui4jMouseListenerTable;
import org.gui4j.core.listener.Gui4jMouseListenerTablePopup;
import org.gui4j.core.swing.BooleanTableCellRenderer;
import org.gui4j.core.swing.ColumnGroup;
import org.gui4j.core.swing.ComboBoxCellEdit;
import org.gui4j.core.swing.GroupableTableHeader;
import org.gui4j.core.swing.Gui4jCellEditor;
import org.gui4j.core.swing.Gui4jJTable;
import org.gui4j.core.swing.Gui4jJTableHeader;
import org.gui4j.core.swing.Gui4jRefreshTable;
import org.gui4j.core.swing.Gui4jTableListener;
import org.gui4j.core.swing.MultiLineLabelUI;
import org.gui4j.core.swing.RowHeaderAbstractTableModel;
import org.gui4j.core.swing.RowHeaderTable;
import org.gui4j.core.swing.RowRetriever;
import org.gui4j.core.util.ComboBoxNullItem;
import org.gui4j.event.Gui4jEventListener;
import org.gui4j.exception.Gui4jUncheckedException;
import org.gui4j.util.Pair;

public final class Gui4jTable extends Gui4jJComponent {

<span class="nc" id="L71">  protected static final Log mLogger = LogFactory.getLog(Gui4jTable.class);</span>

  protected final ColumnManager mColumnManager;
  protected final Class mDefaultType;
  private final Gui4jTypeManager mOnCellSelect; // Class -&gt; Gui4jCall
  private final Gui4jTypeManager mOnRowSelect; // Class -&gt; Gui4jCall
  private final Gui4jTypeManager mOnColSelect; // Class -&gt; Gui4jCall
  private final Gui4jTypeManager mOnDoubleClick; // Class -&gt; Gui4jCall
  private final Gui4jTypeManager mPopupContext; // Class -&gt; Gui4jCall
  protected final Gui4jTypeManager mRowManager; // Class -&gt; Gui4jCall
  private Gui4jCall[] mRefresh;
  protected Gui4jCall mOnSetValue;
  protected Gui4jCall mCellSelectionPair;
  protected Gui4jCall mRowSelectionIndex;
  protected Gui4jCall mRowSelectionItem;
  protected Gui4jCall mHeaderBackground;
  protected Gui4jCall mActionCommand;
  protected Gui4jCall mRowHeaderCharacters;
  protected boolean mHideFocus;
  private final int mVisibleRows;
  protected final boolean mAutomaticVisibleRows;
  protected final boolean mAutomaticRefresh;
  protected final boolean mUseRowHeaders;
  private final int mHeaderLines;
<span class="nc" id="L95">  private boolean mReorderingAllowed = true;</span>
<span class="nc" id="L96">  protected boolean mRowSelectionAllowed = true;</span>
<span class="nc" id="L97">  private int mRowSelectionMode = ListSelectionModel.SINGLE_SELECTION;</span>
<span class="nc" id="L98">  private int mColSelectionMode = ListSelectionModel.SINGLE_SELECTION;</span>
  private List mColumnGroups; // List(Gui4jColumnHeaderTable)

  private int mResizeMode;

  /**
   * @param gui4jComponentContainer
   * @param id
   * @param visibleRows
   * @param headerLines
   * @param defaultType
   * @param automaticVisibleRows
   * @param automaticRefresh
   * @param useOriginalCollection
   * @param useRowHeaders
   * @param resizeMode
   */
  public Gui4jTable(
      Gui4jComponentContainer gui4jComponentContainer,
      String id,
      int visibleRows,
      int headerLines,
      Class defaultType,
      boolean automaticVisibleRows,
      boolean automaticRefresh,
      boolean useOriginalCollection,
      boolean useRowHeaders,
      int resizeMode) {
<span class="nc" id="L126">    super(gui4jComponentContainer, Gui4jJTable.class, id);</span>
<span class="nc" id="L127">    mColumnManager = new ColumnManager(defaultType);</span>
<span class="nc" id="L128">    mVisibleRows = visibleRows;</span>
<span class="nc" id="L129">    mHeaderLines = headerLines;</span>
<span class="nc" id="L130">    mDefaultType = defaultType;</span>
<span class="nc" id="L131">    mAutomaticVisibleRows = automaticVisibleRows;</span>
<span class="nc" id="L132">    mAutomaticRefresh = automaticRefresh;</span>
<span class="nc" id="L133">    mUseRowHeaders = useRowHeaders;</span>
<span class="nc" id="L134">    mResizeMode = resizeMode;</span>

<span class="nc" id="L136">    mOnCellSelect = new Gui4jTypeManager();</span>
<span class="nc" id="L137">    mOnRowSelect = new Gui4jTypeManager();</span>
<span class="nc" id="L138">    mOnColSelect = new Gui4jTypeManager();</span>
<span class="nc" id="L139">    mOnDoubleClick = new Gui4jTypeManager();</span>
<span class="nc" id="L140">    mPopupContext = new Gui4jTypeManager();</span>
<span class="nc" id="L141">    mRowManager = new Gui4jTypeManager();</span>
<span class="nc" id="L142">    mColumnGroups = new ArrayList();</span>
<span class="nc" id="L143">  }</span>

  protected void setProperties(Gui4jComponentInstance gui4jComponentInstance) {
<span class="nc" id="L146">    super.setProperties(gui4jComponentInstance);</span>
<span class="nc" id="L147">    final Gui4jCallBase gui4jCallBase = gui4jComponentInstance.getGui4jCallBase();</span>
<span class="nc" id="L148">    Gui4jJTable table = (Gui4jJTable) gui4jComponentInstance.getComponent();</span>
<span class="nc" id="L149">    Gui4jTableModel model = (Gui4jTableModel) table.getModel();</span>
<span class="nc" id="L150">    table.setAutoResizeMode(mResizeMode);</span>

<span class="nc" id="L152">    Font font = table.getFont();</span>

<span class="nc" id="L154">    table.setDefaultEditor(String.class, Gui4jCellEditor.createTextEditor(font, true));</span>

    {
<span class="nc" id="L157">      JLabel l = new JLabel(&quot;X&quot;);</span>
<span class="nc" id="L158">      l.setFont(font);</span>
<span class="nc" id="L159">      table.setRowHeight(l.getPreferredSize().height + 4);</span>
    }
<span class="nc" id="L161">    setHeader(gui4jComponentInstance.getGui4jCallBase(), table);</span>
<span class="nc" id="L162">    JTableHeader tableHeader = table.getTableHeader();</span>

<span class="nc" id="L164">    Color headerBackground = null;</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">    if (mHeaderBackground != null) {</span>
<span class="nc" id="L166">      headerBackground =</span>
          (Color)
<span class="nc" id="L168">              mHeaderBackground.getValueNoParams(gui4jComponentInstance.getGui4jCallBase(), null);</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">      if (headerBackground != null) {</span>
<span class="nc" id="L170">        tableHeader.setBackground(headerBackground);</span>
      }
    }

<span class="nc" id="L174">    table.setTableHeader(tableHeader);</span>

    // JTableHeader tableHeader = table.getTableHeader();
<span class="nc" id="L177">    tableHeader.setReorderingAllowed(mReorderingAllowed);</span>
    {
<span class="nc" id="L179">      TableCellRenderer renderer = tableHeader.getDefaultRenderer();</span>
<span class="nc" id="L180">      tableHeader.setFont(font);</span>
<span class="nc" id="L181">      Component c = renderer.getTableCellRendererComponent(table, &quot;&quot;, false, false, 0, 0);</span>
<span class="nc bnc" id="L182" title="All 4 branches missed.">      if (mHeaderLines == 1 &amp;&amp; c instanceof JLabel) {</span>
<span class="nc" id="L183">        ((JLabel) c).setUI(MultiLineLabelUI.getInstance());</span>
      }
    }
<span class="nc bnc" id="L186" title="All 2 branches missed.">    if (mUseRowHeaders) {</span>
<span class="nc" id="L187">      JLabel label = new JLabel();</span>
<span class="nc" id="L188">      label.setFont(font);</span>
<span class="nc" id="L189">      RowHeaderTable ctable = (RowHeaderTable) table;</span>
<span class="nc" id="L190">      ctable.setRowHeaderFont(font);</span>
<span class="nc" id="L191">      ctable.setRowHeaderHeight(table.getRowHeight());</span>

<span class="nc" id="L193">      model.refreshRows(false);</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">      if (headerBackground != null) {</span>
<span class="nc" id="L195">        ((RowHeaderTable.RowHeaderRenderer) ctable.getRowHeader().getCellRenderer())</span>
<span class="nc" id="L196">            .setBackground(headerBackground);</span>
      }
    }

<span class="nc bnc" id="L200" title="All 2 branches missed.">    if (mOnRowSelect.size() &gt; 0) {</span>
<span class="nc" id="L201">      Gui4jMouseListenerTable mouseListener =</span>
          new Gui4jMouseListenerTable(gui4jComponentInstance, 1, mDefaultType, mOnRowSelect);
<span class="nc" id="L203">      model.addListener(mouseListener);</span>
<span class="nc" id="L204">      table.getSelectionModel().addListSelectionListener(mouseListener);</span>
    }
<span class="nc bnc" id="L206" title="All 2 branches missed.">    if (mOnCellSelect.size() &gt; 0) {</span>
<span class="nc" id="L207">      Gui4jMouseListenerTable mouseListener =</span>
          new Gui4jMouseListenerTable(gui4jComponentInstance, 1, mDefaultType, mOnCellSelect);
<span class="nc" id="L209">      model.addListener(mouseListener);</span>
<span class="nc" id="L210">      table.getSelectionModel().addListSelectionListener(mouseListener);</span>
<span class="nc" id="L211">      table.getColumnModel().getSelectionModel().addListSelectionListener(mouseListener);</span>
    }
<span class="nc bnc" id="L213" title="All 2 branches missed.">    if (mOnColSelect.size() &gt; 0) {</span>
<span class="nc" id="L214">      Gui4jMouseListenerTable mouseListener =</span>
          new Gui4jMouseListenerTable(gui4jComponentInstance, 1, mDefaultType, mOnColSelect);
<span class="nc" id="L216">      model.addListener(mouseListener);</span>
<span class="nc" id="L217">      table.getColumnModel().getSelectionModel().addListSelectionListener(mouseListener);</span>
    }
<span class="nc bnc" id="L219" title="All 2 branches missed.">    if (mOnDoubleClick.size() &gt; 0) {</span>
<span class="nc" id="L220">      Gui4jMouseListenerTable mouseListener =</span>
          new Gui4jMouseListenerTable(gui4jComponentInstance, 2, mDefaultType, mOnDoubleClick);
<span class="nc" id="L222">      model.addListener(mouseListener);</span>
<span class="nc" id="L223">      table.addMouseListener(mouseListener);</span>
    }
<span class="nc bnc" id="L225" title="All 2 branches missed.">    if (mActionCommand != null) {</span>
<span class="nc" id="L226">      table.getInputMap().put(KeyStroke.getKeyStroke(KeyEvent.VK_ENTER, 0), &quot;actionCommand&quot;);</span>
<span class="nc" id="L227">      table</span>
<span class="nc" id="L228">          .getActionMap()</span>
<span class="nc" id="L229">          .put(</span>
              &quot;actionCommand&quot;,
<span class="nc" id="L231">              new AbstractAction() {</span>
                public void actionPerformed(ActionEvent e) {
<span class="nc" id="L233">                  getGui4j()</span>
<span class="nc" id="L234">                      .getGui4jThreadManager()</span>
<span class="nc" id="L235">                      .performWork(gui4jCallBase, mActionCommand, null);</span>
<span class="nc" id="L236">                }</span>
              });
    }
<span class="nc bnc" id="L239" title="All 2 branches missed.">    if (mRowManager.size() &gt; 0) {}</span>

<span class="nc" id="L241">    int sumWidth = 0;</span>
<span class="nc" id="L242">    double sumWeight = 0.0;</span>

    {
<span class="nc" id="L245">      int columnIndex = 0;</span>
<span class="nc" id="L246">      double headerHeight = tableHeader.getPreferredSize().getHeight();</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">      for (Iterator it = mColumnManager.getMainColumns().iterator(); it.hasNext(); columnIndex++) {</span>
<span class="nc" id="L248">        Gui4jColumnTable gui4jColumn = (Gui4jColumnTable) it.next();</span>
<span class="nc" id="L249">        TableColumn tableColumn = table.getColumnModel().getColumn(columnIndex);</span>
<span class="nc" id="L250">        sumWidth += tableColumn.getPreferredWidth();</span>
<span class="nc" id="L251">        sumWeight += gui4jColumn.getWeight();</span>
<span class="nc" id="L252">        String name = gui4jColumn.getName(gui4jCallBase);</span>
<span class="nc" id="L253">        TableCellRenderer renderer = tableHeader.getDefaultRenderer();</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">        if (renderer != null) {</span>
<span class="nc" id="L255">          JLabel label = new JLabel(name);</span>
<span class="nc" id="L256">          label.setFont(font);</span>
<span class="nc" id="L257">          label.setUI(MultiLineLabelUI.getInstance());</span>
<span class="nc" id="L258">          double height = label.getPreferredSize().getHeight() + 4;</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">          if (height &gt; headerHeight) {</span>
<span class="nc" id="L260">            headerHeight = height;</span>
          }
        }
      }

      {
<span class="nc" id="L266">        Dimension d = tableHeader.getPreferredSize();</span>
<span class="nc" id="L267">        d.height = (int) headerHeight;</span>

        // workaround for bug in swing
        // resizing does not work if we have horizontal scrollbars
<span class="nc bnc" id="L271" title="All 2 branches missed.">        if (mResizeMode != JTable.AUTO_RESIZE_OFF) {</span>
<span class="nc" id="L272">          tableHeader.setPreferredSize(d);</span>
        }
      }
    }

    {
<span class="nc" id="L278">      int columnIndex = 0;</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">      for (Iterator it = mColumnManager.getMainColumns().iterator(); it.hasNext(); columnIndex++) {</span>
<span class="nc" id="L280">        Gui4jColumnTable gui4jColumn = (Gui4jColumnTable) it.next();</span>
<span class="nc" id="L281">        TableColumn tableColumn = table.getColumnModel().getColumn(columnIndex);</span>
<span class="nc" id="L282">        TableCellEditor editor = gui4jColumn.createEditor(gui4jCallBase, font);</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">        if (gui4jColumn.isMainColumn()) {</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">          if (editor != null) {</span>
<span class="nc" id="L285">            tableColumn.setCellEditor(editor);</span>
          }
<span class="nc" id="L287">          double weight = gui4jColumn.getWeight();</span>
<span class="nc bnc" id="L288" title="All 2 branches missed.">          if (gui4jColumn.isMaxCharactersAttributeDefined()) {</span>
<span class="nc" id="L289">            int width =</span>
                table
<span class="nc" id="L291">                    .getFontMetrics(font)</span>
<span class="nc" id="L292">                    .stringWidth(StringUtil.copy('M', gui4jColumn.getMaxCharacters(gui4jCallBase)));</span>
<span class="nc" id="L293">            tableColumn.setMaxWidth(width);</span>
<span class="nc" id="L294">            tableColumn.setPreferredWidth(width);</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">          } else if (gui4jColumn.isCharactersAttributeDefined()) {</span>
<span class="nc" id="L296">            int width =</span>
                table
<span class="nc" id="L298">                    .getFontMetrics(font)</span>
<span class="nc" id="L299">                    .stringWidth(StringUtil.copy('M', gui4jColumn.getCharacters(gui4jCallBase)));</span>
<span class="nc" id="L300">            tableColumn.setPreferredWidth(width);</span>
<span class="nc" id="L301">          } else {</span>
<span class="nc" id="L302">            tableColumn.setPreferredWidth((int) (sumWidth * weight / sumWeight));</span>
          }
        }
      }
    }
<span class="nc bnc" id="L307" title="All 2 branches missed.">    if (mAutomaticVisibleRows) {</span>
<span class="nc" id="L308">      Dimension d = new Dimension(table.getPreferredSize());</span>
<span class="nc" id="L309">      int rows = table.getRowCount();</span>
<span class="nc bnc" id="L310" title="All 4 branches missed.">      if (mVisibleRows != -1 &amp;&amp; rows &gt; mVisibleRows) {</span>
<span class="nc" id="L311">        rows = mVisibleRows;</span>
      }
<span class="nc" id="L313">      d.setSize(d.getWidth(), table.getRowHeight() * rows);</span>
<span class="nc" id="L314">      table.setPreferredScrollableViewportSize(d);</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">    } else if (mVisibleRows != -1) {</span>
<span class="nc" id="L316">      Dimension d = new Dimension(table.getPreferredSize());</span>
<span class="nc" id="L317">      d.setSize(d.getWidth(), table.getRowHeight() * mVisibleRows);</span>
<span class="nc" id="L318">      table.setPreferredScrollableViewportSize(d);</span>
    }

<span class="nc bnc" id="L321" title="All 2 branches missed.">    if (getGui4j().traceMode()) {</span>
<span class="nc" id="L322">      mLogger.debug(</span>
<span class="nc" id="L323">          &quot;Preferred size of table with id &quot; + getId() + &quot; is &quot; + table.getPreferredSize());</span>
<span class="nc" id="L324">      mLogger.debug(</span>
          &quot;Preferred scrollable viewport size of table with id &quot;
<span class="nc" id="L326">              + getId()</span>
              + &quot; is &quot;
<span class="nc" id="L328">              + table.getPreferredScrollableViewportSize());</span>
    }

<span class="nc bnc" id="L331" title="All 2 branches missed.">    if (!model.setSelection()) {</span>
<span class="nc bnc" id="L332" title="All 4 branches missed.">      if (mRowSelectionAllowed &amp;&amp; table.getRowCount() &gt; 0) {</span>
<span class="nc" id="L333">        table.setRowSelectionInterval(0, 0);</span>
      }
    }

<span class="nc bnc" id="L337" title="All 2 branches missed.">    if (mPopupContext.size() &gt; 0) {</span>
<span class="nc" id="L338">      model.mPopupHandler =</span>
          new Gui4jMouseListenerTable(gui4jComponentInstance, 0, mDefaultType, mPopupContext);
    }
<span class="nc" id="L341">  }</span>

  protected Gui4jComponentInstance createComponentInstance(
      Gui4jSwingContainer gui4jSwingContainer,
      Gui4jCallBase gui4jCallBase,
      Gui4jQualifiedComponent gui4jComponentInPath) {
<span class="nc" id="L347">    Gui4jTableModel tm = new Gui4jTableModel(gui4jSwingContainer, gui4jCallBase);</span>
<span class="nc" id="L348">    registerEvents(gui4jSwingContainer, gui4jCallBase, mRefresh, tm);</span>

    // Tabelle erzeugen
    Gui4jJTable table;
<span class="nc bnc" id="L352" title="All 2 branches missed.">    if (!mUseRowHeaders) {</span>
<span class="nc" id="L353">      table = new Gui4jJTable(tm, tm);</span>
    } else {
<span class="nc" id="L355">      table = new RowHeaderTable(tm, tm);</span>
    }

<span class="nc" id="L358">    table.getSelectionModel().setSelectionMode(mRowSelectionMode);</span>
<span class="nc" id="L359">    TableColumnModel tcm = table.getColumnModel();</span>
<span class="nc" id="L360">    tcm.getSelectionModel().setSelectionMode(mColSelectionMode);</span>
<span class="nc" id="L361">    table.setRowSelectionAllowed(mRowSelectionAllowed);</span>
<span class="nc" id="L362">    Gui4jComponentInstance gui4jComponentInstance =</span>
        new Gui4jComponentInstance(gui4jSwingContainer, table, gui4jComponentInPath);
<span class="nc" id="L364">    tm.setGui4jComponentInstance(gui4jComponentInstance);</span>

<span class="nc" id="L366">    TableCellRenderer renderer =</span>
<span class="nc" id="L367">        new CellRenderer(gui4jComponentInstance, mColumnManager.getMainColumns(), tm);</span>
<span class="nc" id="L368">    table.setDefaultRenderer(String.class, renderer);</span>
<span class="nc" id="L369">    table.setDefaultRenderer(Boolean.class, renderer);</span>
<span class="nc" id="L370">    table.setDefaultRenderer(Icon.class, renderer);</span>

<span class="nc" id="L372">    return gui4jComponentInstance;</span>
  }

  private void setHeader(Gui4jCallBase gui4jCallBase, JTable table) {
<span class="nc" id="L376">    TableColumnModel tcm = table.getColumnModel();</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">    if (mColumnGroups.isEmpty()) {</span>
<span class="nc" id="L378">      table.setTableHeader(</span>
<span class="nc" id="L379">          new Gui4jJTableHeader(table.getColumnModel(), table.getFont(), mHeaderLines));</span>
    } else {
      // Grouped-Headers erzeugen
<span class="nc" id="L382">      GroupableTableHeader groupableTableHeader = new GroupableTableHeader(table.getColumnModel());</span>
<span class="nc" id="L383">      table.setTableHeader(groupableTableHeader);</span>
<span class="nc bnc" id="L384" title="All 2 branches missed.">      for (Iterator iter = mColumnGroups.iterator(); iter.hasNext(); ) {</span>
<span class="nc" id="L385">        Gui4jColumnHeaderTable columnGroup = (Gui4jColumnHeaderTable) iter.next();</span>
<span class="nc" id="L386">        ColumnGroup topColumnGroup = createColumnGroupInstances(tcm, columnGroup, gui4jCallBase);</span>
<span class="nc" id="L387">        groupableTableHeader.addColumnGroup(topColumnGroup);</span>
<span class="nc" id="L388">      }</span>
    }
<span class="nc" id="L390">  }</span>

  private ColumnGroup createColumnGroupInstances(
      TableColumnModel tcm, Gui4jColumnHeaderTable columnGroup, Gui4jCallBase gui4jCall) {
<span class="nc" id="L394">    ColumnGroup cg = new ColumnGroup(columnGroup.getName(gui4jCall));</span>
<span class="nc bnc" id="L395" title="All 2 branches missed.">    for (Iterator iter = columnGroup.getColumns().iterator(); iter.hasNext(); ) {</span>
<span class="nc" id="L396">      Object o = iter.next();</span>
<span class="nc bnc" id="L397" title="All 2 branches missed.">      if (o instanceof Gui4jColumnHeaderTable) {</span>
<span class="nc" id="L398">        Gui4jColumnHeaderTable newColumnGroup = (Gui4jColumnHeaderTable) o;</span>
<span class="nc" id="L399">        ColumnGroup subCg = createColumnGroupInstances(tcm, newColumnGroup, gui4jCall);</span>
<span class="nc" id="L400">        cg.add(subCg);</span>

<span class="nc bnc" id="L402" title="All 2 branches missed.">      } else if (o instanceof Gui4jColumnTable) {</span>
<span class="nc" id="L403">        int index = mColumnManager.getMainColumns().indexOf(o);</span>
<span class="nc" id="L404">        cg.add(tcm.getColumn(index));</span>
      }
<span class="nc" id="L406">    }</span>
<span class="nc" id="L407">    return cg;</span>
  }

  /**
   * Sets the headerBackground.
   *
   * @param headerBackground
   */
  public void setHeaderBackground(Gui4jCall headerBackground) {
<span class="nc" id="L416">    mHeaderBackground = headerBackground;</span>
<span class="nc" id="L417">  }</span>

  protected Point getPopupLocation(
      Gui4jComponentInstance gui4jComponentInstance, MouseEvent mouseEvent, Object context) {
<span class="nc bnc" id="L421" title="All 2 branches missed.">    if (mouseEvent != null) {</span>
<span class="nc" id="L422">      return mouseEvent.getPoint();</span>
    }

<span class="nc" id="L425">    JTable table = (JTable) gui4jComponentInstance.getComponent();</span>
<span class="nc" id="L426">    Rectangle selection =</span>
<span class="nc" id="L427">        table.getCellRect(table.getSelectedRow(), table.getSelectedColumn(), true);</span>
<span class="nc" id="L428">    return new Point(selection.x + selection.width / 2, selection.y + selection.height / 2);</span>
  }

  /*
   * (non-Javadoc)
   *
   * @see org.gui4j.core.Gui4jAbstractComponent#createMouseListener(org.gui4j.core.Gui4jComponentInstance)
   */
  protected Gui4jMouseListener createMouseListener(Gui4jComponentInstance gui4jComponentInstance) {
<span class="nc" id="L437">    return new Gui4jMouseListenerTablePopup(gui4jComponentInstance);</span>
  }

  public void setRowSelectionIndexCall(Gui4jCall rowSelection) {
<span class="nc" id="L441">    mRowSelectionIndex = rowSelection;</span>
<span class="nc" id="L442">  }</span>

  public void setRowSelectionItemCall(Gui4jCall rowSelectionItem) {
<span class="nc" id="L445">    mRowSelectionItem = rowSelectionItem;</span>
<span class="nc" id="L446">  }</span>

  public void setCellSelectionCall(Gui4jCall cellSelection) {
<span class="nc" id="L449">    mCellSelectionPair = cellSelection;</span>
<span class="nc" id="L450">  }</span>

  public void setRowHeaderCharacters(Gui4jCall rowHeaderCharacters) {
<span class="nc" id="L453">    mRowHeaderCharacters = rowHeaderCharacters;</span>
<span class="nc" id="L454">  }</span>

  public void setOnRowSelect(Class classType, Gui4jCall onRowSelect) {
<span class="nc bnc" id="L457" title="All 2 branches missed.">    if (onRowSelect != null) {</span>
<span class="nc" id="L458">      mOnRowSelect.add(classType, onRowSelect);</span>
    }
<span class="nc" id="L460">  }</span>

  public void setActionCommand(Gui4jCall actionCommand) {
<span class="nc" id="L463">    mActionCommand = actionCommand;</span>
<span class="nc" id="L464">  }</span>

  public void setHideFocus(boolean hideFocus) {
<span class="nc" id="L467">    mHideFocus = hideFocus;</span>
<span class="nc" id="L468">  }</span>

  public void setPopupContext(Class classType, Gui4jCall onRowSelect) {
<span class="nc bnc" id="L471" title="All 2 branches missed.">    if (onRowSelect != null) {</span>
<span class="nc" id="L472">      mPopupContext.add(classType, onRowSelect);</span>
    }
<span class="nc" id="L474">  }</span>

  public void setContent(Gui4jComponentInstance gui4jComponentInstance, Collection content) {
<span class="nc bnc" id="L477" title="All 2 branches missed.">    if (content == null) {</span>
<span class="nc" id="L478">      throw new Gui4jUncheckedException.ProgrammingError(PROGRAMMING_ERROR_parameter_null);</span>
    }
<span class="nc" id="L480">    Gui4jJTable table = (Gui4jJTable) gui4jComponentInstance.getSwingComponent();</span>
<span class="nc bnc" id="L481" title="All 2 branches missed.">    if (table != null) {</span>
      // Tabelle noch nicht zerstoert
<span class="nc" id="L483">      Gui4jTableModel tm = (Gui4jTableModel) table.getModel();</span>
<span class="nc" id="L484">      ArrayList newContent = new ArrayList(content);</span>
<span class="nc bnc" id="L485" title="All 4 branches missed.">      if (newContent.size() == tm.mContent.size() &amp;&amp; newContent.equals(tm.mContent)) {</span>
<span class="nc" id="L486">        tm.refreshRows(true);</span>
      } else {
<span class="nc bnc" id="L488" title="All 2 branches missed.">        if (newContent.size() == tm.mContent.size()) {</span>
<span class="nc" id="L489">          mLogger.debug(</span>
              &quot;Setting new content for table with id &quot;
<span class="nc" id="L491">                  + getId()</span>
                  + &quot; oldSize=&quot;
<span class="nc" id="L493">                  + tm.mContent.size()</span>
                  + &quot; newSize=&quot;
<span class="nc" id="L495">                  + newContent.size());</span>
          /*
           * int n = newContent.size(); for (int i=0;i &lt;n;i++) {
           * Object o1 = newContent.get(i); Object o2 =
           * tm.mContent.get(i); if (!o1.equals(o2)) {
           * mLogger.debug(&quot;Entry: &quot;+i+&quot;, old=&quot;+o2+&quot;, new=&quot;+o1); } }
           */
        } else {
<span class="nc" id="L503">          mLogger.debug(&quot;Setting new content for table with id &quot; + getId());</span>
        }
<span class="nc" id="L505">        table.endCellEditing();</span>
<span class="nc" id="L506">        tm.setRows(newContent, false);</span>
<span class="nc" id="L507">        tm.setContent(newContent);</span>
      }
    }
<span class="nc" id="L510">  }</span>

  public void setEditCellSelection(Gui4jJTable table, Pair pair) {
<span class="nc bnc" id="L513" title="All 2 branches missed.">    if (pair != null) {</span>
<span class="nc" id="L514">      int row = ((Integer) pair.getFirst()).intValue();</span>
<span class="nc" id="L515">      int col = ((Integer) pair.getSecond()).intValue();</span>
<span class="nc" id="L516">      table.editCellAt(row, col);</span>
<span class="nc" id="L517">      table.editCellAt(row, col);</span>
<span class="nc" id="L518">      Rectangle rect = table.getCellRect(row, col, true);</span>
<span class="nc" id="L519">      table.scrollRectToVisible(rect);</span>
    }
<span class="nc" id="L521">  }</span>

  public boolean setCellSelectionPair(Gui4jJTable table, Pair pair) {
<span class="nc bnc" id="L524" title="All 2 branches missed.">    if (pair != null) {</span>
<span class="nc" id="L525">      int row = ((Integer) pair.getFirst()).intValue();</span>
<span class="nc" id="L526">      int col = ((Integer) pair.getSecond()).intValue();</span>
<span class="nc bnc" id="L527" title="All 8 branches missed.">      if (row &gt;= 0 &amp;&amp; row &lt; table.getRowCount() &amp;&amp; col &gt;= 0 &amp;&amp; col &lt; table.getColumnCount()) {</span>
<span class="nc" id="L528">        table.setRowSelectionInterval(row, row);</span>
<span class="nc" id="L529">        table.setColumnSelectionInterval(col, col);</span>
<span class="nc" id="L530">        Rectangle rect = table.getCellRect(row, col, true);</span>
<span class="nc" id="L531">        table.scrollRectToVisible(rect);</span>
<span class="nc" id="L532">        return true;</span>
      }
    }
<span class="nc" id="L535">    return false;</span>
  }

  public boolean setRowSelectionIndex(Gui4jJTable table, int row) {
<span class="nc bnc" id="L539" title="All 4 branches missed.">    if (row &gt;= 0 &amp;&amp; row &lt; table.getRowCount()) {</span>
<span class="nc" id="L540">      table.setRowSelectionInterval(row, row);</span>
<span class="nc" id="L541">      Rectangle rect = table.getCellRect(row, 0, true);</span>
<span class="nc" id="L542">      table.scrollRectToVisible(rect);</span>
<span class="nc" id="L543">      return true;</span>
    }
<span class="nc" id="L545">    return false;</span>
  }

  public boolean setRowSelectionItem(Gui4jJTable table, Object item) {
<span class="nc" id="L549">    Gui4jTableModel model = (Gui4jTableModel) table.getModel();</span>
<span class="nc" id="L550">    int row = model.mContent.indexOf(item);</span>
<span class="nc bnc" id="L551" title="All 4 branches missed.">    if (row &gt;= 0 &amp;&amp; row &lt; table.getRowCount()) {</span>
<span class="nc" id="L552">      table.setRowSelectionInterval(row, row);</span>
<span class="nc" id="L553">      Rectangle rect = table.getCellRect(row, 0, true);</span>
<span class="nc" id="L554">      table.scrollRectToVisible(rect);</span>
<span class="nc" id="L555">      return true;</span>
    }
<span class="nc" id="L557">    return false;</span>
  }

  public void addColumn(Class contentClass, Gui4jColumnTable column) {
<span class="nc" id="L561">    mColumnManager.addColumn(contentClass, column);</span>
<span class="nc" id="L562">  }</span>

  public void addRowHeaderName(Class type, Gui4jCall gui4jCall) {
<span class="nc" id="L565">    mRowManager.add(type, gui4jCall);</span>
<span class="nc" id="L566">  }</span>

  public boolean hasRowHeaderName(Class type) {
<span class="nc bnc" id="L569" title="All 2 branches missed.">    return mRowManager.get(type) != null ? true : false;</span>
  }

  public void addColumnGroup(Gui4jColumnHeaderTable columnGroup) {
<span class="nc" id="L573">    mColumnGroups.add(columnGroup);</span>
<span class="nc" id="L574">  }</span>

  public void setSelectionMode(Gui4jJTable table, int selectionMode) {
<span class="nc" id="L577">    table.setSelectionMode(selectionMode);</span>
<span class="nc" id="L578">  }</span>

  public void setRefresh(Gui4jCall[] refresh) {
<span class="nc" id="L581">    mRefresh = refresh;</span>
<span class="nc" id="L582">  }</span>

  /**
   * Sets the onSetValue.
   *
   * @param onSetValue The onSetValue to set
   */
  public void setOnSetValue(Gui4jCall onSetValue) {
<span class="nc" id="L590">    mOnSetValue = onSetValue;</span>
<span class="nc" id="L591">  }</span>

  /**
   * Sets the reorderingAllowed.
   *
   * @param reorderingAllowed The reorderingAllowed to set
   */
  public void setReorderingAllowed(boolean reorderingAllowed) {
<span class="nc" id="L599">    mReorderingAllowed = reorderingAllowed;</span>
<span class="nc" id="L600">  }</span>

  /**
   * Sets the colSelectionMode.
   *
   * @param colSelectionMode The colSelectionMode to set
   */
  public void setColSelectionMode(int colSelectionMode) {
<span class="nc" id="L608">    mColSelectionMode = colSelectionMode;</span>
<span class="nc" id="L609">  }</span>

  /**
   * Sets the rowSelectionMode.
   *
   * @param rowSelectionMode The rowSelectionMode to set
   */
  public void setRowSelectionMode(int rowSelectionMode) {
<span class="nc" id="L617">    mRowSelectionMode = rowSelectionMode;</span>
<span class="nc" id="L618">  }</span>

  /**
   * Sets the rowSelectionAllowed.
   *
   * @param rowSelectionAllowed The rowSelectionAllowed to set
   */
  public void setRowSelectionAllowed(boolean rowSelectionAllowed) {
<span class="nc" id="L626">    mRowSelectionAllowed = rowSelectionAllowed;</span>
<span class="nc" id="L627">  }</span>

  /**
   * Sets the onDoubleClick.
   *
   * @param typeClass
   * @param onDoubleClick The onDoubleClick to set
   */
  public void setOnDoubleClick(Class typeClass, Gui4jCall onDoubleClick) {
<span class="nc bnc" id="L636" title="All 2 branches missed.">    if (onDoubleClick != null) {</span>
<span class="nc" id="L637">      mOnDoubleClick.add(typeClass, onDoubleClick);</span>
    }
<span class="nc" id="L639">  }</span>

  /**
   * Sets the onCellSelect.
   *
   * @param typeClass
   * @param onCellSelect The onCellSelect to set
   */
  public void setOnCellSelect(Class typeClass, Gui4jCall onCellSelect) {
<span class="nc bnc" id="L648" title="All 2 branches missed.">    if (onCellSelect != null) {</span>
<span class="nc" id="L649">      mOnCellSelect.add(typeClass, onCellSelect);</span>
    }
<span class="nc" id="L651">  }</span>

  /**
   * Sets the onColSelect.
   *
   * @param typeClass
   * @param onColSelect The onColSelect to set
   */
  public void setOnColSelect(Class typeClass, Gui4jCall onColSelect) {
<span class="nc bnc" id="L660" title="All 2 branches missed.">    if (onColSelect != null) {</span>
<span class="nc" id="L661">      mOnColSelect.add(typeClass, onColSelect);</span>
    }
<span class="nc" id="L663">  }</span>

  public void setRownames(Gui4jComponentInstance gui4jComponentInstance, Collection rows) {
<span class="nc" id="L666">    Gui4jJTable jTable = (Gui4jJTable) gui4jComponentInstance.getSwingComponent();</span>
<span class="nc" id="L667">    jTable.endCellEditing();</span>
<span class="nc" id="L668">    Gui4jTableModel model = (Gui4jTableModel) jTable.getModel();</span>
<span class="nc" id="L669">    model.setRows(new ArrayList(rows), true);</span>
<span class="nc" id="L670">  }</span>

  public void setNames(Gui4jComponentInstance gui4jComponentInstance, Collection rows) {
    // nothing todo
<span class="nc" id="L674">  }</span>

  /**
   * @see org.gui4j.core.Gui4jComponent#dispose(Gui4jComponentInstance)
   */
  public void dispose(Gui4jComponentInstance gui4jComponentInstance) {
<span class="nc" id="L680">    super.dispose(gui4jComponentInstance);</span>
<span class="nc" id="L681">    Gui4jJTable jTable = (Gui4jJTable) gui4jComponentInstance.getSwingComponent();</span>
<span class="nc" id="L682">    Gui4jTableModel tableModel = (Gui4jTableModel) jTable.getModel();</span>
<span class="nc" id="L683">    tableModel.dispose();</span>
<span class="nc" id="L684">  }</span>

  // **************************************************************************

<span class="nc" id="L688">  public class Gui4jColumnTable implements Serializable {</span>
    private final Gui4jCall mColumnName;
    private Gui4jCall mColumnValue;
    private final Gui4jCall mColumnSetValue;
    private final Gui4jCall mEnabled;
    private final Gui4jCall mCharacters;
    private final Gui4jCall mMaxCharacters;
    private final Gui4jCall mList;
    private final Gui4jCall mListItem;
    private final Gui4jCall mListNullItem;
    private final Gui4jCall mListEditable;
    private final Gui4jCall mListIndicator;
    private final Gui4jCall mStringConvert;
    private Gui4jCall mTooltip;
    private final Gui4jThreadManager mGui4jThreadManager;
    private final Gui4jTextAttribute mGui4jTextAttribute;

    private double mWeight;

    public Gui4jColumnTable(
        Gui4jCall columnName,
        Gui4jCall getValue,
        Gui4jCall setValue,
        Gui4jCall enabled,
        Gui4jCall characters,
        Gui4jCall maxCharacters,
        Gui4jCall list,
        Gui4jCall listItem,
        Gui4jCall listNullItem,
        Gui4jCall listEditable,
        Gui4jCall listIndicator,
        Gui4jCall stringConvert,
        Gui4jCall tooltip,
<span class="nc" id="L721">        Gui4jTextAttribute gui4jTextAttribute) {</span>
<span class="nc" id="L722">      mColumnName = columnName;</span>
<span class="nc" id="L723">      mColumnValue = getValue;</span>
<span class="nc" id="L724">      mColumnSetValue = setValue;</span>
<span class="nc" id="L725">      mEnabled = enabled;</span>
<span class="nc" id="L726">      mCharacters = characters;</span>
<span class="nc" id="L727">      mMaxCharacters = maxCharacters;</span>
<span class="nc" id="L728">      mList = list;</span>
<span class="nc" id="L729">      mListItem = listItem;</span>
<span class="nc" id="L730">      mListNullItem = listNullItem;</span>
<span class="nc" id="L731">      mListEditable = listEditable;</span>
<span class="nc" id="L732">      mListIndicator = listIndicator;</span>
<span class="nc" id="L733">      mStringConvert = stringConvert;</span>
<span class="nc" id="L734">      mTooltip = tooltip;</span>
<span class="nc" id="L735">      mGui4jThreadManager = getGui4j().getGui4jThreadManager();</span>
<span class="nc" id="L736">      mGui4jTextAttribute = gui4jTextAttribute;</span>
<span class="nc" id="L737">    }</span>

    public boolean isMainColumn() {
<span class="nc" id="L740">      return true;</span>
    }

    public String getName(Gui4jCallBase gui4jController) {
<span class="nc" id="L744">      return (String) mColumnName.getValueNoParams(gui4jController, &quot;&quot;);</span>
    }

    public boolean isCharactersAttributeDefined() {
<span class="nc bnc" id="L748" title="All 2 branches missed.">      return mCharacters != null;</span>
    }

    public boolean isMaxCharactersAttributeDefined() {
<span class="nc bnc" id="L752" title="All 2 branches missed.">      return mMaxCharacters != null;</span>
    }

    public int getCharacters(Gui4jCallBase gui4jCallBase) {
<span class="nc bnc" id="L756" title="All 2 branches missed.">      assert mCharacters != null;</span>
<span class="nc" id="L757">      Integer i = (Integer) mCharacters.getValueNoParams(gui4jCallBase, new Integer(5));</span>
<span class="nc bnc" id="L758" title="All 2 branches missed.">      assert i != null;</span>
<span class="nc" id="L759">      return i.intValue();</span>
    }

    public int getMaxCharacters(Gui4jCallBase gui4jCallBase) {
<span class="nc bnc" id="L763" title="All 2 branches missed.">      assert mMaxCharacters != null;</span>
<span class="nc" id="L764">      Integer i = (Integer) mMaxCharacters.getValueNoParams(gui4jCallBase, new Integer(5));</span>
<span class="nc" id="L765">      return i.intValue();</span>
    }

    public String getTooltip(Gui4jCallBase gui4jCallBase, Object rowInstance, int row) {
<span class="nc bnc" id="L769" title="All 2 branches missed.">      if (mTooltip != null) {</span>
<span class="nc" id="L770">        Map paramMap = new HashMap();</span>
<span class="nc bnc" id="L771" title="All 2 branches missed.">        assert rowInstance != null;</span>
<span class="nc" id="L772">        paramMap.put(Const.PARAM_ITEM, rowInstance);</span>
<span class="nc" id="L773">        paramMap.put(Const.PARAM_ROW_INDEX, new Integer(row));</span>
<span class="nc bnc" id="L774" title="All 2 branches missed.">        if (mList != null) {</span>
<span class="nc" id="L775">          Collection collection = (Collection) mList.getValue(gui4jCallBase, paramMap, null);</span>
<span class="nc bnc" id="L776" title="All 2 branches missed.">          assert collection != null;</span>
<span class="nc" id="L777">          paramMap.put(Const.PARAM_LIST, collection);</span>
        }
<span class="nc bnc" id="L779" title="All 2 branches missed.">        if (mListItem != null) {</span>
<span class="nc" id="L780">          Object item = mListItem.getValue(gui4jCallBase, paramMap, null);</span>
<span class="nc" id="L781">          paramMap.put(Const.PARAM_LIST_ITEM, item);</span>
        }
        try {
<span class="nc" id="L784">          return (String) mTooltip.getValue(gui4jCallBase, paramMap, null);</span>
<span class="nc" id="L785">        } catch (Throwable t) {</span>
<span class="nc" id="L786">          getGui4j().handleException(gui4jCallBase, t, null);</span>
<span class="nc" id="L787">          mTooltip = null;</span>
<span class="nc" id="L788">          return null;</span>
        }
      } else {
<span class="nc" id="L791">        return null;</span>
      }
    }

    public Object getValue(Gui4jCallBase gui4jCallBase, Object rowInstance, int row) {
<span class="nc bnc" id="L796" title="All 2 branches missed.">      if (mColumnValue != null) {</span>
<span class="nc" id="L797">        Map paramMap = new HashMap();</span>
<span class="nc bnc" id="L798" title="All 2 branches missed.">        assert rowInstance != null;</span>
<span class="nc" id="L799">        paramMap.put(Const.PARAM_ITEM, rowInstance);</span>
<span class="nc" id="L800">        paramMap.put(Const.PARAM_ROW_INDEX, new Integer(row));</span>
<span class="nc bnc" id="L801" title="All 2 branches missed.">        if (mList != null) {</span>
<span class="nc" id="L802">          Collection collection = (Collection) mList.getValue(gui4jCallBase, paramMap, null);</span>
<span class="nc bnc" id="L803" title="All 2 branches missed.">          assert collection != null;</span>
<span class="nc" id="L804">          paramMap.put(Const.PARAM_LIST, collection);</span>
        }
<span class="nc bnc" id="L806" title="All 2 branches missed.">        if (mListItem != null) {</span>
<span class="nc" id="L807">          Object item = mListItem.getValue(gui4jCallBase, paramMap, null);</span>
<span class="nc" id="L808">          paramMap.put(Const.PARAM_LIST_ITEM, item);</span>
        }
        try {
<span class="nc" id="L811">          return mColumnValue.getValue(gui4jCallBase, paramMap, null);</span>
<span class="nc" id="L812">        } catch (Throwable t) {</span>
<span class="nc" id="L813">          getGui4j().handleException(gui4jCallBase, t, null);</span>
<span class="nc" id="L814">          mColumnValue = null;</span>
<span class="nc" id="L815">          return null;</span>
        }
      } else {
<span class="nc" id="L818">        return null;</span>
      }
    }

    public void setValue(
        Gui4jCallBase gui4jController,
        Object rowInstance,
        Object value,
        int row,
        int col,
        Gui4jTableModel model) {
<span class="nc bnc" id="L829" title="All 2 branches missed.">      if (mColumnSetValue != null) {</span>
<span class="nc bnc" id="L830" title="All 2 branches missed.">        if (value instanceof ComboBoxNullItem) {</span>
<span class="nc" id="L831">          value = null;</span>
        }

<span class="nc" id="L834">        Map paramMap = new HashMap();</span>
<span class="nc" id="L835">        paramMap.put(Const.PARAM_ROW_INDEX, new Integer(row));</span>
<span class="nc" id="L836">        paramMap.put(Const.PARAM_ITEM, rowInstance);</span>
<span class="nc" id="L837">        paramMap.put(Const.PARAM_VALUE, value);</span>

<span class="nc bnc" id="L839" title="All 2 branches missed.">        if (mList != null) {</span>
<span class="nc" id="L840">          Collection collection = (Collection) mList.getValue(gui4jController, paramMap, null);</span>
<span class="nc bnc" id="L841" title="All 2 branches missed.">          assert collection != null;</span>
<span class="nc" id="L842">          paramMap.put(Const.PARAM_LIST, collection);</span>
        }

        Gui4jGetValue[] work;
<span class="nc bnc" id="L846" title="All 2 branches missed.">        if (mOnSetValue != null) {</span>
<span class="nc" id="L847">          work =</span>
              new Gui4jGetValue[] {
                mColumnSetValue,
                new Gui4jRefreshTable(model, row, col),
<span class="nc" id="L851">                model.getAutomaticRefresh(),</span>
                mOnSetValue
              };
        } else {
<span class="nc" id="L855">          work =</span>
              new Gui4jGetValue[] {
<span class="nc" id="L857">                mColumnSetValue, new Gui4jRefreshTable(model, row, col), model.getAutomaticRefresh()</span>
              };
        }
<span class="nc" id="L860">        mGui4jThreadManager.performWork(gui4jController, work, paramMap);</span>
      }
<span class="nc" id="L862">    }</span>

    public boolean isEnabled(Gui4jCallBase gui4jController, Object rowContent) {
<span class="nc bnc" id="L865" title="All 2 branches missed.">      if (mEnabled == null) {</span>
<span class="nc" id="L866">        return true;</span>
      } else {
<span class="nc" id="L868">        Map paramMap = new Gui4jMap1(Const.PARAM_ITEM, rowContent);</span>
<span class="nc" id="L869">        return Boolean.TRUE.equals(mEnabled.getValue(gui4jController, paramMap, Boolean.TRUE));</span>
      }
    }

    public boolean hasSetter(Gui4jCallBase gui4jController, Object rowContent) {
<span class="nc bnc" id="L874" title="All 6 branches missed.">      return (mColumnSetValue != null || mList != null) &amp;&amp; isEnabled(gui4jController, rowContent);</span>
    }

    public Class getColumnClass() {
<span class="nc bnc" id="L878" title="All 2 branches missed.">      if (mColumnValue != null) {</span>
<span class="nc" id="L879">        return mColumnValue.getResultClass();</span>
      } else {
<span class="nc" id="L881">        return Object.class;</span>
      }
    }

    public ComboBoxCellEdit createEditor(Gui4jCallBase gui4jController, Font font) {
<span class="nc bnc" id="L886" title="All 2 branches missed.">      if (mList != null) {</span>
<span class="nc bnc" id="L887" title="All 4 branches missed.">        if (mGui4jTextAttribute != null &amp;&amp; mGui4jTextAttribute.getFont() != null) {</span>
<span class="nc" id="L888">          font = (Font) mGui4jTextAttribute.getFont().getValueNoParams(gui4jController, font);</span>
        }
<span class="nc" id="L890">        ComboBoxCellEdit cellEdit =</span>
<span class="nc" id="L891">            ComboBoxCellEdit.getInstance(</span>
                gui4jController, mColumnValue, mStringConvert, Const.PARAM_LIST_ITEM, font);
<span class="nc bnc" id="L893" title="All 2 branches missed.">        if (mListEditable != null) {</span>
<span class="nc" id="L894">          Boolean editable = (Boolean) mListEditable.getValueNoParams(gui4jController, null);</span>
<span class="nc" id="L895">          cellEdit.setEditable(Boolean.TRUE.equals(editable));</span>
        }
<span class="nc" id="L897">        return cellEdit;</span>
      }
<span class="nc" id="L899">      return null;</span>
    }

    /**
     * Returns the weight.
     *
     * @return double
     */
    public double getWeight() {
<span class="nc" id="L908">      return mWeight;</span>
    }

    public Icon getListIndicator(Gui4jCallBase callBase) {
<span class="nc bnc" id="L912" title="All 2 branches missed.">      if (mListIndicator == null) {</span>
<span class="nc" id="L913">        return null;</span>
      }
<span class="nc" id="L915">      return (Icon) mListIndicator.getValueNoParams(callBase, null);</span>
    }

    /**
     * Sets the weight.
     *
     * @param weight The weight to set
     */
    public void setWeight(double weight) {
<span class="nc" id="L924">      mWeight = weight;</span>
<span class="nc" id="L925">    }</span>

    /**
     * Returns the gui4jTextAttribute.
     *
     * @return Gui4jTextAttribute
     */
    public Gui4jTextAttribute getGui4jTextAttribute() {
<span class="nc" id="L933">      return mGui4jTextAttribute;</span>
    }

    public void prepareEditor(
        Gui4jCallBase gui4jController, TableCellEditor editor, int row, Object rowElement) {
<span class="nc bnc" id="L938" title="All 2 branches missed.">      if (mList != null) {</span>
<span class="nc" id="L939">        ComboBoxCellEdit edit = (ComboBoxCellEdit) editor;</span>
<span class="nc" id="L940">        Map m = new HashMap();</span>
<span class="nc" id="L941">        m.put(Const.PARAM_ITEM, rowElement);</span>
<span class="nc" id="L942">        m.put(Const.PARAM_ROW_INDEX, new Integer(row));</span>
<span class="nc" id="L943">        Collection list = (Collection) mList.getValue(gui4jController, m, null);</span>
<span class="nc" id="L944">        String nullItemText = null;</span>
<span class="nc bnc" id="L945" title="All 2 branches missed.">        if (mListNullItem != null) {</span>
<span class="nc" id="L946">          nullItemText = (String) mListNullItem.getValueNoParams(gui4jController, &quot;(undefined)&quot;);</span>
<span class="nc bnc" id="L947" title="All 4 branches missed.">          if (nullItemText == null || nullItemText.length() == 0) {</span>
<span class="nc" id="L948">            nullItemText = &quot; &quot;;</span>
            // combobox can't deal correctly with null elements and
            // empty strings
          }
        }
<span class="nc" id="L953">        edit.setContent(list, nullItemText);</span>
<span class="nc" id="L954">        m.put(Const.PARAM_LIST, list);</span>
<span class="nc" id="L955">        Object listItem = mListItem.getValue(gui4jController, m, null);</span>
<span class="nc" id="L956">        edit.setParamMap(m);</span>
<span class="nc" id="L957">        edit.setSelectedItem(listItem);</span>
      }
<span class="nc" id="L959">    }</span>
  }

  // *******************************************************************************

  private final class ColumnManager implements Serializable {
    private final HashMap mTypeMap; // Class -&gt; List(Gui4jColumnTable)
    private final List mMainColumns;
    // private final Class mDefaultType;

<span class="nc" id="L969">    private boolean mContainsSeveralTypes = false;</span>

<span class="nc" id="L971">    public ColumnManager(Class defaultType) {</span>
<span class="nc" id="L972">      mMainColumns = new ArrayList();</span>
<span class="nc" id="L973">      mTypeMap = new HashMap();</span>
<span class="nc" id="L974">      mTypeMap.put(defaultType, mMainColumns);</span>
      // mDefaultType = defaultType;
<span class="nc" id="L976">    }</span>

    private List getColumnsOfType(Class contentClass) {
<span class="nc" id="L979">      List l = (List) mTypeMap.get(contentClass);</span>
<span class="nc bnc" id="L980" title="All 2 branches missed.">      if (l == null) {</span>
<span class="nc" id="L981">        mContainsSeveralTypes = true;</span>
<span class="nc" id="L982">        l = new ArrayList();</span>
<span class="nc" id="L983">        mTypeMap.put(contentClass, l);</span>
      }
<span class="nc" id="L985">      return l;</span>
    }

    public boolean containsSeveralTypes() {
<span class="nc" id="L989">      return mContainsSeveralTypes;</span>
    }

    public void addColumn(Class contentClass, Gui4jColumnTable gui4jColumnTable) {
<span class="nc" id="L993">      getColumnsOfType(contentClass).add(gui4jColumnTable);</span>
<span class="nc" id="L994">    }</span>

    public List getMainColumns() {
<span class="nc" id="L997">      return mMainColumns;</span>
    }

    public List getColumns(Class rowClass) {
<span class="nc" id="L1001">      Class lastClass = null;</span>
<span class="nc" id="L1002">      List lastList = null;</span>
<span class="nc bnc" id="L1003" title="All 2 branches missed.">      for (Iterator it = mTypeMap.entrySet().iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L1004">        Map.Entry entry = (Map.Entry) it.next();</span>
<span class="nc" id="L1005">        Class c = (Class) entry.getKey();</span>
<span class="nc bnc" id="L1006" title="All 2 branches missed.">        if (c.isAssignableFrom(rowClass)) {</span>
<span class="nc bnc" id="L1007" title="All 4 branches missed.">          if (lastClass == null || lastClass.isAssignableFrom(c)) {</span>
<span class="nc" id="L1008">            lastClass = c;</span>
<span class="nc" id="L1009">            lastList = (List) entry.getValue();</span>
          }
        }
<span class="nc" id="L1012">      }</span>
<span class="nc" id="L1013">      return lastList;</span>
    }

    public int columnCount() {
<span class="nc" id="L1017">      return mMainColumns.size();</span>
    }

    public Gui4jColumnTable getGui4jColumnTable(Object row, int col) {
<span class="nc bnc" id="L1021" title="All 2 branches missed.">      if (row == null) {</span>
<span class="nc" id="L1022">        mLogger.warn(&quot;Table &quot; + getId() + &quot; has null instance in rows&quot;);</span>
<span class="nc" id="L1023">        return null;</span>
      }
<span class="nc" id="L1025">      List l = getColumns(row.getClass());</span>
<span class="nc bnc" id="L1026" title="All 4 branches missed.">      return l != null &amp;&amp; col &lt; l.size() ? (Gui4jColumnTable) l.get(col) : null;</span>
    }

    public Gui4jColumnTable getMainGui4jColumnTable(int col) {
<span class="nc" id="L1030">      return (Gui4jColumnTable) mMainColumns.get(col);</span>
    }
  }

  // *******************************************************************************

  public final class CellRenderer extends DefaultTableCellRenderer {
    private final int mCols;
    private final Color[] mForeground;
    private final Color[] mBackground;
    private final Color[] mEvenBackground;
    private final Font[] mFont;
    private final int[] mAlignment;
    private final Icon[] mListIndicators;
    private final Gui4jColumnTable[] mColumns;
    private final Enabled mEnabledInstance;
    private final Gui4jTableModel mTableModel;
    private final TableCellRenderer booleanCellRenderer;
    private final Gui4jCallBase mGui4jCallBase;

    public CellRenderer(
<span class="nc" id="L1051">        Gui4jComponentInstance gui4jComponentInstance, List columns, Enabled enabledInstance) {</span>
<span class="nc" id="L1052">      mGui4jCallBase = gui4jComponentInstance.getGui4jCallBase();</span>
<span class="nc" id="L1053">      mTableModel =</span>
<span class="nc" id="L1054">          (Gui4jTableModel) ((Gui4jJTable) gui4jComponentInstance.getSwingComponent()).getModel();</span>
<span class="nc bnc" id="L1055" title="All 2 branches missed.">      mCols = columns == null ? 0 : columns.size();</span>
<span class="nc" id="L1056">      mForeground = new Color[mCols];</span>
<span class="nc" id="L1057">      mBackground = new Color[mCols];</span>
<span class="nc" id="L1058">      mEvenBackground = new Color[mCols];</span>
<span class="nc" id="L1059">      mColumns = new Gui4jColumnTable[mCols];</span>
<span class="nc" id="L1060">      mFont = new Font[mCols];</span>
<span class="nc" id="L1061">      mAlignment = new int[mCols];</span>
<span class="nc" id="L1062">      mListIndicators = new Icon[mCols];</span>
<span class="nc" id="L1063">      mEnabledInstance = enabledInstance;</span>

<span class="nc" id="L1065">      booleanCellRenderer = new BooleanTableCellRenderer(noFocusBorder);</span>

<span class="nc bnc" id="L1067" title="All 2 branches missed.">      for (int col = 0; col &lt; mCols; col++) {</span>
<span class="nc" id="L1068">        Gui4jColumnTable tableColumn = (Gui4jColumnTable) columns.get(col);</span>
<span class="nc" id="L1069">        mColumns[col] = tableColumn;</span>
<span class="nc" id="L1070">        mAlignment[col] = -1;</span>
<span class="nc bnc" id="L1071" title="All 4 branches missed.">        if (tableColumn != null &amp;&amp; tableColumn.getGui4jTextAttribute() != null) {</span>
<span class="nc" id="L1072">          Gui4jTextAttribute textAttribute = tableColumn.getGui4jTextAttribute();</span>
<span class="nc" id="L1073">          Map nullMap = null;</span>
<span class="nc bnc" id="L1074" title="All 2 branches missed.">          if (textAttribute.getForeground() != null) {</span>
<span class="nc" id="L1075">            mForeground[col] =</span>
<span class="nc" id="L1076">                (Color) textAttribute.getForeground().getValue(mGui4jCallBase, nullMap, null);</span>
          }
<span class="nc bnc" id="L1078" title="All 2 branches missed.">          if (textAttribute.getBackground() != null) {</span>
<span class="nc" id="L1079">            mBackground[col] =</span>
<span class="nc" id="L1080">                (Color) textAttribute.getBackground().getValue(mGui4jCallBase, nullMap, null);</span>
          }
<span class="nc bnc" id="L1082" title="All 2 branches missed.">          if (textAttribute.getEvenBackground() != null) {</span>
<span class="nc" id="L1083">            mEvenBackground[col] =</span>
<span class="nc" id="L1084">                (Color) textAttribute.getEvenBackground().getValue(mGui4jCallBase, nullMap, null);</span>
          }
<span class="nc bnc" id="L1086" title="All 2 branches missed.">          if (textAttribute.getFont() != null) {</span>
<span class="nc" id="L1087">            mFont[col] = (Font) textAttribute.getFont().getValue(mGui4jCallBase, nullMap, null);</span>
          }
<span class="nc" id="L1089">          mAlignment[col] = textAttribute.getAlignment();</span>
        }
<span class="nc bnc" id="L1091" title="All 2 branches missed.">        if (tableColumn != null) {</span>
<span class="nc" id="L1092">          mListIndicators[col] = tableColumn.getListIndicator(mGui4jCallBase);</span>
        }
      }
<span class="nc" id="L1095">    }</span>

    public Component getTableCellRendererComponent(
        JTable table, Object value, boolean isSelected, boolean hasFocus, int row, int column) {
<span class="nc bnc" id="L1099" title="All 2 branches missed.">      if (column &gt;= mCols) {</span>
<span class="nc" id="L1100">        return this;</span>
      }

      // determine colors to use
<span class="nc" id="L1104">      Color foreground = mForeground[column];</span>
<span class="nc bnc" id="L1105" title="All 2 branches missed.">      if (foreground == null) {</span>
<span class="nc" id="L1106">        foreground = table.getForeground();</span>
      }
<span class="nc" id="L1108">      Color background = mBackground[column];</span>
<span class="nc" id="L1109">      Color evenBackground = mEvenBackground[column];</span>
<span class="nc bnc" id="L1110" title="All 4 branches missed.">      if (evenBackground != null &amp;&amp; row % 2 == 0) {</span>
<span class="nc" id="L1111">        background = evenBackground;</span>
      }
<span class="nc bnc" id="L1113" title="All 2 branches missed.">      if (background == null) {</span>
<span class="nc" id="L1114">        background = table.getBackground();</span>
      }

      // get the renderer component for this cell
      JComponent c;
<span class="nc bnc" id="L1119" title="All 4 branches missed.">      if (value != null &amp;&amp; value.getClass() == Boolean.class) {</span>
        // special checkbox renderer for booleans
<span class="nc" id="L1121">        BooleanTableCellRenderer renderer =</span>
            (BooleanTableCellRenderer)
<span class="nc" id="L1123">                booleanCellRenderer.getTableCellRendererComponent(</span>
                    table, value, isSelected, hasFocus, row, column);
<span class="nc" id="L1125">        renderer.setUnselectedBackground(background);</span>
<span class="nc" id="L1126">        c = renderer;</span>
<span class="nc" id="L1127">      } else {</span>
<span class="nc" id="L1128">        c =</span>
            (JComponent)
<span class="nc" id="L1130">                super.getTableCellRendererComponent(</span>
                    table, value, isSelected, hasFocus, row, column);
      }

      // set colors (this intentionally overrides strategies implemented
      // in the getTableCellRendererComponent() calls above, to not use
      // a special color for editable cells having the focus).
<span class="nc bnc" id="L1137" title="All 2 branches missed.">      if (isSelected) {</span>
<span class="nc" id="L1138">        c.setForeground(table.getSelectionForeground());</span>
<span class="nc" id="L1139">        c.setBackground(table.getSelectionBackground());</span>
      } else {
<span class="nc" id="L1141">        c.setForeground(foreground);</span>
<span class="nc bnc" id="L1142" title="All 2 branches missed.">        if (!mTableModel.ignoreBackground) {</span>
<span class="nc" id="L1143">          c.setBackground(background);</span>
        }
      }

      // set tooltip
<span class="nc" id="L1148">      Gui4jColumnTable columnTable = mColumns[column];</span>
<span class="nc" id="L1149">      String tooltip = columnTable.getTooltip(mGui4jCallBase, mTableModel.getRowInstance(row), row);</span>
<span class="nc bnc" id="L1150" title="All 2 branches missed.">      if (&quot;&quot;.equals(tooltip)) {</span>
<span class="nc" id="L1151">        tooltip = null;</span>
      }
<span class="nc" id="L1153">      c.setToolTipText(tooltip);</span>

      // handle text and icons
<span class="nc bnc" id="L1156" title="All 2 branches missed.">      if (c instanceof JLabel) {</span>
<span class="nc" id="L1157">        JLabel l = (JLabel) c;</span>
<span class="nc" id="L1158">        int hAlign = mAlignment[column];</span>
<span class="nc bnc" id="L1159" title="All 2 branches missed.">        if (hAlign != -1) {</span>
<span class="nc" id="L1160">          l.setHorizontalAlignment(hAlign);</span>
        } else {
<span class="nc" id="L1162">          l.setHorizontalAlignment(SwingConstants.LEFT);</span>
        }
<span class="nc bnc" id="L1164" title="All 4 branches missed.">        if (value != null &amp;&amp; value instanceof Icon) {</span>
<span class="nc" id="L1165">          l.setText(&quot;&quot;);</span>
<span class="nc" id="L1166">          l.setIcon((Icon) value);</span>
<span class="nc" id="L1167">          l.setHorizontalAlignment(SwingConstants.CENTER);</span>
<span class="nc bnc" id="L1168" title="All 2 branches missed.">        } else if (mListIndicators[column] != null) {</span>
<span class="nc" id="L1169">          l.setIcon(mListIndicators[column]);</span>
<span class="nc" id="L1170">          l.setHorizontalTextPosition(JLabel.RIGHT);</span>
        } else {
<span class="nc" id="L1172">          l.setIcon(null);</span>
        }
      }

      // System.out.println(getId()
      // + &quot;: Rendering (&quot;
      // + row
      // + &quot;, &quot;
      // + column
      // + &quot;): &quot;
      // + value
      // + &quot; -&quot;
      // + (value == null ? &quot;null&quot; : value.getClass().toString())
      // + &quot; isopaque = &quot;
      // + c.isOpaque()
      // + &quot; has icon: &quot;
      // + ((c instanceof JLabel) &amp;&amp; (((JLabel) c).getIcon() != null)));

<span class="nc" id="L1190">      Font font = mFont[column];</span>
<span class="nc bnc" id="L1191" title="All 2 branches missed.">      if (font != null) {</span>
<span class="nc" id="L1192">        c.setFont(font);</span>
      }

<span class="nc" id="L1195">      c.setEnabled(mEnabledInstance.isEnabled(row, column));</span>

<span class="nc bnc" id="L1197" title="All 2 branches missed.">      if (mHideFocus) {</span>
<span class="nc" id="L1198">        c.setBorder(noFocusBorder);</span>
      }

<span class="nc" id="L1201">      return c;</span>
    }
  }

  /*
   * (non-Javadoc)
   *
   * @see org.gui4j.core.Gui4jAbstractComponent#getPopupContext(org.gui4j.core.Gui4jComponentInstance,
   *      java.awt.event.MouseEvent)
   */
  protected Object getPopupContext(
      Gui4jComponentInstance gui4jComponentInstance, MouseEvent mouseEvent) {
<span class="nc" id="L1213">    Gui4jCall call = null;</span>
<span class="nc" id="L1214">    Map paramMap = null;</span>
<span class="nc" id="L1215">    JTable table = (JTable) gui4jComponentInstance.getComponent();</span>
<span class="nc" id="L1216">    Gui4jTableModel model = (Gui4jTableModel) table.getModel();</span>
<span class="nc bnc" id="L1217" title="All 2 branches missed.">    if (model.mPopupHandler != null) {</span>
<span class="nc" id="L1218">      paramMap = new HashMap();</span>
<span class="nc" id="L1219">      call = model.mPopupHandler.getGui4jCall(paramMap);</span>
    }
<span class="nc bnc" id="L1221" title="All 2 branches missed.">    if (call != null) {</span>
<span class="nc" id="L1222">      return call.getValue(gui4jComponentInstance.getGui4jCallBase(), paramMap, null);</span>
    } else {
<span class="nc" id="L1224">      return null;</span>
    }
  }

  // *************************************************************************************

  public interface Enabled {
    boolean isEnabled(int row, int column);
  }

  public class Gui4jTableModel extends RowHeaderAbstractTableModel
      implements Gui4jEventListener, Gui4jTableListener, Enabled, RowRetriever {

    private Gui4jSwingContainer mGui4jSwingContainer;
    private Gui4jCallBase mGui4jController;
    private Gui4jComponentInstance mGui4jComponentInstance;
    private Gui4jJTable mTable;

<span class="nc" id="L1242">    private List mRows = new ArrayList();</span>
    protected List mContent;
    private final Map mCellRenderers; // Class -&gt; TableCellRenderer
    private final Map mCellEditors; // Class -&gt; TableCellEditor
    private final List mListeners; // List(Gui4jMouseListenerTable)
    protected Gui4jMouseListenerTable mPopupHandler;

<span class="nc" id="L1249">    protected boolean ignoreBackground = false; // Used by CellRenderer</span>

<span class="nc" id="L1251">    public Gui4jTableModel(Gui4jSwingContainer gui4jSwingContainer, Gui4jCallBase gui4jCallBase) {</span>
<span class="nc" id="L1252">      mGui4jSwingContainer = gui4jSwingContainer;</span>
<span class="nc" id="L1253">      mGui4jController = gui4jCallBase;</span>
<span class="nc" id="L1254">      mContent = new ArrayList();</span>
<span class="nc" id="L1255">      mCellRenderers = new HashMap();</span>
<span class="nc" id="L1256">      mCellEditors = new HashMap();</span>
<span class="nc" id="L1257">      mListeners = new ArrayList();</span>
<span class="nc" id="L1258">    }</span>

    public Object getRowInstance(int row) {
<span class="nc bnc" id="L1261" title="All 2 branches missed.">      if (row &gt;= mContent.size()) {</span>
<span class="nc" id="L1262">        mLogger.warn(</span>
            &quot;Index of requested table row out of bounds (table content was presumably changed in the meantime): &quot;
                + row);
<span class="nc" id="L1265">        return null;</span>
      } else {
<span class="nc" id="L1267">        return mContent.get(row);</span>
      }
    }

    public Gui4jGetValue getAutomaticRefresh() {
<span class="nc" id="L1272">      Gui4jJTable table = (Gui4jJTable) mGui4jComponentInstance.getSwingComponent();</span>
<span class="nc bnc" id="L1273" title="All 4 branches missed.">      if (mAutomaticRefresh &amp;&amp; table != null) {</span>
<span class="nc" id="L1274">        return table.getAutomaticRefreshAction();</span>
      } else {
<span class="nc" id="L1276">        return null;</span>
      }
    }

    public void setIgnoreBackground(boolean flag) {
<span class="nc bnc" id="L1281" title="All 2 branches missed.">      if (ignoreBackground != flag) {</span>
<span class="nc" id="L1282">        ignoreBackground = flag;</span>
<span class="nc bnc" id="L1283" title="All 2 branches missed.">        if (mGui4jComponentInstance != null) {</span>
<span class="nc" id="L1284">          mGui4jComponentInstance.getSwingComponent().repaint();</span>
        }
      }
<span class="nc" id="L1287">    }</span>

    public boolean ignoreBackground() {
<span class="nc" id="L1290">      return ignoreBackground;</span>
    }

    public boolean setSelection() {
<span class="nc" id="L1294">      Gui4jJTable table = (Gui4jJTable) mGui4jComponentInstance.getSwingComponent();</span>
<span class="nc bnc" id="L1295" title="All 2 branches missed.">      if (mCellSelectionPair != null) {</span>
<span class="nc" id="L1296">        Pair pair = (Pair) mCellSelectionPair.getValueNoParams(mGui4jController, null);</span>
<span class="nc bnc" id="L1297" title="All 2 branches missed.">        if (!setCellSelectionPair(table, pair)) {</span>
<span class="nc" id="L1298">          table.clearSelection();</span>
        }
<span class="nc bnc" id="L1300" title="All 2 branches missed.">      } else if (mRowSelectionItem != null) {</span>
<span class="nc" id="L1301">        Object item = mRowSelectionItem.getValueNoParams(mGui4jController, null);</span>
<span class="nc bnc" id="L1302" title="All 2 branches missed.">        if (!setRowSelectionItem(table, item)) {</span>
<span class="nc" id="L1303">          table.clearSelection();</span>
        }
<span class="nc bnc" id="L1305" title="All 2 branches missed.">      } else if (mRowSelectionIndex != null) {</span>
<span class="nc" id="L1306">        Integer i = (Integer) mRowSelectionIndex.getValueNoParams(mGui4jController, null);</span>
<span class="nc bnc" id="L1307" title="All 2 branches missed.">        int idx = i == null ? -1 : i.intValue();</span>
<span class="nc bnc" id="L1308" title="All 2 branches missed.">        if (!setRowSelectionIndex(table, idx)) {</span>
<span class="nc" id="L1309">          table.clearSelection();</span>
        }
<span class="nc" id="L1311">      } else {</span>
<span class="nc" id="L1312">        return false;</span>
      }
<span class="nc" id="L1314">      return true;</span>
    }

    public void addListener(Gui4jMouseListenerTable mouseListenerTable) {
<span class="nc" id="L1318">      mGui4jComponentInstance.getGui4jSwingContainer().addDispose(mouseListenerTable);</span>
<span class="nc" id="L1319">      mListeners.add(mouseListenerTable);</span>
<span class="nc" id="L1320">    }</span>

    public int getColumnCount() {
<span class="nc" id="L1323">      return mColumnManager.columnCount();</span>
    }

    public int getRowCount() {
<span class="nc bnc" id="L1327" title="All 2 branches missed.">      return mContent == null ? 0 : mContent.size();</span>
    }

    public boolean isCellEditable(int row, int col) {
<span class="nc bnc" id="L1331" title="All 4 branches missed.">      if (handleReadOnly() &amp;&amp; mGui4jSwingContainer.inReadOnlyMode()) {</span>
<span class="nc" id="L1332">        return false;</span>
      } else {
<span class="nc" id="L1334">        Object rowContent = getRowInstance(row);</span>
<span class="nc" id="L1335">        Gui4jColumnTable column = mColumnManager.getGui4jColumnTable(rowContent, col);</span>
<span class="nc bnc" id="L1336" title="All 4 branches missed.">        return column != null &amp;&amp; column.hasSetter(mGui4jController, rowContent);</span>
      }
    }

    public boolean isEnabled(int row, int col) {
<span class="nc" id="L1341">      Object rowContent = getRowInstance(row);</span>
<span class="nc" id="L1342">      Gui4jColumnTable column = mColumnManager.getGui4jColumnTable(rowContent, col);</span>
<span class="nc bnc" id="L1343" title="All 4 branches missed.">      return column == null || column.isEnabled(mGui4jController, rowContent);</span>
    }

    public Object getValueAt(int row, int col) {
<span class="nc" id="L1347">      Object rowElement = getRowInstance(row);</span>
<span class="nc" id="L1348">      Gui4jColumnTable column = mColumnManager.getGui4jColumnTable(rowElement, col);</span>
<span class="nc bnc" id="L1349" title="All 2 branches missed.">      Object value = column == null ? null : column.getValue(mGui4jController, rowElement, row);</span>
<span class="nc" id="L1350">      return value;</span>
    }

    public void setValueAt(Object value, int row, int col) {
<span class="nc" id="L1354">      Object rowElement = getRowInstance(row);</span>
<span class="nc" id="L1355">      Gui4jColumnTable column = mColumnManager.getGui4jColumnTable(rowElement, col);</span>
<span class="nc" id="L1356">      column.setValue(mGui4jController, rowElement, value, row, col, this);</span>
<span class="nc" id="L1357">    }</span>

    public Class getColumnClass(int columnIndex) {
<span class="nc" id="L1360">      Gui4jColumnTable column = mColumnManager.getMainGui4jColumnTable(columnIndex);</span>
<span class="nc" id="L1361">      return column.getColumnClass();</span>
    }

    public String getColumnName(int columnIndex) {
<span class="nc" id="L1365">      Gui4jColumnTable column = mColumnManager.getMainGui4jColumnTable(columnIndex);</span>
<span class="nc" id="L1366">      String name = column.getName(mGui4jController);</span>
<span class="nc bnc" id="L1367" title="All 4 branches missed.">      if (name == null || name.equals(&quot;&quot;)) {</span>
<span class="nc" id="L1368">        return &quot; &quot;;</span>
      }
<span class="nc" id="L1370">      return name;</span>
    }

    public void setGui4jComponentInstance(Gui4jComponentInstance gui4jComponentInstance) {
<span class="nc" id="L1374">      mGui4jComponentInstance = gui4jComponentInstance;</span>
<span class="nc" id="L1375">      mTable = (Gui4jJTable) mGui4jComponentInstance.getSwingComponent();</span>
<span class="nc" id="L1376">    }</span>

    protected synchronized void setContent(ArrayList content) {
<span class="nc bnc" id="L1379" title="All 2 branches missed.">      if (mGui4jComponentInstance != null) {</span>
        // Gui4jComponentInstance noch nicht zerstoert.
<span class="nc" id="L1381">        Gui4jJTable table = (Gui4jJTable) mGui4jComponentInstance.getSwingComponent();</span>
        // Deaktiviere listeners
<span class="nc bnc" id="L1383" title="All 2 branches missed.">        for (Iterator it = mListeners.iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L1384">          Gui4jMouseListenerTable mouseListenerTable = (Gui4jMouseListenerTable) it.next();</span>
<span class="nc" id="L1385">          mouseListenerTable.setActive(false);</span>
<span class="nc" id="L1386">        }</span>
<span class="nc" id="L1387">        int selectedRow = table.getSelectedRow();</span>
<span class="nc" id="L1388">        Object selectedRowItem = null;</span>
<span class="nc bnc" id="L1389" title="All 4 branches missed.">        if (selectedRow &gt;= 0 &amp;&amp; selectedRow &lt; mContent.size()) {</span>
<span class="nc" id="L1390">          selectedRowItem = mContent.get(selectedRow);</span>
        }
<span class="nc" id="L1392">        int selectedCol = table.getSelectedColumn();</span>
<span class="nc" id="L1393">        mContent = content;</span>
        /*
         * mContent.clear(); if (!mUseOriginalCollection) {
         * mContent.addAll(content); } else { mContent = (List) content; }
         */
<span class="nc" id="L1398">        fireTableDataChanged();</span>
        // Aktiviere Listeners
<span class="nc bnc" id="L1400" title="All 2 branches missed.">        for (Iterator it = mListeners.iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L1401">          Gui4jMouseListenerTable mouseListenerTable = (Gui4jMouseListenerTable) it.next();</span>
<span class="nc" id="L1402">          mouseListenerTable.setActive(true);</span>
<span class="nc" id="L1403">        }</span>
        // Setze Selektion
<span class="nc bnc" id="L1405" title="All 2 branches missed.">        if (!setSelection()) {</span>
<span class="nc bnc" id="L1406" title="All 2 branches missed.">          if (selectedRowItem != null) {</span>
<span class="nc" id="L1407">            selectedRow = mContent.indexOf(selectedRowItem);</span>
<span class="nc bnc" id="L1408" title="All 4 branches missed.">            if (selectedRow != -1 &amp;&amp; mRowSelectionAllowed) {</span>
<span class="nc" id="L1409">              setRowSelectionItem(table, selectedRowItem);</span>
            }
<span class="nc bnc" id="L1411" title="All 6 branches missed.">            if (selectedRow != -1 &amp;&amp; selectedCol != -1 &amp;&amp; !mRowSelectionAllowed) {</span>
<span class="nc" id="L1412">              setCellSelectionPair(</span>
                  table, new Pair(new Integer(selectedRow), new Integer(selectedCol)));
            }
          }
        }
      }
<span class="nc" id="L1418">    }</span>

    protected void setRows(ArrayList rows, boolean refresh) {
<span class="nc bnc" id="L1421" title="All 2 branches missed.">      if (rows != null) {</span>
<span class="nc" id="L1422">        mRows = rows;</span>
      } else {
<span class="nc" id="L1424">        mRows = new ArrayList();</span>
      }
<span class="nc" id="L1426">      refreshRows(refresh);</span>
<span class="nc" id="L1427">    }</span>

    public Object getRow(int row) {
<span class="nc" id="L1430">      return getRowInstance(row);</span>
    }

    public void eventOccured() {
<span class="nc" id="L1434">      Runnable run =</span>
<span class="nc" id="L1435">          new Runnable() {</span>
            public void run() {
<span class="nc bnc" id="L1437" title="All 2 branches missed.">              if (mContent != null) {</span>
<span class="nc" id="L1438">                fireTableRowsUpdated(0, mContent.size() - 1);</span>
              }
<span class="nc" id="L1440">            }</span>
          };
<span class="nc" id="L1442">      Gui4jThreadManager.executeInSwingThreadAndWait(run);</span>
<span class="nc" id="L1443">    }</span>

    public void dispose() {
<span class="nc" id="L1446">      mCellRenderers.clear();</span>
<span class="nc" id="L1447">      mCellEditors.clear();</span>
<span class="nc bnc" id="L1448" title="All 2 branches missed.">      if (mContent != null) {</span>
<span class="nc" id="L1449">        mContent.clear();</span>
<span class="nc" id="L1450">        mContent = null;</span>
      }
<span class="nc" id="L1452">      mGui4jSwingContainer = null;</span>
<span class="nc" id="L1453">      mGui4jController = null;</span>
<span class="nc" id="L1454">      mGui4jComponentInstance = null;</span>
<span class="nc" id="L1455">      mListeners.clear();</span>
<span class="nc" id="L1456">    }</span>

    /**
     * @see org.gui4j.core.swing.Gui4jTableListener#prepareEditor(TableCellEditor, int, int)
     */
    public void prepareEditor(TableCellEditor editor, int row, int column) {
<span class="nc" id="L1462">      Object rowElement = getRowInstance(row);</span>
<span class="nc" id="L1463">      Gui4jColumnTable columnTable = mColumnManager.getGui4jColumnTable(rowElement, column);</span>
<span class="nc" id="L1464">      columnTable.prepareEditor(mGui4jController, editor, row, rowElement);</span>
<span class="nc" id="L1465">    }</span>

    /**
     * @see org.gui4j.core.swing.Gui4jTableListener#getCellEditor(TableCellEditor, int, int)
     */
    public TableCellEditor getCellEditor(TableCellEditor editor, int row, int column) {
<span class="nc" id="L1471">      Object rowElement = getRowInstance(row);</span>
<span class="nc" id="L1472">      Class rowClass = rowElement.getClass();</span>
<span class="nc bnc" id="L1473" title="All 4 branches missed.">      if (!mColumnManager.containsSeveralTypes() || mDefaultType.isAssignableFrom(rowClass)) {</span>
<span class="nc" id="L1474">        return editor;</span>
      } else {
<span class="nc" id="L1476">        String key = rowClass + &quot;#&quot; + column + &quot;#&quot;;</span>
<span class="nc" id="L1477">        TableCellEditor editorSpecial = (TableCellEditor) mCellEditors.get(key);</span>
<span class="nc bnc" id="L1478" title="All 2 branches missed.">        if (editorSpecial == null) {</span>
<span class="nc" id="L1479">          Gui4jColumnTable columnTable = mColumnManager.getGui4jColumnTable(rowElement, column);</span>
<span class="nc bnc" id="L1480" title="All 2 branches missed.">          if (columnTable != null) {</span>
<span class="nc" id="L1481">            editorSpecial =</span>
<span class="nc" id="L1482">                columnTable.createEditor(</span>
<span class="nc" id="L1483">                    mGui4jController, mGui4jComponentInstance.getSwingComponent().getFont());</span>
          }
<span class="nc bnc" id="L1485" title="All 2 branches missed.">          if (editorSpecial == null) {</span>
<span class="nc" id="L1486">            editorSpecial = editor;</span>
          }
        }
<span class="nc" id="L1489">        mCellEditors.put(key, editorSpecial);</span>
<span class="nc" id="L1490">        return editorSpecial;</span>
      }
    }

    /**
     * @see org.gui4j.core.swing.Gui4jTableListener#getCellRenderer(TableCellRenderer, int, int)
     */
    public TableCellRenderer getCellRenderer(TableCellRenderer renderer, int row, int column) {
<span class="nc bnc" id="L1498" title="All 2 branches missed.">      if (!mColumnManager.containsSeveralTypes() /*</span>
                                                         * ||
                                                         * mDefaultType.isAssignableFrom(rowClass)
                                                         */) {
<span class="nc" id="L1502">        return renderer;</span>
      } else {
<span class="nc" id="L1504">        Object rowElement = getRowInstance(row);</span>
<span class="nc bnc" id="L1505" title="All 2 branches missed.">        if (rowElement == null) {</span>
<span class="nc" id="L1506">          mLogger.warn(&quot;Table: &quot; + getId() + &quot; has null instance in rows at index &quot; + row);</span>
<span class="nc" id="L1507">          return renderer;</span>
        }
<span class="nc" id="L1509">        Class rowClass = rowElement.getClass();</span>
<span class="nc" id="L1510">        TableCellRenderer rendererSpecial = (TableCellRenderer) mCellRenderers.get(rowClass);</span>
<span class="nc bnc" id="L1511" title="All 2 branches missed.">        if (rendererSpecial == null) {</span>
<span class="nc" id="L1512">          rendererSpecial =</span>
<span class="nc" id="L1513">              new CellRenderer(mGui4jComponentInstance, mColumnManager.getColumns(rowClass), this);</span>
<span class="nc" id="L1514">          mCellRenderers.put(rowClass, rendererSpecial);</span>
        }
<span class="nc" id="L1516">        return rendererSpecial;</span>
      }
    }

    /*
     * @see de.bea.gui4j.swingcomponents.RowHeaderTableModel#getRowName(int)
     */
    public String getRowName(int row) {
<span class="nc" id="L1524">      Object o = mRows.get(row);</span>
<span class="nc" id="L1525">      Gui4jCall rowHeaderName = (Gui4jCall) mRowManager.get(o.getClass());</span>
<span class="nc bnc" id="L1526" title="All 2 branches missed.">      if (rowHeaderName == null) {</span>
<span class="nc" id="L1527">        return &quot;null&quot;;</span>
      }
<span class="nc" id="L1529">      Map m = new HashMap();</span>
<span class="nc" id="L1530">      m.put(Const.PARAM_ITEM, o);</span>
<span class="nc" id="L1531">      return (String) rowHeaderName.getValue(mGui4jController, m, &quot;&quot;);</span>
    }

    /*
     * @see de.bea.gui4j.swingcomponents.RowHeaderAbstractTableModel#setRowName(int,
     *      java.lang.String)
     */
    public void setRowName(int rowNumber, String newName) {
      // nothing todo

<span class="nc" id="L1541">    }</span>

    /*
     * @see de.bea.gui4j.swingcomponents.RowHeaderTableModel#setRowName(int,
     *      java.lang.Object)
     */
    public void setRowName(int rowNumber, Object newName) {
      // nothing todo

<span class="nc" id="L1550">    }</span>

    protected void refreshRows(boolean refresh) {
      // mLogger.debug(&quot;Refreshing rows of table &quot; + getId() + &quot; count = &quot;
      // + mRows.size());
<span class="nc" id="L1555">      Font font = mTable.getFont();</span>
<span class="nc bnc" id="L1556" title="All 2 branches missed.">      if (mUseRowHeaders) {</span>
<span class="nc" id="L1557">        JLabel label = new JLabel();</span>
<span class="nc" id="L1558">        label.setFont(font);</span>
<span class="nc" id="L1559">        int preferredWidth = 10;</span>
<span class="nc bnc" id="L1560" title="All 2 branches missed.">        for (int i = 0; i &lt; mRows.size(); i++) {</span>
<span class="nc" id="L1561">          label.setText(getRowName(i));</span>
<span class="nc" id="L1562">          int width = label.getPreferredSize().width + 8;</span>
<span class="nc bnc" id="L1563" title="All 2 branches missed.">          if (width &gt; preferredWidth) {</span>
<span class="nc" id="L1564">            preferredWidth = width;</span>
          }
        }
<span class="nc" id="L1567">        RowHeaderTable ctable = (RowHeaderTable) mTable;</span>
<span class="nc bnc" id="L1568" title="All 2 branches missed.">        if (ctable != null) {</span>

<span class="nc bnc" id="L1570" title="All 2 branches missed.">          if (mRowHeaderCharacters != null) {</span>
<span class="nc" id="L1571">            int rowHeaderWidth =</span>
<span class="nc" id="L1572">                ((Integer) mRowHeaderCharacters.getValueNoParams(mGui4jController, null))</span>
<span class="nc" id="L1573">                    .intValue();</span>
<span class="nc" id="L1574">            preferredWidth =</span>
<span class="nc" id="L1575">                ctable.getFontMetrics(font).stringWidth(StringUtil.copy('M', rowHeaderWidth));</span>
          }

<span class="nc" id="L1578">          ctable.setRowHeaderWidth(preferredWidth);</span>
<span class="nc" id="L1579">          ctable.setRowHeaderFont(font);</span>
<span class="nc" id="L1580">          ctable.setRowHeaderHeight(mTable.getRowHeight());</span>
<span class="nc" id="L1581">          ctable.refreshRowHeaders();</span>
        }
      }

<span class="nc bnc" id="L1585" title="All 2 branches missed.">      if (refresh) {</span>
<span class="nc" id="L1586">        fireTableDataChanged();</span>
      }
<span class="nc" id="L1588">    }</span>
  }

  // *************************************************************************************

<span class="nc" id="L1593">  public class Gui4jColumnHeaderTable implements Serializable {</span>
    private Gui4jCall mName;
    private List mColumns;

<span class="nc" id="L1597">    public Gui4jColumnHeaderTable(Gui4jCall name) {</span>
<span class="nc" id="L1598">      mName = name;</span>
<span class="nc" id="L1599">      mColumns = new ArrayList();</span>
<span class="nc" id="L1600">    }</span>

    public void addColumn(Object o) {
<span class="nc bnc" id="L1603" title="All 4 branches missed.">      assert o instanceof Gui4jColumnHeaderTable || o instanceof Gui4jColumnTable;</span>
<span class="nc" id="L1604">      mColumns.add(o);</span>
<span class="nc" id="L1605">    }</span>

    public List getColumns() {
<span class="nc" id="L1608">      return mColumns;</span>
    }

    public String getName(Gui4jCallBase gui4jController) {
<span class="nc" id="L1612">      return (String) mName.getValueNoParams(gui4jController, &quot;&quot;);</span>
    }
  }

  // *************************************************************************************
  // ROW
  // *************************************************************************************
  public final class Gui4jRow implements Serializable {
    private final Gui4jCall mRowName;
    private final Gui4jTextAttribute mGui4jTextAttribute;

    // private final Class mClassType;

<span class="nc" id="L1625">    public Gui4jRow(Class classType, Gui4jCall rowName, Gui4jTextAttribute gui4jTextAttribute) {</span>
<span class="nc" id="L1626">      mRowName = rowName;</span>
<span class="nc" id="L1627">      mGui4jTextAttribute = gui4jTextAttribute;</span>
      // mClassType = classType;
<span class="nc" id="L1629">    }</span>

    public Gui4jRow copy(Class newClassType) {
<span class="nc" id="L1632">      return new Gui4jRow(newClassType, mRowName, mGui4jTextAttribute);</span>
    }

    public Gui4jTextAttribute getGui4jTextAttribute() {
<span class="nc" id="L1636">      return mGui4jTextAttribute;</span>
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>