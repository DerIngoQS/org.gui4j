<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MultiLineTable.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">gui4j</a> &gt; <a href="index.source.html" class="el_package">org.gui4j.core.swing</a> &gt; <span class="el_source">MultiLineTable.java</span></div><h1>MultiLineTable.java</h1><pre class="source lang-java linenums">package org.gui4j.core.swing;

/**
 * MultiLineTable.java
 *
 * &lt;p&gt;Created: Tue May 18 13:15:59 1999
 *
 * @author Thomas Wernitz, Da Vinci Communications Ltd &lt;thomas_wernitz@clear.net.nz&gt;
 *     &lt;p&gt;credit to Zafir Anjum for JTableEx and thanks to SUN for their source code ;)
 */
import java.awt.Dimension;
import java.awt.FontMetrics;
import java.awt.Point;
import java.awt.Rectangle;
import java.awt.event.ComponentAdapter;
import java.awt.event.ComponentEvent;
import java.util.Enumeration;
import java.util.Vector;
import javax.swing.JTable;
import javax.swing.ListSelectionModel;
import javax.swing.event.ListSelectionEvent;
import javax.swing.table.DefaultTableModel;
import javax.swing.table.TableCellRenderer;
import javax.swing.table.TableColumn;
import javax.swing.table.TableColumnModel;
import javax.swing.table.TableModel;
import javax.swing.text.Segment;
import javax.swing.text.TabExpander;

public class MultiLineTable extends JTable {

  public MultiLineTable() {
<span class="nc" id="L33">    this(null, null, null);</span>
<span class="nc" id="L34">  }</span>

  public MultiLineTable(TableModel dm) {
<span class="nc" id="L37">    this(dm, null, null);</span>
<span class="nc" id="L38">  }</span>

  public MultiLineTable(TableModel dm, TableColumnModel cm) {
<span class="nc" id="L41">    this(dm, cm, null);</span>
<span class="nc" id="L42">  }</span>

  public MultiLineTable(TableModel dm, TableColumnModel cm, ListSelectionModel sm) {
<span class="nc" id="L45">    super(dm, cm, sm);</span>
<span class="nc" id="L46">    setUI(new MultiLineBasicTableUI());</span>
    // I know this sucks tremendously, but I was too lazy to find a proper solution. :(
    // The problem is, that without this hack, a resize that changes the number of lines in
    // the TextArea does not result in the proper resizing of the table, because the
    // new width of the column is not available through getWidth until resize is complete.
    // Does this make sense? 8-/  Have a look into getRowHeight(int)!
<span class="nc" id="L52">    addComponentListener(</span>
<span class="nc" id="L53">        new ComponentAdapter() {</span>
          public void componentResized(ComponentEvent e) {
<span class="nc" id="L55">            revalidate();</span>
<span class="nc" id="L56">          }</span>
        });
<span class="nc" id="L58">  }</span>

  public MultiLineTable(int numRows, int numColumns) {
<span class="nc" id="L61">    this(new DefaultTableModel(numRows, numColumns));</span>
<span class="nc" id="L62">  }</span>

  public MultiLineTable(final Vector rowData, final Vector columnNames) {
<span class="nc" id="L65">    super(rowData, columnNames);</span>
<span class="nc" id="L66">    setUI(new MultiLineBasicTableUI());</span>
<span class="nc" id="L67">    addComponentListener(</span>
<span class="nc" id="L68">        new ComponentAdapter() {</span>
          public void componentResized(ComponentEvent e) {
<span class="nc" id="L70">            revalidate();</span>
<span class="nc" id="L71">          }</span>
        });
<span class="nc" id="L73">  }</span>

  public MultiLineTable(final Object[][] rowData, final Object[] columnNames) {
<span class="nc" id="L76">    super(rowData, columnNames);</span>
<span class="nc" id="L77">    setUI(new MultiLineBasicTableUI());</span>
<span class="nc" id="L78">    addComponentListener(</span>
<span class="nc" id="L79">        new ComponentAdapter() {</span>
          public void componentResized(ComponentEvent e) {
<span class="nc" id="L81">            revalidate();</span>
<span class="nc" id="L82">          }</span>
        });
<span class="nc" id="L84">  }</span>

  public int rowAtPoint(Point point) {
<span class="nc" id="L87">    int y = point.y;</span>
<span class="nc" id="L88">    int rowSpacing = getIntercellSpacing().height;</span>
<span class="nc" id="L89">    int rowCount = getRowCount();</span>
<span class="nc" id="L90">    int lRowHeight = 0;</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">    for (int row = 0; row &lt; rowCount; row++) {</span>
<span class="nc" id="L92">      lRowHeight += getRowHeight(row) + rowSpacing;</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">      if (y &lt; lRowHeight) {</span>
<span class="nc" id="L94">        return row;</span>
      }
    }
<span class="nc" id="L97">    return -1;</span>
  }

  public int getHeight(String text, int width) {
<span class="nc" id="L101">    FontMetrics fm = getFontMetrics(getFont());</span>
<span class="nc" id="L102">    int numLines = 1;</span>
<span class="nc" id="L103">    Segment s = new Segment(text.toCharArray(), 0, 0);</span>
<span class="nc" id="L104">    s.count = s.array.length;</span>
<span class="nc" id="L105">    TabExpander te = new MyTabExpander(fm);</span>
<span class="nc" id="L106">    int breaks = getBreakLocation(s, fm, 0, width, te, 0);</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">    while ((breaks + s.offset) &lt; s.array.length) {</span>
<span class="nc" id="L108">      s.offset += breaks;</span>
<span class="nc" id="L109">      s.count = s.array.length - s.offset;</span>
<span class="nc" id="L110">      numLines++;</span>
<span class="nc" id="L111">      breaks = getBreakLocation(s, fm, 0, width, te, 0);</span>
    }
<span class="nc" id="L113">    return numLines * fm.getHeight();</span>
  }

  public int getTabbedTextOffset(
      Segment s,
      FontMetrics metrics,
      int x0,
      int x,
      TabExpander e,
      int startOffset,
      boolean round) {
<span class="nc" id="L124">    int currX = x0;</span>
<span class="nc" id="L125">    int nextX = currX;</span>
<span class="nc" id="L126">    char[] txt = s.array;</span>
<span class="nc" id="L127">    int n = s.offset + s.count;</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">    for (int i = s.offset; i &lt; n; i++) {</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">      if (txt[i] == '\t') {</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">        if (e != null) {</span>
<span class="nc" id="L131">          nextX = (int) e.nextTabStop(nextX, startOffset + i - s.offset);</span>
        } else {
<span class="nc" id="L133">          nextX += metrics.charWidth(' ');</span>
        }
<span class="nc bnc" id="L135" title="All 2 branches missed.">      } else if (txt[i] == '\n') {</span>
<span class="nc" id="L136">        return i - s.offset;</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">      } else if (txt[i] == '\r') {</span>
<span class="nc" id="L138">        return i + 1 - s.offset; // kill the newline as well</span>
      } else {
<span class="nc" id="L140">        nextX += metrics.charWidth(txt[i]);</span>
      }
<span class="nc bnc" id="L142" title="All 4 branches missed.">      if ((x &gt;= currX) &amp;&amp; (x &lt; nextX)) {</span>
        // found the hit position... return the appropriate side
<span class="nc bnc" id="L144" title="All 4 branches missed.">        if ((round == false) || ((x - currX) &lt; (nextX - x))) {</span>
<span class="nc" id="L145">          return i - s.offset;</span>
        } else {
<span class="nc" id="L147">          return i + 1 - s.offset;</span>
        }
      }
<span class="nc" id="L150">      currX = nextX;</span>
    }

<span class="nc" id="L153">    return s.count;</span>
  }

  public int getBreakLocation(
      Segment s, FontMetrics metrics, int x0, int x, TabExpander e, int startOffset) {

<span class="nc" id="L159">    int index = getTabbedTextOffset(s, metrics, x0, x, e, startOffset, false);</span>

<span class="nc bnc" id="L161" title="All 2 branches missed.">    if ((s.offset + index) &lt; s.array.length) {</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">      for (int i = s.offset + Math.min(index, s.count - 1); i &gt;= s.offset; i--) {</span>

<span class="nc" id="L164">        char ch = s.array[i];</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">        if (Character.isWhitespace(ch)) {</span>
          // found whitespace, break here
<span class="nc" id="L167">          index = i - s.offset + 1;</span>
<span class="nc" id="L168">          break;</span>
        }
      }
    }
<span class="nc" id="L172">    return index;</span>
  }

  class MyTabExpander implements TabExpander {
    int tabSize;

<span class="nc" id="L178">    public MyTabExpander(FontMetrics metrics) {</span>
<span class="nc" id="L179">      tabSize = 5 * metrics.charWidth('m');</span>
<span class="nc" id="L180">    }</span>

    public float nextTabStop(float x, int offset) {
<span class="nc" id="L183">      int ntabs = (int) x / tabSize;</span>
<span class="nc" id="L184">      return (ntabs + 1) * tabSize;</span>
    }
  }

  public int getRowHeight() {
<span class="nc" id="L189">    System.err.println(&quot;getRowHeight() not valid in MultiLineTable&quot;);</span>
<span class="nc" id="L190">    Thread.dumpStack();</span>
<span class="nc" id="L191">    return -1;</span>
  }

  public int getRowHeight(int row) {
<span class="nc" id="L195">    TableModel tm = getModel();</span>
<span class="nc" id="L196">    int fontHeight = getFontMetrics(getFont()).getHeight();</span>
<span class="nc" id="L197">    int height = fontHeight;</span>
<span class="nc" id="L198">    Enumeration cols = getColumnModel().getColumns();</span>
<span class="nc" id="L199">    int i = 0;</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">    while (cols.hasMoreElements()) {</span>
<span class="nc" id="L201">      TableColumn col = (TableColumn) cols.nextElement();</span>
<span class="nc" id="L202">      TableCellRenderer tcr = col.getCellRenderer();</span>
      // without the revalidate hack above, the call th getWidth does not give the
      // right value at the right time. Take out the revalidate and uncomment the
      // next line to see for your self. If you find a way to do it right, drop me
      // a mail please! :)
      // System.out.println(col.getWidth());
<span class="nc" id="L208">      int colWidth = col.getWidth();</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">      if (tcr instanceof MultiLineCellRenderer) {</span>
<span class="nc" id="L210">        height = Math.max(height, getHeight((String) tm.getValueAt(row, i), colWidth));</span>
      }
<span class="nc" id="L212">      i++;</span>
<span class="nc" id="L213">    }</span>
<span class="nc" id="L214">    return height;</span>
  }

  public Rectangle getCellRect(int row, int column, boolean includeSpacing) {
    Rectangle cellFrame;
    TableColumn aColumn;

<span class="nc" id="L221">    cellFrame = new Rectangle();</span>
    //        cellFrame.height = getRowHeight() + rowMargin;
    //        cellFrame.y = row * cellFrame.height;
<span class="nc" id="L224">    cellFrame.height = getRowHeight(row) + rowMargin;</span>
<span class="nc" id="L225">    cellFrame.y = 0;</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">    for (int i = 0; i &lt; row; i++) {</span>
<span class="nc" id="L227">      cellFrame.y += getRowHeight(i) + rowMargin;</span>
    }

<span class="nc" id="L230">    int index = 0;</span>
<span class="nc" id="L231">    int columnMargin = getColumnModel().getColumnMargin();</span>
<span class="nc" id="L232">    Enumeration enumeration = getColumnModel().getColumns();</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">    while (enumeration.hasMoreElements()) {</span>
<span class="nc" id="L234">      aColumn = (TableColumn) enumeration.nextElement();</span>
<span class="nc" id="L235">      cellFrame.width = aColumn.getWidth() + columnMargin;</span>

<span class="nc bnc" id="L237" title="All 2 branches missed.">      if (index == column) break;</span>

<span class="nc" id="L239">      cellFrame.x += cellFrame.width;</span>
<span class="nc" id="L240">      index++;</span>
    }

<span class="nc bnc" id="L243" title="All 2 branches missed.">    if (!includeSpacing) {</span>
<span class="nc" id="L244">      Dimension spacing = getIntercellSpacing();</span>
      // This is not the same as grow(), it rounds differently.
<span class="nc" id="L246">      cellFrame.setBounds(</span>
          cellFrame.x + spacing.width / 2,
          cellFrame.y + spacing.height / 2,
          cellFrame.width - spacing.width,
          cellFrame.height - spacing.height);
    }
<span class="nc" id="L252">    return cellFrame;</span>
  }

  public void columnSelectionChanged(ListSelectionEvent e) {
<span class="nc" id="L256">    repaint();</span>
<span class="nc" id="L257">  }</span>

  public void valueChanged(ListSelectionEvent e) {
<span class="nc" id="L260">    int firstIndex = e.getFirstIndex();</span>
<span class="nc" id="L261">    int lastIndex = e.getLastIndex();</span>
<span class="nc bnc" id="L262" title="All 4 branches missed.">    if (firstIndex == -1 &amp;&amp; lastIndex == -1) { // Selection cleared.</span>
<span class="nc" id="L263">      repaint();</span>
    }
<span class="nc" id="L265">    Rectangle dirtyRegion = getCellRect(firstIndex, 0, false);</span>
<span class="nc" id="L266">    int numColumns = getColumnCount();</span>
<span class="nc" id="L267">    int index = firstIndex;</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">    for (int i = 0; i &lt; numColumns; i++) {</span>
<span class="nc" id="L269">      dirtyRegion.add(getCellRect(index, i, false));</span>
    }
<span class="nc" id="L271">    index = lastIndex;</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">    for (int i = 0; i &lt; numColumns; i++) {</span>
<span class="nc" id="L273">      dirtyRegion.add(getCellRect(index, i, false));</span>
    }
<span class="nc" id="L275">    repaint(dirtyRegion.x, dirtyRegion.y, dirtyRegion.width, dirtyRegion.height);</span>
<span class="nc" id="L276">  }</span>
} // MultiLineTable
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>